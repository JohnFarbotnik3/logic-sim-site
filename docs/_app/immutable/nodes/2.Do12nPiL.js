var vi=Object.defineProperty;var gi=(l,t,e)=>t in l?vi(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var R=(l,t,e)=>gi(l,typeof t!="symbol"?t+"":t,e);import{b as vr,e as bi,a as U,t as V,d as Tt,c as Be}from"../chunks/disclose-version.xy2xlNg-.js";import{b as Pr,h as wt,s as rs,a8 as wi,e as Ps,P as yi,an as Ar,H as ki,r as gr,f as gs,c as fe,as as ns,g as Rr,a as Ms,p as Ti,T as Ei,M as br,at as Bs,au as wr,av as Us,aw as xi,ac as Si,ax as Ii,d as Lr,ay as Nr,a9 as Dr,ak as Ci,ae as Pi,az as Ai,a6 as Ri,I as yr,aA as Li,ai as $r,al as Ni,aj as Di,aB as $i,aC as Oi,O as Mi,aD as Bi,aE as Ui,j as Fi,R as Hi,x as it,u as be,A as mt,z as ot,n as we,B as z,C as Y,q as $,K as Z,ar as nt,v as ve,D as X,y as kt,aF as Et,a5 as Wi}from"../chunks/runtime.Ec6j9ccR.js";import{a as Gi,i as Vi,c as ji,d as Ki,b as zi,n as Yi,e as Xi,l as qi,r as Qi,s as Fs}from"../chunks/render.BdM5TC2M.js";import{s as le}from"../chunks/snippet.CgDhepUT.js";import{r as Xt,b as Ie,a as pt,s as xt}from"../chunks/props.C_OZB70W.js";import{i as Ke}from"../chunks/legacy.DVzOJGYT.js";import{i as Or}from"../chunks/if.B9OObBUH.js";function We(l,t){return t}function Zi(l,t,e,s){for(var r=[],n=t.length,i=0;i<n;i++)xi(t[i].e,r,!0);var c=n>0&&r.length===0&&e!==null;if(c){var h=e.parentNode;Si(h),h.append(e),s.clear(),ne(l,t[0].prev,t[n-1].next)}Ii(r,()=>{for(var d=0;d<n;d++){var f=t[d];c||(s.delete(f.k),ne(l,f.prev,f.next)),Lr(f.e,!c)}})}function Ge(l,t,e,s,r,n=null){var i=l,c={flags:t,items:new Map,first:null},h=(t&Nr)!==0;if(h){var d=l;i=wt?rs(Dr(d)):d.appendChild(wi())}wt&&Ps();var f=null,p=!1;Pr(()=>{var b=e(),_=yi(b)?b:b==null?[]:Ar(b),v=_.length;if(p&&v===0)return;p=v===0;let g=!1;if(wt){var w=i.data===ki;w!==(v===0)&&(i=gr(),rs(i),gs(!1),g=!0)}if(wt){for(var k=null,C,L=0;L<v;L++){if(fe.nodeType===8&&fe.data===Ci){i=fe,g=!0,gs(!1);break}var I=_[L],T=s(I,L);C=Mr(fe,c,k,null,I,T,L,r,t),c.items.set(T,C),k=C}v>0&&rs(gr())}if(!wt){var N=Pi;Ji(_,c,i,r,t,(N.f&ns)!==0,s)}n!==null&&(v===0?f?Rr(f):f=Ms(()=>n(i)):f!==null&&Ti(f,()=>{f=null})),g&&gs(!0),e()}),wt&&(i=fe)}function Ji(l,t,e,s,r,n,i,c){var It,$t,at,st;var h=(r&Ai)!==0,d=(r&(Bs|Us))!==0,f=l.length,p=t.items,b=t.first,_=b,v,g=null,w,k=[],C=[],L,I,T,N;if(h)for(N=0;N<f;N+=1)L=l[N],I=i(L,N),T=p.get(I),T!==void 0&&((It=T.a)==null||It.measure(),(w??(w=new Set)).add(T));for(N=0;N<f;N+=1){if(L=l[N],I=i(L,N),T=p.get(I),T===void 0){var O=_?_.e.nodes_start:e;g=Mr(O,t,g,g===null?t.first:g.next,L,I,N,s,r),p.set(I,g),k=[],C=[],_=g.next;continue}if(d&&to(T,L,N,r),T.e.f&ns&&(Rr(T.e),h&&(($t=T.a)==null||$t.unfix(),(w??(w=new Set)).delete(T))),T!==_){if(v!==void 0&&v.has(T)){if(k.length<C.length){var et=C[0],F;g=et.prev;var ut=k[0],K=k[k.length-1];for(F=0;F<k.length;F+=1)kr(k[F],et,e);for(F=0;F<C.length;F+=1)v.delete(C[F]);ne(t,ut.prev,K.next),ne(t,g,ut),ne(t,K,et),_=et,g=K,N-=1,k=[],C=[]}else v.delete(T),kr(T,_,e),ne(t,T.prev,T.next),ne(t,T,g===null?t.first:g.next),ne(t,g,T),g=T;continue}for(k=[],C=[];_!==null&&_.k!==I;)(n||!(_.e.f&ns))&&(v??(v=new Set)).add(_),C.push(_),_=_.next;if(_===null)continue;T=_}k.push(T),g=T,_=T.next}if(_!==null||v!==void 0){for(var J=v===void 0?[]:Ar(v);_!==null;)(n||!(_.e.f&ns))&&J.push(_),_=_.next;var vt=J.length;if(vt>0){var At=r&Nr&&f===0?e:null;if(h){for(N=0;N<vt;N+=1)(at=J[N].a)==null||at.measure();for(N=0;N<vt;N+=1)(st=J[N].a)==null||st.fix()}Zi(t,J,At,p)}}h&&Ei(()=>{var lt;if(w!==void 0)for(T of w)(lt=T.a)==null||lt.apply()}),br.first=t.first&&t.first.e,br.last=g&&g.e}function to(l,t,e,s){s&Bs&&wr(l.v,t),s&Us?wr(l.i,e):l.i=e}function Mr(l,t,e,s,r,n,i,c,h,d){var f=(h&Bs)!==0,p=(h&Li)===0,b=f?p?Ri(r):yr(r):r,_=h&Us?yr(i):i,v={i:_,v:b,k:n,a:null,e:null,prev:e,next:s};try{return v.e=Ms(()=>c(l,b,_),wt),v.e.prev=e&&e.e,v.e.next=s&&s.e,e===null?t.first=v:(e.next=v,e.e.next=v.e),s!==null&&(s.prev=v,s.e.prev=v.e),v}finally{}}function kr(l,t,e){for(var s=l.next?l.next.e.nodes_start:e,r=t?t.e.nodes_start:e,n=l.e.nodes_start;n!==s;){var i=$r(n);r.before(n),n=i}}function ne(l,t,e){t===null?l.first=e:(t.next=e,t.e.next=e&&e.e),e!==null&&(e.prev=t,e.e.prev=t&&t.e)}function Br(l,t,e,s,r){var n=l,i="",c;Pr(()=>{if(i===(i=t()??"")){wt&&Ps();return}c!==void 0&&(Lr(c),c=void 0),i!==""&&(c=Ms(()=>{if(wt){fe.data;for(var h=Ps(),d=h;h!==null&&(h.nodeType!==8||h.data!=="");)d=h,h=$r(h);if(h===null)throw Ni(),Di;vr(fe,d),n=rs(h);return}var f=i+"",p=bi(f);vr(Dr(p),p.lastChild),n.before(p)}))})}function Ur(l){var t,e,s="";if(typeof l=="string"||typeof l=="number")s+=l;else if(typeof l=="object")if(Array.isArray(l)){var r=l.length;for(t=0;t<r;t++)l[t]&&(e=Ur(l[t]))&&(s&&(s+=" "),s+=e)}else for(e in l)l[e]&&(s&&(s+=" "),s+=e);return s}function eo(){for(var l,t,e=0,s="",r=arguments.length;e<r;e++)(l=arguments[e])&&(t=Ur(l))&&(s&&(s+=" "),s+=t);return s}function Fr(l){return typeof l=="object"?eo(l):l??""}function so(l){if(wt){var t=!1,e=()=>{if(!t){if(t=!0,l.hasAttribute("value")){var s=l.value;Yt(l,"value",null),l.value=s}if(l.hasAttribute("checked")){var r=l.checked;Yt(l,"checked",null),l.checked=r}}};l.__on_r=e,$i(e),Gi()}}function ro(l,t){t?l.hasAttribute("selected")||l.setAttribute("selected",""):l.removeAttribute("selected")}function Yt(l,t,e,s){var r=l.__attributes??(l.__attributes={});wt&&(r[t]=l.getAttribute(t),t==="src"||t==="srcset"||t==="href"&&l.nodeName==="LINK")||r[t]!==(r[t]=e)&&(t==="style"&&"__styles"in l&&(l.__styles={}),t==="loading"&&(l[Oi]=e),e==null?l.removeAttribute(t):typeof e!="string"&&Hr(l).includes(t)?l[t]=e:l.setAttribute(t,e))}function qt(l,t,e,s,r=!1,n=!1,i=!1){var c=t||{},h=l.tagName==="OPTION";for(var d in t)d in e||(e[d]=null);e.class&&(e.class=Fr(e.class)),s!==void 0&&(e.class=e.class?e.class+" "+s:s);var f=Hr(l),p=l.__attributes??(l.__attributes={});for(const k in e){let C=e[k];if(h&&k==="value"&&C==null){l.value=l.__value="",c[k]=C;continue}var b=c[k];if(C!==b){c[k]=C;var _=k[0]+k[1];if(_!=="$$"){if(_==="on"){const L={},I="$$"+k;let T=k.slice(2);var v=Xi(T);if(Vi(T)&&(T=T.slice(0,-7),L.capture=!0),!v&&b){if(C!=null)continue;l.removeEventListener(T,c[I],L),c[I]=null}if(C!=null)if(v)l[`__${T}`]=C,Ki([T]);else{let N=function(O){c[k].call(this,O)};c[I]=ji(T,l,N,L)}else v&&(l[`__${T}`]=void 0)}else if(k==="style"&&C!=null)l.style.cssText=C+"";else if(k==="autofocus")zi(l,!!C);else if(k==="__value"||k==="value"&&C!=null)l.value=l[k]=l.__value=C;else if(k==="selected"&&h)ro(l,C);else{var g=k;r||(g=Yi(g));var w=g==="defaultValue"||g==="defaultChecked";if(C==null&&!n&&!w)if(p[k]=null,g==="value"||g==="checked"){let L=l;if(g==="value"){let I=L.defaultValue;L.removeAttribute(g),L.defaultValue=I}else{let I=L.defaultChecked;L.removeAttribute(g),L.defaultChecked=I}}else l.removeAttribute(k);else w||f.includes(g)&&(n||typeof C!="string")?l[g]=C:typeof C!="function"&&(wt&&(g==="src"||g==="href"||g==="srcset")||Yt(l,g,C))}k==="style"&&"__styles"in l&&(l.__styles={})}}}return c}var Tr=new Map;function Hr(l){var t=Tr.get(l.nodeName);if(t)return t;Tr.set(l.nodeName,t=[]);for(var e,s=l,r=Element.prototype;r!==s;){e=Bi(s);for(var n in e)e[n].set&&t.push(n);s=Mi(s)}return t}function Wr(l,t,e){var s=l.__className,r=no(t,e);wt&&l.className===r?l.__className=r:(s!==r||wt&&l.className!==r)&&(t==null&&!e?l.removeAttribute("class"):l.className=r,l.__className=r)}function no(l,t){return(l??"")+(t?" "+t:"")}function Gr(l,t,e=t){var s=Ui();qi(l,"input",r=>{var n=r?l.defaultValue:l.value;if(n=bs(l)?ws(n):n,e(n),s&&n!==(n=t())){var i=l.selectionStart,c=l.selectionEnd;l.value=n??"",c!==null&&(l.selectionStart=i,l.selectionEnd=Math.min(c,l.value.length))}}),(wt&&l.defaultValue!==l.value||Fi(t)==null&&l.value)&&e(bs(l)?ws(l.value):l.value),Hi(()=>{var r=t();bs(l)&&r===ws(l.value)||l.type==="date"&&!r&&!l.value||r!==l.value&&(l.value=r??"")})}function bs(l){var t=l.type;return t==="number"||t==="range"}function ws(l){return l===""?null:+l}const io=[{templateId:1731786847186,width:12,height:12,placeW:4,placeH:4,name:"Test Block",desc:`A block with various cells and sub-blocks.

(for testing purposes)`,cells:[{dim:[8,1.5,1,1,0],id:1731787677167,type:120,value:0},{dim:[9.5,.5,1,1,0],id:1731787677168,type:15933,value:0},{dim:[9.5,2.5,1,1,0],id:1731787677169,type:15421,value:0},{dim:[.5,11.5,1,1,0],id:1731787677176,type:1129206612,value:74565},{dim:[2.5,11.5,1,1,0],id:1731787677177,type:1129271385,value:0},{dim:[4.5,11.5,1,1,0],id:1731787677178,type:20306,value:0},{dim:[6.5,11.5,1,1,0],id:1731787677179,type:5787474,value:0},{dim:[8.5,11.5,1,1,0],id:1731787677180,type:5132116,value:0},{dim:[10.5,11.5,1,1,0],id:1731787677181,type:4279876,value:0},{dim:[4.5,7.5,1,1,0],id:1731789026881,type:15677,value:0},{dim:[.5,9.5,1,1,0],id:1731787677183,type:5002056,value:0},{dim:[2.5,9.5,1,1,0],id:1731787677184,type:5395272,value:0},{dim:[4.5,9.5,1,1,0],id:1731787677185,type:43,value:0},{dim:[6.5,9.5,1,1,0],id:1731787677186,type:45,value:0},{dim:[8.5,9.5,1,1,0],id:1731787677187,type:120,value:0},{dim:[10.5,9.5,1,1,0],id:1731787677188,type:247,value:0},{dim:[.5,7.5,1,1,0],id:1731787677189,type:62,value:0},{dim:[2.5,7.5,1,1,0],id:1731787677190,type:60,value:0},{dim:[6.5,7.5,1,1,0],id:1731787677191,type:15933,value:0},{dim:[8.5,7.5,1,1,0],id:1731787677192,type:15421,value:0},{dim:[.5,2.5,1,1,0],id:1736011115513,type:1129206612,value:7},{dim:[.5,.5,1,1,0],id:1736011115514,type:1129206612,value:2},{dim:[11.5,1.5,1,1,0],id:1736012693229,type:1129271385,value:0}],links:[{id:1734119501955,src_addr:[1,1731787677176],dst_addr:[1,1731787677177,1],clr:4294967295},{id:1732933058482,src_addr:[1,1731787677192],dst_addr:[1,1731787677188,2],clr:4294967295},{id:1736011115516,src_addr:[1,1736011115513],dst_addr:[1731786847240,1731786847218,1],clr:-14081},{id:1736012693224,src_addr:[1731786847240,1731786847223],dst_addr:[1,1731787677167,2],clr:-14081},{id:1736012693225,src_addr:[1736011258536,1736011258530],dst_addr:[1,1731787677167,1],clr:-14081},{id:1736012693226,src_addr:[1,1731787677167],dst_addr:[1,1731787677168,1],clr:-14081},{id:1732933058479,src_addr:[1731786847240,1731786847223],dst_addr:[1,1731787677169,1],clr:4294967295},{id:1732933058480,src_addr:[1,1731787677167],dst_addr:[1,1731787677169,2],clr:4294967295},{id:1732933058481,src_addr:[1,1731787677192],dst_addr:[1,1731787677188,1],clr:4294967295},{id:1736011115515,src_addr:[1,1736011115514],dst_addr:[1731786847240,1731786847219,1],clr:-14081},{id:1736012693227,src_addr:[1731786847240,1731786847223],dst_addr:[1,1731787677168,2],clr:-14081},{id:1736012693230,src_addr:[1,1731787677167],dst_addr:[1,1736012693229,1],clr:-14081}],texts:[],blocks:[{dim:[4,1.5,4,3,0],id:1731786847240,templateId:1731786847210},{dim:[6,4.5,"2","1",0],id:1736011258536,templateId:1736011258525}]},{templateId:1731786847210,width:9,height:6,placeW:3,placeH:2,name:"XOR Gate",desc:"An implementation of an XOR gate using simpler gates",cells:[{dim:[3.5,5,1,1,0],id:1731786847221,type:4279876,value:0},{dim:[1,5,2,2,0],id:1731786847218,type:1129271385,value:0},{dim:[1,1,2,2,0],id:1731786847219,type:1129271385,value:0},{dim:[3.5,1,1,1,0],id:1731786847220,type:20306,value:0},{dim:[5.5,4.5,1,1,-.08333333333333333],id:1731786847222,type:5132116,value:0},{dim:[8,3,2,2,0],id:1731786847223,type:4279876,value:0},{dim:[5.5,1.5,1,1,.08333333333333333],id:1735948428212,type:1129271385,value:0}],links:[{id:1732933058488,src_addr:[1,1731786847218],dst_addr:[1,1731786847220,1],clr:4294967295},{id:1732933058489,src_addr:[1,1731786847219],dst_addr:[1,1731786847220,2],clr:4294967295},{id:1732933058490,src_addr:[1,1731786847219],dst_addr:[1,1731786847221,2],clr:4294967295},{id:1732933058491,src_addr:[1,1731786847218],dst_addr:[1,1731786847221,1],clr:4294967295},{id:1732933058492,src_addr:[1,1731786847221],dst_addr:[1,1731786847222,1],clr:4294967295},{id:1732933058493,src_addr:[1,1731786847222],dst_addr:[1,1731786847223,1],clr:4294967295},{id:1735948428213,src_addr:[1,1731786847220],dst_addr:[1,1735948428212,1],clr:-14081},{id:1735948428214,src_addr:[1,1735948428212],dst_addr:[1,1731786847223,2],clr:-14081}],texts:[],blocks:[]},{templateId:1736011258525,width:4,height:2,placeW:2,placeH:1,name:"Frame Counter",desc:"This block has a cell which increments by 1 each simulation step.",cells:[{dim:[.5,1,1,1,0],id:1736011258528,type:1129206612,value:1},{dim:[3,1,2,2,0],id:1736011258530,type:43,value:0}],links:[{id:1736011258532,src_addr:[1,1736011258528],dst_addr:[1,1736011258530,1],clr:-14081},{id:1736011258533,src_addr:[1,1736011258530],dst_addr:[1,1736011258530,2],clr:-14081}],texts:[],blocks:[]}];var oo=(()=>{var l=import.meta.url;return function(t={}){var e,s=t,r,n,i=new Promise((a,o)=>{r=a,n=o}),c=Object.assign({},s),h="";function d(a){return s.locateFile?s.locateFile(a,h):h+a}var f;typeof document<"u"&&document.currentScript&&(h=document.currentScript.src),l&&(h=l),h.startsWith("blob:")?h="":h=h.substr(0,h.replace(/[?#].*/,"").lastIndexOf("/")+1),f=a=>fetch(a,{credentials:"same-origin"}).then(o=>o.ok?o.arrayBuffer():Promise.reject(new Error(o.status+" : "+o.url)));var p=s.print||console.log.bind(console),b=s.printErr||console.error.bind(console);Object.assign(s,c),c=null,s.arguments&&s.arguments,s.thisProgram&&s.thisProgram,s.quit&&s.quit;var _;s.wasmBinary&&(_=s.wasmBinary);var v,g=!1,w,k,C,L,I,T,N,O;function et(){var a=v.buffer;s.HEAP8=w=new Int8Array(a),s.HEAP16=C=new Int16Array(a),s.HEAPU8=k=new Uint8Array(a),s.HEAPU16=L=new Uint16Array(a),s.HEAP32=I=new Int32Array(a),s.HEAPU32=T=new Uint32Array(a),s.HEAPF32=N=new Float32Array(a),s.HEAPF64=O=new Float64Array(a)}var F=[],ut=[],K=[];function J(){if(s.preRun)for(typeof s.preRun=="function"&&(s.preRun=[s.preRun]);s.preRun.length;)It(s.preRun.shift());Ae(F)}function vt(){Ae(ut)}function At(){if(s.postRun)for(typeof s.postRun=="function"&&(s.postRun=[s.postRun]);s.postRun.length;)at(s.postRun.shift());Ae(K)}function It(a){F.unshift(a)}function $t(a){ut.unshift(a)}function at(a){K.unshift(a)}var st=0,lt=null;function Ct(a){var o;st++,(o=s.monitorRunDependencies)==null||o.call(s,st)}function Ht(a){var u;if(st--,(u=s.monitorRunDependencies)==null||u.call(s,st),st==0&&lt){var o=lt;lt=null,o()}}function Rt(a){var u;(u=s.onAbort)==null||u.call(s,a),a="Aborted("+a+")",b(a),g=!0,a+=". Build with -sASSERTIONS for more info.";var o=new WebAssembly.RuntimeError(a);throw n(o),o}var Bt="data:application/octet-stream;base64,",Ot=a=>a.startsWith(Bt);function Wt(){if(s.locateFile){var a="em_index.wasm";return Ot(a)?a:d(a)}return new URL(""+new URL("../assets/em_index.BKILPcjZ.wasm",import.meta.url).href,import.meta.url).href}var Lt;function Qt(a){if(a==Lt&&_)return new Uint8Array(_);throw"both async and sync fetching of the wasm failed"}function he(a){return _?Promise.resolve().then(()=>Qt(a)):f(a).then(o=>new Uint8Array(o),()=>Qt(a))}function _t(a,o,u){return he(a).then(m=>WebAssembly.instantiate(m,o)).then(u,m=>{b(`failed to asynchronously prepare wasm: ${m}`),Rt(m)})}function Zt(a,o,u,m){return!a&&typeof WebAssembly.instantiateStreaming=="function"&&!Ot(o)&&typeof fetch=="function"?fetch(o,{credentials:"same-origin"}).then(y=>{var S=WebAssembly.instantiateStreaming(y,u);return S.then(m,function(P){return b(`wasm streaming compile failed: ${P}`),b("falling back to ArrayBuffer instantiation"),_t(o,u,m)})}):_t(o,u,m)}function Pe(){return{env:cr,wasi_snapshot_preview1:cr}}function cs(){var a=Pe();function o(m,y){return Ut=m.exports,v=Ut.memory,et(),Qs=Ut.__indirect_function_table,$t(Ut.__wasm_call_ctors),Ht(),Ut}Ct();function u(m){o(m.instance)}if(s.instantiateWasm)try{return s.instantiateWasm(a,o)}catch(m){b(`Module.instantiateWasm callback failed with error: ${m}`),n(m)}return Lt||(Lt=Wt()),Zt(_,Lt,a,u).catch(n),{}}var Ae=a=>{for(;a.length>0;)a.shift()(s)};s.noExitRuntime;class Gs{constructor(o){this.excPtr=o,this.ptr=o-24}set_type(o){T[this.ptr+4>>2]=o}get_type(){return T[this.ptr+4>>2]}set_destructor(o){T[this.ptr+8>>2]=o}get_destructor(){return T[this.ptr+8>>2]}set_caught(o){o=o?1:0,w[this.ptr+12]=o}get_caught(){return w[this.ptr+12]!=0}set_rethrown(o){o=o?1:0,w[this.ptr+13]=o}get_rethrown(){return w[this.ptr+13]!=0}init(o,u){this.set_adjusted_ptr(0),this.set_type(o),this.set_destructor(u)}set_adjusted_ptr(o){T[this.ptr+16>>2]=o}get_adjusted_ptr(){return T[this.ptr+16>>2]}get_exception_ptr(){var o=dr(this.get_type());if(o)return T[this.excPtr>>2];var u=this.get_adjusted_ptr();return u!==0?u:this.excPtr}}var Re=0,Zr=(a,o,u)=>{var m=new Gs(a);throw m.init(o,u),Re=a,Re},Jr=()=>{Rt("")},tn=(a,o,u,m,y)=>{},en=()=>{for(var a=new Array(256),o=0;o<256;++o)a[o]=String.fromCharCode(o);Vs=a},Vs,Nt=a=>{for(var o="",u=a;k[u];)o+=Vs[k[u++]];return o},ye={},ke={},ze={},Te,W=a=>{throw new Te(a)},js,Ye=a=>{throw new js(a)},de=(a,o,u)=>{a.forEach(function(E){ze[E]=o});function m(E){var A=u(E);A.length!==a.length&&Ye("Mismatched type converter count");for(var D=0;D<a.length;++D)Gt(a[D],A[D])}var y=new Array(o.length),S=[],P=0;o.forEach((E,A)=>{ke.hasOwnProperty(E)?y[A]=ke[E]:(S.push(E),ye.hasOwnProperty(E)||(ye[E]=[]),ye[E].push(()=>{y[A]=ke[E],++P,P===S.length&&m(y)}))}),S.length===0&&m(y)};function sn(a,o,u={}){var m=o.name;if(a||W(`type "${m}" must have a positive integer typeid pointer`),ke.hasOwnProperty(a)){if(u.ignoreDuplicateRegistrations)return;W(`Cannot register type '${m}' twice`)}if(ke[a]=o,delete ze[a],ye.hasOwnProperty(a)){var y=ye[a];delete ye[a],y.forEach(S=>S())}}function Gt(a,o,u={}){if(!("argPackAdvance"in o))throw new TypeError("registerType registeredInstance requires argPackAdvance");return sn(a,o,u)}var Jt=8,rn=(a,o,u,m)=>{o=Nt(o),Gt(a,{name:o,fromWireType:function(y){return!!y},toWireType:function(y,S){return S?u:m},argPackAdvance:Jt,readValueFromPointer:function(y){return this.fromWireType(k[y])},destructorFunction:null})},nn=a=>({count:a.count,deleteScheduled:a.deleteScheduled,preservePointerOnDelete:a.preservePointerOnDelete,ptr:a.ptr,ptrType:a.ptrType,smartPtr:a.smartPtr,smartPtrType:a.smartPtrType}),hs=a=>{function o(u){return u.$$.ptrType.registeredClass.name}W(o(a)+" instance already deleted")},ds=!1,Ks=a=>{},on=a=>{a.smartPtr?a.smartPtrType.rawDestructor(a.smartPtr):a.ptrType.registeredClass.rawDestructor(a.ptr)},zs=a=>{a.count.value-=1;var o=a.count.value===0;o&&on(a)},Ys=(a,o,u)=>{if(o===u)return a;if(u.baseClass===void 0)return null;var m=Ys(a,o,u.baseClass);return m===null?null:u.downcast(m)},Xs={},an=()=>Object.keys(De).length,ln=()=>{var a=[];for(var o in De)De.hasOwnProperty(o)&&a.push(De[o]);return a},Le=[],us=()=>{for(;Le.length;){var a=Le.pop();a.$$.deleteScheduled=!1,a.delete()}},Ne,cn=a=>{Ne=a,Le.length&&Ne&&Ne(us)},hn=()=>{s.getInheritedInstanceCount=an,s.getLiveInheritedInstances=ln,s.flushPendingDeletes=us,s.setDelayFunction=cn},De={},dn=(a,o)=>{for(o===void 0&&W("ptr should not be undefined");a.baseClass;)o=a.upcast(o),a=a.baseClass;return o},un=(a,o)=>(o=dn(a,o),De[o]),Xe=(a,o)=>{(!o.ptrType||!o.ptr)&&Ye("makeClassHandle requires ptr and ptrType");var u=!!o.smartPtrType,m=!!o.smartPtr;return u!==m&&Ye("Both smartPtrType and smartPtr must be specified"),o.count={value:1},$e(Object.create(a,{$$:{value:o,writable:!0}}))};function _n(a){var o=this.getPointee(a);if(!o)return this.destructor(a),null;var u=un(this.registeredClass,o);if(u!==void 0){if(u.$$.count.value===0)return u.$$.ptr=o,u.$$.smartPtr=a,u.clone();var m=u.clone();return this.destructor(a),m}function y(){return this.isSmartPointer?Xe(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:o,smartPtrType:this,smartPtr:a}):Xe(this.registeredClass.instancePrototype,{ptrType:this,ptr:a})}var S=this.registeredClass.getActualType(o),P=Xs[S];if(!P)return y.call(this);var E;this.isConst?E=P.constPointerType:E=P.pointerType;var A=Ys(o,this.registeredClass,E.registeredClass);return A===null?y.call(this):this.isSmartPointer?Xe(E.registeredClass.instancePrototype,{ptrType:E,ptr:A,smartPtrType:this,smartPtr:a}):Xe(E.registeredClass.instancePrototype,{ptrType:E,ptr:A})}var $e=a=>typeof FinalizationRegistry>"u"?($e=o=>o,a):(ds=new FinalizationRegistry(o=>{zs(o.$$)}),$e=o=>{var u=o.$$,m=!!u.smartPtr;if(m){var y={$$:u};ds.register(o,y,o)}return o},Ks=o=>ds.unregister(o),$e(a)),fn=()=>{Object.assign(qe.prototype,{isAliasOf(a){if(!(this instanceof qe)||!(a instanceof qe))return!1;var o=this.$$.ptrType.registeredClass,u=this.$$.ptr;a.$$=a.$$;for(var m=a.$$.ptrType.registeredClass,y=a.$$.ptr;o.baseClass;)u=o.upcast(u),o=o.baseClass;for(;m.baseClass;)y=m.upcast(y),m=m.baseClass;return o===m&&u===y},clone(){if(this.$$.ptr||hs(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var a=$e(Object.create(Object.getPrototypeOf(this),{$$:{value:nn(this.$$)}}));return a.$$.count.value+=1,a.$$.deleteScheduled=!1,a},delete(){this.$$.ptr||hs(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&W("Object already scheduled for deletion"),Ks(this),zs(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)},isDeleted(){return!this.$$.ptr},deleteLater(){return this.$$.ptr||hs(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&W("Object already scheduled for deletion"),Le.push(this),Le.length===1&&Ne&&Ne(us),this.$$.deleteScheduled=!0,this}})};function qe(){}var Qe=(a,o)=>Object.defineProperty(o,"name",{value:a}),qs=(a,o,u)=>{if(a[o].overloadTable===void 0){var m=a[o];a[o]=function(...y){return a[o].overloadTable.hasOwnProperty(y.length)||W(`Function '${u}' called with an invalid number of arguments (${y.length}) - expects one of (${a[o].overloadTable})!`),a[o].overloadTable[y.length].apply(this,y)},a[o].overloadTable=[],a[o].overloadTable[m.argCount]=m}},pn=(a,o,u)=>{s.hasOwnProperty(a)?(W(`Cannot register public name '${a}' twice`),qs(s,a,a),s.hasOwnProperty(u)&&W(`Cannot register multiple overloads of a function with the same number of arguments (${u})!`),s[a].overloadTable[u]=o):s[a]=o},mn=48,vn=57,gn=a=>{if(a===void 0)return"_unknown";a=a.replace(/[^a-zA-Z0-9_]/g,"$");var o=a.charCodeAt(0);return o>=mn&&o<=vn?`_${a}`:a};function bn(a,o,u,m,y,S,P,E){this.name=a,this.constructor=o,this.instancePrototype=u,this.rawDestructor=m,this.baseClass=y,this.getActualType=S,this.upcast=P,this.downcast=E,this.pureVirtualFunctions=[]}var Ze=(a,o,u)=>{for(;o!==u;)o.upcast||W(`Expected null or instance of ${u.name}, got an instance of ${o.name}`),a=o.upcast(a),o=o.baseClass;return a};function wn(a,o){if(o===null)return this.isReference&&W(`null is not a valid ${this.name}`),0;o.$$||W(`Cannot pass "${ps(o)}" as a ${this.name}`),o.$$.ptr||W(`Cannot pass deleted object as a pointer of type ${this.name}`);var u=o.$$.ptrType.registeredClass,m=Ze(o.$$.ptr,u,this.registeredClass);return m}function yn(a,o){var u;if(o===null)return this.isReference&&W(`null is not a valid ${this.name}`),this.isSmartPointer?(u=this.rawConstructor(),a!==null&&a.push(this.rawDestructor,u),u):0;(!o||!o.$$)&&W(`Cannot pass "${ps(o)}" as a ${this.name}`),o.$$.ptr||W(`Cannot pass deleted object as a pointer of type ${this.name}`),!this.isConst&&o.$$.ptrType.isConst&&W(`Cannot convert argument of type ${o.$$.smartPtrType?o.$$.smartPtrType.name:o.$$.ptrType.name} to parameter type ${this.name}`);var m=o.$$.ptrType.registeredClass;if(u=Ze(o.$$.ptr,m,this.registeredClass),this.isSmartPointer)switch(o.$$.smartPtr===void 0&&W("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:o.$$.smartPtrType===this?u=o.$$.smartPtr:W(`Cannot convert argument of type ${o.$$.smartPtrType?o.$$.smartPtrType.name:o.$$.ptrType.name} to parameter type ${this.name}`);break;case 1:u=o.$$.smartPtr;break;case 2:if(o.$$.smartPtrType===this)u=o.$$.smartPtr;else{var y=o.clone();u=this.rawShare(u,fs.toHandle(()=>y.delete())),a!==null&&a.push(this.rawDestructor,u)}break;default:W("Unsupporting sharing policy")}return u}function kn(a,o){if(o===null)return this.isReference&&W(`null is not a valid ${this.name}`),0;o.$$||W(`Cannot pass "${ps(o)}" as a ${this.name}`),o.$$.ptr||W(`Cannot pass deleted object as a pointer of type ${this.name}`),o.$$.ptrType.isConst&&W(`Cannot convert argument of type ${o.$$.ptrType.name} to parameter type ${this.name}`);var u=o.$$.ptrType.registeredClass,m=Ze(o.$$.ptr,u,this.registeredClass);return m}function Je(a){return this.fromWireType(T[a>>2])}var Tn=()=>{Object.assign(ts.prototype,{getPointee(a){return this.rawGetPointee&&(a=this.rawGetPointee(a)),a},destructor(a){var o;(o=this.rawDestructor)==null||o.call(this,a)},argPackAdvance:Jt,readValueFromPointer:Je,fromWireType:_n})};function ts(a,o,u,m,y,S,P,E,A,D,M){this.name=a,this.registeredClass=o,this.isReference=u,this.isConst=m,this.isSmartPointer=y,this.pointeeType=S,this.sharingPolicy=P,this.rawGetPointee=E,this.rawConstructor=A,this.rawShare=D,this.rawDestructor=M,!y&&o.baseClass===void 0?m?(this.toWireType=wn,this.destructorFunction=null):(this.toWireType=kn,this.destructorFunction=null):this.toWireType=yn}var En=(a,o,u)=>{s.hasOwnProperty(a)||Ye("Replacing nonexistent public symbol"),s[a].overloadTable!==void 0&&u!==void 0||(s[a]=o,s[a].argCount=u)},xn=(a,o,u)=>{a=a.replace(/p/g,"i");var m=s["dynCall_"+a];return m(o,...u)},es=[],Qs,Zs=a=>{var o=es[a];return o||(a>=es.length&&(es.length=a+1),es[a]=o=Qs.get(a)),o},Sn=(a,o,u=[])=>{if(a.includes("j"))return xn(a,o,u);var m=Zs(o)(...u);return m},In=(a,o)=>(...u)=>Sn(a,o,u),te=(a,o)=>{a=Nt(a);function u(){return a.includes("j")?In(a,o):Zs(o)}var m=u();return typeof m!="function"&&W(`unknown function pointer with signature ${a}: ${o}`),m},Cn=(a,o)=>{var u=Qe(o,function(m){this.name=o,this.message=m;var y=new Error(m).stack;y!==void 0&&(this.stack=this.toString()+`
`+y.replace(/^Error(:[^\n]*)?\n/,""))});return u.prototype=Object.create(a.prototype),u.prototype.constructor=u,u.prototype.toString=function(){return this.message===void 0?this.name:`${this.name}: ${this.message}`},u},Js,Pn=a=>{var o=hr(a),u=Nt(o);return Vt(o),u},Oe=(a,o)=>{var u=[],m={};function y(S){if(!m[S]&&!ke[S]){if(ze[S]){ze[S].forEach(y);return}u.push(S),m[S]=!0}}throw o.forEach(y),new Js(`${a}: `+u.map(Pn).join([", "]))},An=(a,o,u,m,y,S,P,E,A,D,M,H,q)=>{M=Nt(M),S=te(y,S),E&&(E=te(P,E)),D&&(D=te(A,D)),q=te(H,q);var dt=gn(M);pn(dt,function(){Oe(`Cannot construct ${M} due to unbound types`,[m])}),de([a,o,u],m?[m]:[],gt=>{var pr;gt=gt[0];var se,jt;m?(se=gt.registeredClass,jt=se.instancePrototype):jt=qe.prototype;var re=Qe(M,function(...vs){if(Object.getPrototypeOf(this)!==Me)throw new Te("Use 'new' to construct "+M);if(Pt.constructor_body===void 0)throw new Te(M+" has no accessible constructor");var mr=Pt.constructor_body[vs.length];if(mr===void 0)throw new Te(`Tried to invoke ctor of ${M} with invalid number of parameters (${vs.length}) - expected (${Object.keys(Pt.constructor_body).toString()}) parameters instead!`);return mr.apply(this,vs)}),Me=Object.create(jt,{constructor:{value:re}});re.prototype=Me;var Pt=new bn(M,re,Me,q,se,S,E,D);Pt.baseClass&&((pr=Pt.baseClass).__derivedClasses??(pr.__derivedClasses=[]),Pt.baseClass.__derivedClasses.push(Pt));var mi=new ts(M,Pt,!0,!1,!1),_r=new ts(M+"*",Pt,!1,!1,!1),fr=new ts(M+" const*",Pt,!1,!0,!1);return Xs[a]={pointerType:_r,constPointerType:fr},En(dt,re),[mi,_r,fr]})},tr=(a,o)=>{for(var u=[],m=0;m<a;m++)u.push(T[o+m*4>>2]);return u},er=a=>{for(;a.length;){var o=a.pop(),u=a.pop();u(o)}};function sr(a){for(var o=1;o<a.length;++o)if(a[o]!==null&&a[o].destructorFunction===void 0)return!0;return!1}function Rn(a,o){if(!(a instanceof Function))throw new TypeError(`new_ called with constructor type ${typeof a} which is not a function`);var u=Qe(a.name||"unknownFunctionName",function(){});u.prototype=a.prototype;var m=new u,y=a.apply(m,o);return y instanceof Object?y:m}function Ln(a,o,u,m){for(var y=sr(a),S=a.length,P="",E="",A=0;A<S-2;++A)P+=(A!==0?", ":"")+"arg"+A,E+=(A!==0?", ":"")+"arg"+A+"Wired";var D=`
        return function (${P}) {
        if (arguments.length !== ${S-2}) {
          throwBindingError('function ' + humanName + ' called with ' + arguments.length + ' arguments, expected ${S-2}');
        }`;y&&(D+=`var destructors = [];
`);var M=y?"destructors":"null",H=["humanName","throwBindingError","invoker","fn","runDestructors","retType","classParam"];o&&(D+="var thisWired = classParam['toWireType']("+M+`, this);
`);for(var A=0;A<S-2;++A)D+="var arg"+A+"Wired = argType"+A+"['toWireType']("+M+", arg"+A+`);
`,H.push("argType"+A);if(o&&(E="thisWired"+(E.length>0?", ":"")+E),D+=(u||m?"var rv = ":"")+"invoker(fn"+(E.length>0?", ":"")+E+`);
`,y)D+=`runDestructors(destructors);
`;else for(var A=o?1:2;A<a.length;++A){var q=A===1?"thisWired":"arg"+(A-2)+"Wired";a[A].destructorFunction!==null&&(D+=`${q}_dtor(${q});
`,H.push(`${q}_dtor`))}return u&&(D+=`var ret = retType['fromWireType'](rv);
return ret;
`),D+=`}
`,[H,D]}function rr(a,o,u,m,y,S){var P=o.length;P<2&&W("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var E=o[1]!==null&&u!==null,A=sr(o),D=o[0].name!=="void",M=[a,W,m,y,er,o[0],o[1]],H=0;H<P-2;++H)M.push(o[H+2]);if(!A)for(var H=E?1:2;H<o.length;++H)o[H].destructorFunction!==null&&M.push(o[H].destructorFunction);let[q,dt]=Ln(o,E,D,S);q.push(dt);var gt=Rn(Function,q)(...M);return Qe(a,gt)}var Nn=(a,o,u,m,y,S)=>{var P=tr(o,u);y=te(m,y),de([],[a],E=>{E=E[0];var A=`constructor ${E.name}`;if(E.registeredClass.constructor_body===void 0&&(E.registeredClass.constructor_body=[]),E.registeredClass.constructor_body[o-1]!==void 0)throw new Te(`Cannot register multiple constructors with identical number of parameters (${o-1}) for class '${E.name}'! Overload resolution is currently only performed using the parameter count, not actual type info!`);return E.registeredClass.constructor_body[o-1]=()=>{Oe(`Cannot construct ${E.name} due to unbound types`,P)},de([],P,D=>(D.splice(1,0,null),E.registeredClass.constructor_body[o-1]=rr(A,D,null,y,S),[])),[]})},Dn=a=>{a=a.trim();const o=a.indexOf("(");return o!==-1?a.substr(0,o):a},$n=(a,o,u,m,y,S,P,E,A)=>{var D=tr(u,m);o=Nt(o),o=Dn(o),S=te(y,S),de([],[a],M=>{M=M[0];var H=`${M.name}.${o}`;o.startsWith("@@")&&(o=Symbol[o.substring(2)]),E&&M.registeredClass.pureVirtualFunctions.push(o);function q(){Oe(`Cannot call ${H} due to unbound types`,D)}var dt=M.registeredClass.instancePrototype,gt=dt[o];return gt===void 0||gt.overloadTable===void 0&&gt.className!==M.name&&gt.argCount===u-2?(q.argCount=u-2,q.className=M.name,dt[o]=q):(qs(dt,o,H),dt[o].overloadTable[u-2]=q),de([],D,se=>{var jt=rr(H,se,M,S,P,A);return dt[o].overloadTable===void 0?(jt.argCount=u-2,dt[o]=jt):dt[o].overloadTable[u-2]=jt,[]}),[]})},nr=(a,o,u)=>(a instanceof Object||W(`${u} with invalid "this": ${a}`),a instanceof o.registeredClass.constructor||W(`${u} incompatible with "this" of type ${a.constructor.name}`),a.$$.ptr||W(`cannot call emscripten binding method ${u} on deleted object`),Ze(a.$$.ptr,a.$$.ptrType.registeredClass,o.registeredClass)),On=(a,o,u,m,y,S,P,E,A,D)=>{o=Nt(o),y=te(m,y),de([],[a],M=>{M=M[0];var H=`${M.name}.${o}`,q={get(){Oe(`Cannot access ${H} due to unbound types`,[u,P])},enumerable:!0,configurable:!0};return A?q.set=()=>Oe(`Cannot access ${H} due to unbound types`,[u,P]):q.set=dt=>W(H+" is a read-only property"),Object.defineProperty(M.registeredClass.instancePrototype,o,q),de([],A?[u,P]:[u],dt=>{var gt=dt[0],se={get(){var re=nr(this,M,H+" getter");return gt.fromWireType(y(S,re))},enumerable:!0};if(A){A=te(E,A);var jt=dt[1];se.set=function(re){var Me=nr(this,M,H+" setter"),Pt=[];A(D,Me,jt.toWireType(Pt,re)),er(Pt)}}return Object.defineProperty(M.registeredClass.instancePrototype,o,se),[]}),[]})},_s=[],ee=[],Mn=a=>{a>9&&--ee[a+1]===0&&(ee[a]=void 0,_s.push(a))},Bn=()=>ee.length/2-5-_s.length,Un=()=>{ee.push(0,1,void 0,1,null,1,!0,1,!1,1),s.count_emval_handles=Bn},fs={toValue:a=>(a||W("Cannot use deleted val. handle = "+a),ee[a]),toHandle:a=>{switch(a){case void 0:return 2;case null:return 4;case!0:return 6;case!1:return 8;default:{const o=_s.pop()||ee.length;return ee[o]=a,ee[o+1]=1,o}}}},Fn={name:"emscripten::val",fromWireType:a=>{var o=fs.toValue(a);return Mn(a),o},toWireType:(a,o)=>fs.toHandle(o),argPackAdvance:Jt,readValueFromPointer:Je,destructorFunction:null},Hn=a=>Gt(a,Fn),ps=a=>{if(a===null)return"null";var o=typeof a;return o==="object"||o==="array"||o==="function"?a.toString():""+a},Wn=(a,o)=>{switch(o){case 4:return function(u){return this.fromWireType(N[u>>2])};case 8:return function(u){return this.fromWireType(O[u>>3])};default:throw new TypeError(`invalid float width (${o}): ${a}`)}},Gn=(a,o,u)=>{o=Nt(o),Gt(a,{name:o,fromWireType:m=>m,toWireType:(m,y)=>y,argPackAdvance:Jt,readValueFromPointer:Wn(o,u),destructorFunction:null})},Vn=(a,o,u)=>{switch(o){case 1:return u?m=>w[m]:m=>k[m];case 2:return u?m=>C[m>>1]:m=>L[m>>1];case 4:return u?m=>I[m>>2]:m=>T[m>>2];default:throw new TypeError(`invalid integer width (${o}): ${a}`)}},jn=(a,o,u,m,y)=>{o=Nt(o);var S=M=>M;if(m===0){var P=32-8*u;S=M=>M<<P>>>P}var E=o.includes("unsigned"),A=(M,H)=>{},D;E?D=function(M,H){return A(H,this.name),H>>>0}:D=function(M,H){return A(H,this.name),H},Gt(a,{name:o,fromWireType:S,toWireType:D,argPackAdvance:Jt,readValueFromPointer:Vn(o,u,m!==0),destructorFunction:null})},Kn=(a,o,u)=>{var m=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],y=m[o];function S(P){var E=T[P>>2],A=T[P+4>>2];return new y(w.buffer,A,E)}u=Nt(u),Gt(a,{name:u,fromWireType:S,argPackAdvance:Jt,readValueFromPointer:S},{ignoreDuplicateRegistrations:!0})},zn=(a,o,u,m)=>{if(!(m>0))return 0;for(var y=u,S=u+m-1,P=0;P<a.length;++P){var E=a.charCodeAt(P);if(E>=55296&&E<=57343){var A=a.charCodeAt(++P);E=65536+((E&1023)<<10)|A&1023}if(E<=127){if(u>=S)break;o[u++]=E}else if(E<=2047){if(u+1>=S)break;o[u++]=192|E>>6,o[u++]=128|E&63}else if(E<=65535){if(u+2>=S)break;o[u++]=224|E>>12,o[u++]=128|E>>6&63,o[u++]=128|E&63}else{if(u+3>=S)break;o[u++]=240|E>>18,o[u++]=128|E>>12&63,o[u++]=128|E>>6&63,o[u++]=128|E&63}}return o[u]=0,u-y},Yn=(a,o,u)=>zn(a,k,o,u),Xn=a=>{for(var o=0,u=0;u<a.length;++u){var m=a.charCodeAt(u);m<=127?o++:m<=2047?o+=2:m>=55296&&m<=57343?(o+=4,++u):o+=3}return o},ir=typeof TextDecoder<"u"?new TextDecoder:void 0,or=(a,o,u)=>{for(var m=o+u,y=o;a[y]&&!(y>=m);)++y;if(y-o>16&&a.buffer&&ir)return ir.decode(a.subarray(o,y));for(var S="";o<y;){var P=a[o++];if(!(P&128)){S+=String.fromCharCode(P);continue}var E=a[o++]&63;if((P&224)==192){S+=String.fromCharCode((P&31)<<6|E);continue}var A=a[o++]&63;if((P&240)==224?P=(P&15)<<12|E<<6|A:P=(P&7)<<18|E<<12|A<<6|a[o++]&63,P<65536)S+=String.fromCharCode(P);else{var D=P-65536;S+=String.fromCharCode(55296|D>>10,56320|D&1023)}}return S},qn=(a,o)=>a?or(k,a,o):"",Qn=(a,o)=>{o=Nt(o);var u=o==="std::string";Gt(a,{name:o,fromWireType(m){var y=T[m>>2],S=m+4,P;if(u)for(var E=S,A=0;A<=y;++A){var D=S+A;if(A==y||k[D]==0){var M=D-E,H=qn(E,M);P===void 0?P=H:(P+="\0",P+=H),E=D+1}}else{for(var q=new Array(y),A=0;A<y;++A)q[A]=String.fromCharCode(k[S+A]);P=q.join("")}return Vt(m),P},toWireType(m,y){y instanceof ArrayBuffer&&(y=new Uint8Array(y));var S,P=typeof y=="string";P||y instanceof Uint8Array||y instanceof Uint8ClampedArray||y instanceof Int8Array||W("Cannot pass non-string to std::string"),u&&P?S=Xn(y):S=y.length;var E=ms(4+S+1),A=E+4;if(T[E>>2]=S,u&&P)Yn(y,A,S+1);else if(P)for(var D=0;D<S;++D){var M=y.charCodeAt(D);M>255&&(Vt(A),W("String has UTF-16 code units that do not fit in 8 bits")),k[A+D]=M}else for(var D=0;D<S;++D)k[A+D]=y[D];return m!==null&&m.push(Vt,E),E},argPackAdvance:Jt,readValueFromPointer:Je,destructorFunction(m){Vt(m)}})},ar=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0,Zn=(a,o)=>{for(var u=a,m=u>>1,y=m+o/2;!(m>=y)&&L[m];)++m;if(u=m<<1,u-a>32&&ar)return ar.decode(k.subarray(a,u));for(var S="",P=0;!(P>=o/2);++P){var E=C[a+P*2>>1];if(E==0)break;S+=String.fromCharCode(E)}return S},Jn=(a,o,u)=>{if(u??(u=2147483647),u<2)return 0;u-=2;for(var m=o,y=u<a.length*2?u/2:a.length,S=0;S<y;++S){var P=a.charCodeAt(S);C[o>>1]=P,o+=2}return C[o>>1]=0,o-m},ti=a=>a.length*2,ei=(a,o)=>{for(var u=0,m="";!(u>=o/4);){var y=I[a+u*4>>2];if(y==0)break;if(++u,y>=65536){var S=y-65536;m+=String.fromCharCode(55296|S>>10,56320|S&1023)}else m+=String.fromCharCode(y)}return m},si=(a,o,u)=>{if(u??(u=2147483647),u<4)return 0;for(var m=o,y=m+u-4,S=0;S<a.length;++S){var P=a.charCodeAt(S);if(P>=55296&&P<=57343){var E=a.charCodeAt(++S);P=65536+((P&1023)<<10)|E&1023}if(I[o>>2]=P,o+=4,o+4>y)break}return I[o>>2]=0,o-m},ri=a=>{for(var o=0,u=0;u<a.length;++u){var m=a.charCodeAt(u);m>=55296&&m<=57343&&++u,o+=4}return o},ni=(a,o,u)=>{u=Nt(u);var m,y,S,P;o===2?(m=Zn,y=Jn,P=ti,S=E=>L[E>>1]):o===4&&(m=ei,y=si,P=ri,S=E=>T[E>>2]),Gt(a,{name:u,fromWireType:E=>{for(var A=T[E>>2],D,M=E+4,H=0;H<=A;++H){var q=E+4+H*o;if(H==A||S(q)==0){var dt=q-M,gt=m(M,dt);D===void 0?D=gt:(D+="\0",D+=gt),M=q+o}}return Vt(E),D},toWireType:(E,A)=>{typeof A!="string"&&W(`Cannot pass non-string to C++ string type ${u}`);var D=P(A),M=ms(4+D+o);return T[M>>2]=D/o,y(A,M+4,D+o),E!==null&&E.push(Vt,M),M},argPackAdvance:Jt,readValueFromPointer:Je,destructorFunction(E){Vt(E)}})},ii=(a,o)=>{o=Nt(o),Gt(a,{isVoid:!0,name:o,argPackAdvance:0,fromWireType:()=>{},toWireType:(u,m)=>{}})},oi=1,ai=()=>oi,li=(a,o,u)=>k.copyWithin(a,o,o+u),ci=()=>Date.now(),lr;lr=()=>performance.now();var hi=()=>2147483648,di=a=>{var o=v.buffer,u=(a-o.byteLength+65535)/65536;try{return v.grow(u),et(),1}catch{}},ui=a=>{var o=k.length;a>>>=0;var u=hi();if(a>u)return!1;for(var m=(A,D)=>A+(D-A%D)%D,y=1;y<=4;y*=2){var S=o*(1+.2/y);S=Math.min(S,a+100663296);var P=Math.min(u,m(Math.max(a,S),65536)),E=di(P);if(E)return!0}return!1},_i=[null,[],[]],fi=(a,o)=>{var u=_i[a];o===0||o===10?((a===1?p:b)(or(u,0)),u.length=0):u.push(o)},pi=(a,o,u,m)=>{for(var y=0,S=0;S<u;S++){var P=T[o>>2],E=T[o+4>>2];o+=8;for(var A=0;A<E;A++)fi(a,k[P+A]);y+=E}return T[m>>2]=y,0};en(),Te=s.BindingError=class extends Error{constructor(o){super(o),this.name="BindingError"}},js=s.InternalError=class extends Error{constructor(o){super(o),this.name="InternalError"}},fn(),hn(),Tn(),Js=s.UnboundTypeError=Cn(Error,"UnboundTypeError"),Un();var cr={__cxa_throw:Zr,_abort_js:Jr,_embind_register_bigint:tn,_embind_register_bool:rn,_embind_register_class:An,_embind_register_class_constructor:Nn,_embind_register_class_function:$n,_embind_register_class_property:On,_embind_register_emval:Hn,_embind_register_float:Gn,_embind_register_integer:jn,_embind_register_memory_view:Kn,_embind_register_std_string:Qn,_embind_register_std_wstring:ni,_embind_register_void:ii,_emscripten_get_now_is_monotonic:ai,_emscripten_memcpy_js:li,emscripten_date_now:ci,emscripten_get_now:lr,emscripten_resize_heap:ui,fd_write:pi},Ut=cs(),hr=a=>(hr=Ut.__getTypeName)(a),ms=a=>(ms=Ut.malloc)(a),Vt=a=>(Vt=Ut.free)(a),dr=a=>(dr=Ut.__cxa_is_pointer_type)(a);s.dynCall_jiji=(a,o,u,m,y)=>(s.dynCall_jiji=Ut.dynCall_jiji)(a,o,u,m,y);var ss;lt=function a(){ss||ur(),ss||(lt=a)};function ur(){if(st>0||(J(),st>0))return;function a(){var o;ss||(ss=!0,s.calledRun=!0,!g&&(vt(),r(s),(o=s.onRuntimeInitialized)==null||o.call(s),At()))}s.setStatus?(s.setStatus("Running..."),setTimeout(function(){setTimeout(function(){s.setStatus("")},1),a()},1)):a()}if(s.preInit)for(typeof s.preInit=="function"&&(s.preInit=[s.preInit]);s.preInit.length>0;)s.preInit.pop()();return ur(),e=i,e}})();class ao{constructor(){this.module=null,this.server=null,this.isReady=oo().then(t=>{this.module=t,this.server=new t.GameServer})}send_templates(t,e){const s=this.server;for(const[r,n]of t){const i=r+"";{const{name:c,desc:h,width:d,height:f,placeW:p,placeH:b}=n;s.new_template(i,c,h,d,f,p,b)}for(const c of n.cells){const{x:h,y:d,w:f,h:p,r:b}=c.dimensions;s.add_cell(i,c.id+"",c.type,c.value,h,d,f,p,b)}for(const c of n.links){const{id:h,bid_src:d,cid_src:f,tgt_src:p,bid_dst:b,cid_dst:_,tgt_dst:v,clr:g}=c,w=new Uint32Array([g]);s.add_link(i,h+"",d+"",f+"",p,b+"",_+"",v,w[0])}for(const c of n.blocks){const{x:h,y:d,w:f,h:p,r:b}=c.dimensions;s.add_block(i,c.id+"",c.templateId+"",h,d,f,p,b)}}for(const[r,n]of t)s.print_template_counts(r+"")}simulation_rebuild(t,e){this.server.simulation_rebuild(t+"",e)}simulation_update(t){this.server.simulation_update(t)}simulation_get_cell_value(t,e,s){return this.server.simulation_get_cell_value(t+"",e,s)}simulation_get_child_simblock(t,e){return this.server.simulation_get_child_simblock(t+"",e)}simulation_set_cell_value(t,e,s){return this.server.simulation_set_cell_value(t+"",e+"",s)}}class zt{static memcopy(t,e,s,r,n){if(n>1024&&t.set&s.subarray)t.set(s.subarray(r,r+n),e);else for(let i=0;i<n;i++)t[e+i]=s[r+i]}static memmove(t,e,s,r){if(t.copyWithin)t.copyWithin(e,s,s+r);else{const n=new Array(r);for(let i=0;i<r;i++)n[i]=t[s+i];for(let i=0;i<r;i++)t[e+i]=n[i]}}static memswap(t,e,s,r,n){const i=new t.constructor(n);zt.memcopy(i,0,t,e,n),zt.memcopy(t,e,s,r,n),zt.memcopy(s,r,i,0,n)}static memreverse(t,e,s,r,n){const i=r+n-1;for(let c=0;c<n;c++)t[e+c]=s[i-c]}static resize(t,e,s=!1){const r=t.constructor,n=t.length,i=new r(e);return s&&zt.memcopy(i,0,t,0,Math.min(n,e)),i}}class is{constructor(t,e,s){this.type=t,this.data=new t(e*s),this.w=e,this.h=s}get cols(){return this.w}get rows(){return this.h}index(t,e){return this.w*e+t}get(t,e){return this.data[this.w*e+t]}set(t,e,s){this.data[this.w*e+t]=s}setRow(t,e){this.data.set(e,this.index(0,t))}copy(t){zt.memcopy(this.data,0,t.data,0,t.data.length)}clone(){const t=new is(this.type,this.w,this.h);return t.copy(this),t}toString(t=8,e=-1){const s=new Array(t).fill(" ").join("");let r="";for(let n=0;n<this.h;n++){for(let i=0;i<this.w;i++){const c=this.get(i,n),h=e>=0?c.toFixed(e):c.toString(),d=(s+h).slice(-t);r+=`${d},`}r+=`
`}return r}swapRows(t,e){const s=this.index(0,t),r=this.index(0,e);zt.memswap(this.data,s,this.data,r,this.w)}scaleRow(t,e){const s=this.index(0,t);for(let r=0;r<this.w;r++)this.data[s+r]*=e}addRow(t,e,s){const r=this.index(0,t),n=this.index(0,e);for(let i=0;i<this.w;i++)this.data[r+i]+=this.data[n+i]*s}}class pe{static normalizeTermInMatrix(t,e,s){const r=t.get(e,s);return r==0?!1:(t.scaleRow(s,1/r),!0)}static eliminateTermInMatrix(t,e,s,r){const n=t.get(e,r);n!=0&&t.addRow(r,s,-n)}static trySolveSystemOfEquations_NxN(t,e,s){const r=t.clone(),n=r.rows;for(let i=0;i<n;i++){const c=i;let h=4294967295;for(let d=i;d<n;d++)if(r.get(c,d)!=0){h=d;break}if(h==4294967295||(h!=i&&r.swapRows(i,h),!pe.normalizeTermInMatrix(r,c,i)))return!1;for(let d=i+1;d<n;d++)pe.eliminateTermInMatrix(r,c,i,d)}for(let i=n-1;i>0;i--){const c=i;if(!pe.normalizeTermInMatrix(r,c,i))return!1;for(let h=0;h<i;h++)pe.eliminateTermInMatrix(r,c,i,h)}for(let i=0;i<n;i++)e[i]=r.get(s,i);return!0}}class os extends Float32Array{constructor(t,e,s,r){super(4),this[0]=t,this[1]=e,this[2]=s,this[3]=r}clone(){return new os(this.x,this.y,this.w,this.h)}get x(){return this[0]}get y(){return this[1]}get w(){return this[2]}get h(){return this[3]}set x(t){return this[0]=t}set y(t){return this[1]=t}set w(t){return this[2]=t}set h(t){return this[3]=t}get xywh(){return this.slice()}set xywh(t){this.set(t)}get x1(){return this[0]}get y1(){return this[1]}get x2(){return this[0]+this[2]}get y2(){return this[1]+this[3]}get xyxy(){return new Float32Array([this[0],this[1],this[0]+this[2],this[1]+this[3]])}set xyxy(t){this.set([t[0],t[1],t[2]-t[0],t[3]-t[1]],0)}}class me extends Array{constructor(...t){if(t.length===1&&super(...t[0]),t.length===0&&super(0,0,1,0,0,1),t.length===5){super(6);const[e,s,r,n,i]=t,c=Math.sin(i*2*Math.PI),h=Math.cos(i*2*Math.PI);this[0]=e,this[1]=s,this[2]=h*r,this[3]=c*r,this[4]=-c*n,this[5]=h*n}}compose(t){const e=this,s=t,r=new me(s);return e.applyBasis(r,0,6,2),r[0]+=e[0],r[1]+=e[1],r}apply(t,e,s,r){for(let n=e;n<s;n+=r){const i=t[n+0],c=t[n+1];t[n+0]=this[0]+i*this[2]+c*this[4],t[n+1]=this[1]+i*this[3]+c*this[5]}return t}applyOffset(t,e,s,r){for(let n=e;n<s;n+=r)t[n+0]+=this[0],t[n+1]+=this[1];return t}applyBasis(t,e,s,r){for(let n=e;n<s;n+=r){const i=t[n+0],c=t[n+1];t[n+0]=i*this[2]+c*this[4],t[n+1]=i*this[3]+c*this[5]}return t}}class oe extends Float32Array{constructor(...t){t.length>0?super(...t):super([0,0])}add(t,e=1){return new oe([this[0]+t[0]*e,this[1]+t[1]*e])}scale(t){return new oe([this[0]*t,this[1]*t])}hypot(){return Math.hypot(...this)}hypotSquared(){return this[0]*this[0]+this[1]*this[1]}normalize(){return this.scale(1/this.hypot())}round(t){const e=1/t;return new oe([Math.round(this[0]*e)*t,Math.round(this[1]*e)*t])}}class ft extends Float32Array{constructor(...t){t.length>0?super(...t):super([0,0,0])}add(t,e=1){return new ft([this[0]+t[0]*e,this[1]+t[1]*e,this[2]+t[2]*e])}scale(t){return new ft([this[0]*t,this[1]*t,this[2]*t])}hypot(){return Math.hypot(...this)}hypotSquared(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]}normalize(){return this.scale(1/this.hypot())}round(t){const e=1/t;return new ft([Math.round(this[0]*e)*t,Math.round(this[1]*e)*t,Math.round(this[2]*e)*t])}}class Ft{static bivector_rotation_inplace(t,e,s,r){for(let n=0;n<3;n++){const i=t[n],c=e[n];t[n]=i*r+c*s,e[n]=c*r-i*s}}static get_AABB_from_points_2d(t,e,s,r){if(s<=e)return new Float32Array([0,0,0,0]);const n=new Float32Array([t[e+0],t[e+1],t[e+0],t[e+1]]);for(let i=e;i<s;i+=r){const c=t[i+0],h=t[i+1];n[0]=Math.min(n[0],c),n[1]=Math.min(n[1],h),n[2]=Math.max(n[2],c),n[3]=Math.max(n[3],h)}return n}static collision_aabb_aabb_2d(t,e){return!(t[0]>e[2]|t[1]>e[3]|t[2]<e[0]|t[3]<e[1])}static collision_aabb_point_2d(t,e){return t[0]<=e[0]&e[0]<=t[2]&t[1]<=e[1]&e[1]<=t[3]}static collision_line_plane_3d(t,e,s,r,n){const c=new is(Float32Array,4,3),h=new Float32Array(3);for(let v=0;v<3;v++){const g=e[v],w=-r[v],k=-n[v],C=s[v]-t[v];c.setRow(v,[g,w,k,C])}const d=pe.trySolveSystemOfEquations_NxN(c,h,3),[f,p,b]=h,_=t.add(e,f);return[d,_]}static collision_line_line_2d(t,e,s,r){const i=new is(Float32Array,3,2),c=new Float32Array(2);for(let b=0;b<2;b++){const _=e[b],v=-r[b],g=s[b]-t[b];i.setRow(b,[_,v,g])}const h=pe.trySolveSystemOfEquations_NxN(i,c,2),[d,f]=c,p=t.add(e,d);return[h,p]}static nearestPoint_point_line_2d(t,e,s){const r=s.add(e,-1),n=new oe([-r[1],r[0]]);return Ft.collision_line_line_2d(t,n,e,r)}static nearestPoint_point_line_segment_2d(t,e,s){const[r,n]=Ft.nearestPoint_point_line_2d(t,e,s);t.add(n,-1).hypot();const i=t.add(e,-1).hypot(),c=t.add(s,-1).hypot(),h=new Float32Array(4);h.set(e,0),h.set(s,2);const d=Ft.get_AABB_from_points_2d(h,0,4,2),f=!(n[0]<d[0]|n[0]>d[2]|n[1]<d[1]|n[1]>d[3]);return r&f?n:i<=c?e:s}}let ht=class _e{static verifyObjectEntriesDefined(t){for(const[e,s]of Object.entries(t))if(s===void 0|s===null)throw`property ${e} is ${s}.`}static verifyType_boolean(t,e){return(t==null?void 0:t.constructor)===e}static verifyType_message(t,e){return`object has constructor <${t.constructor.name}>, expected <${e.name}>.`}static verifyType_throw(t,e){if(!_e.verifyType_boolean(t,e))throw _e.verifyType_message(t,e)}static verifyTypes_boolean(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;s++)if(!_e.verifyType_boolean(t[s],e[s]))return!1;return!0}static verifyTypes_throw(t,e){if(t.length!==e.length)throw`number of objects (${t.length}) and number of types (${e.length}) do not match`;const s=[];for(let r=0;r<t.length;r++)_e.verifyType_boolean(t[r],e[r])||s.push(r);if(s.length>0)throw s.map(r=>_e.verifyType_message(t[r],e[r])).join(`
`)}static getConstructorOverloadIndex_throw(t,e){for(let r=0;r<e.length;r++)if(_e.verifyTypes_boolean(t,e[r]))return r;const s=[];for(const r of t)s.push(r==null?void 0:r.constructor.name);throw`no constructor overload found for arguments: ${JSON.stringify({args:t,constructors:s})}`}};class ys{static tryUntilTruthy(t,e,s,r){return new Promise((n,i)=>{let c=0;const h=setInterval(()=>{const d=t(e);d?(n(d),clearInterval(h)):(c++,c>=r&&(i(null),clearInterval(h)))},s)})}}const Ee=class Ee{static next(){return Ee._next++}};R(Ee,"NONE",0),R(Ee,"THIS_BLOCK",1),R(Ee,"_next",Date.now());let j=Ee;class Mt{constructor(t=0,e=0,s=1,r=1,n=0){this.x=t,this.y=e,this.w=s,this.h=r,this.r=n}save(){const{x:t,y:e,w:s,h:r,r:n}=this;return[t,e,s,r,n]}static load(t){const[e,s,r,n,i]=t;return new Mt(e,s,r,n,i)}clone(){return this.load(this.save())}}class ct{static str_to_u32(t){let e=0;for(let s=0;s<t.length;s++)e=e<<8|t.charCodeAt(s)&255;return e}static u32_to_str(t){let e=[];for(let r=0;r<4;r++)e.push(t&255),t>>=8;let s="";for(let r=0;r<4;r++)s+=String.fromCharCode(e.pop());return s}constructor(t,e,s){this.type=ct.str_to_u32(t),this.tstr=t,this.clr=e,this.name=s}}const Se={CONSTANT:new ct("CNST",1333755903,"constant value"),COPY:new ct("COPY",1869574143,"copy value from input"),OR:new ct("OR",2732892927,"OR"),XOR:new ct("XOR",4294967295,"XOR"),NOT:new ct("NOT",3864848127,"NOT"),AND:new ct("AND",2106097151,"AND"),LSHIFT:new ct("LSH",4294967295,"L-SHIFT"),RSHIFT:new ct("RSH",4294967295,"R-SHIFT"),ADD:new ct("+",4008242943,"+ ADD"),SUB:new ct("-",4294967295,"- SUB"),MULT:new ct("x",4294967295,"x MUL"),DIV:new ct("รท",4294967295,"รท DIV"),GTH:new ct(">",4294967295,"> GTH"),LTH:new ct("<",4294967295,"< LTH"),EQUALS:new ct("==",4294967295,"== EQUALS"),GEQ:new ct(">=",4294967295,">= GEQ"),LEQ:new ct("<=",4294967295,"<= LEQ")},As=new Map;for(const[l,t]of Object.entries(Se))As.set(t.type,t);const xe=class xe{constructor(...t){if(this.dimensions=null,this.id=j.NONE,this.type=0,this.value=0,ht.getConstructorOverloadIndex_throw(t,[[],[Number,Number]])===1){const[s,r]=t;this.dimensions=new Mt(0,0,1,1,0),this.id=j.next(),this.type=s,this.value=r}}get clr(){return As.get(this.type).clr}get typeString(){return As.get(this.type).tstr}get numTargets(){return this.type===Se.CONSTANT.type?1:this.type===Se.COPY.type||this.type===Se.NOT.type?2:3}save(){const{dimensions:t,id:e,type:s,value:r}=this;return{dim:t.save(),id:e,type:s,value:r}}static load(t){const e=new xe;return Object.assign(e,t),e.dimensions=Mt.load(t.dim),e}clone(){return xe.load(this.save())}get LINK_TARGET(){return xe.LINK_TARGET}static canLinkTargets(t,e){const s=1<<t|1<<e;return s===3|s===5}};R(xe,"LINK_TARGET",{OUTPUT:0,INPUT_A:1,INPUT_B:2,NONE:7});let rt=xe;const ls=class ls{static onChange(){this.counter++}constructor(t){this.valueFunc=t,this._state=null,this._value=null}get value(){const t=ls.counter;return this._state!==t&&(this._state=t,this._value=this.valueFunc()),this._value}};R(ls,"counter",0);let bt=ls;class Dt{constructor(...t){if(this.dimensions=null,this.id=j.NONE,this.templateId=j.NONE,ht.getConstructorOverloadIndex_throw(t,[[],[Mt,Number]])===1){const[s,r]=t;this.dimensions=s,this.id=j.next(),this.templateId=r}}save(){const{dimensions:t,id:e,templateId:s}=this;return{dim:t.save(),id:e,templateId:s}}static load(t){const e=new Dt;return Object.assign(e,t),e.dimensions=Mt.load(t.dim),e}clone(){return Dt.load(this.save())}get template(){return x.blockLibrary.templates.get(this.templateId)}get templateWidth(){return this.template.width}get templateHeight(){return this.template.height}set templateWidth(t){this.template.width=t}set templateHeight(t){this.template.height=t}get cells(){return this.template.cells}get links(){return this.template.links}get texts(){return this.template.texts}get blocks(){return this.template.blocks}insertCell(t){return ht.verifyType_throw(t,rt),this.template.insertCell(t),bt.onChange(),x.onRootContentChanged_addCell(t),t}insertLink(t){return ht.verifyType_throw(t,ae),this.cleanupBeforeInsertLink(t),this.template.insertLink(t),bt.onChange(),x.onRootContentChanged_addLink(t),t}insertText(t){return ht.verifyType_throw(t,Ce),this.template.insertText(t),bt.onChange(),t}insertBlock(t){return ht.verifyType_throw(t,Dt),this.template.insertBlock(t),bt.onChange(),x.onRootContentChanged_addBlock(t),t}deleteCell(t){ht.verifyType_throw(t,rt),this.cleanupBeforeDeleteCell(t).then(e=>{console.debug("<>deleteCell() confirmed",e),e&&(this.template.removeCell(t),bt.onChange(),x.onRootContentChanged_remCell(t))})}deleteLink(t){ht.verifyType_throw(t,ae),this.template.removeLink(t),bt.onChange(),x.onRootContentChanged_remLink(t)}deleteText(t){ht.verifyType_throw(t,Ce),this.template.removeText(t),bt.onChange()}deleteBlock(t){ht.verifyType_throw(t,Dt),this.cleanupBeforeDeleteBlock(t),this.template.removeBlock(t),bt.onChange(),x.onRootContentChanged_remBlock(t)}cleanupBeforeInsertLink(t){t.bid_src===this.id&&(t.bid_src=j.THIS_BLOCK),t.bid_dst===this.id&&(t.bid_dst=j.THIS_BLOCK);for(const e of this.links)if(ae.hasSameDstTarget(t,e)){this.deleteLink(e),x.onRootContentChanged_remLink(e);break}}cleanupBeforeDeleteBlock(t){for(const e of this.links.slice())e.isConnectedToBlock(t.id)&&this.deleteLink(e)}cleanupBeforeDeleteCell(t){const e=this.templateId,s=t.id,n=x.blockLibrary.getLinksThatPointToCellInTemplate(e,s,!1);return console.debug("deletionList",n),new Promise((c,h)=>{if(console.debug("<>cleanupBeforeDeleteCell promise",n),n.length===0)c(!0);else{const d=()=>{console.debug("<>cleanupBeforeDeleteCell submit"),x.blockLibrary.deleteLinksInTemplateLinkList(n),x.gameUI.hideLinkDeletionPopup(),c(!0)},f=()=>{console.debug("<>cleanupBeforeDeleteCell cancel"),x.gameUI.hideLinkDeletionPopup(),c(!1)};x.gameUI.showLinkDeletionPopup(n,"WARNING - links in the following templates will also be deleted:",d,f)}}).then(c=>{if(c)for(const h of this.links.slice())h.isConnectedToCell(t.id)&&this.deleteLink(h);return c})}}class ae{constructor(...t){this.id=j.NONE,this.bid_src=j.NONE,this.cid_src=j.NONE,this.tgt_src=rt.LINK_TARGET.OUTPUT,this.bid_dst=j.NONE,this.cid_dst=j.NONE,this.tgt_dst=0,this.clr=4291620607;const e=ht.getConstructorOverloadIndex_throw(t,[[],[Dt,Dt,rt,rt,Number,Number],[Number,Number,Number,Number,Number,Number]]);if(e===1){const[s,r,n,i,c,h]=t;this.id=j.next(),this.bid_src=s.id,this.cid_src=n.id,this.bid_dst=r.id,this.cid_dst=i.id,this.tgt_dst=c,this.clr=h}if(e===2){const[s,r,n,i,c,h]=t;this.id=j.next(),this.bid_src=s,this.cid_src=n,this.bid_dst=r,this.cid_dst=i,this.tgt_dst=c,this.clr=h}}save(){const{id:t,bid_src:e,bid_dst:s,cid_src:r,cid_dst:n,tgt_dst:i,clr:c}=this;return{id:t,src_addr:[e,r],dst_addr:[s,n,i],clr:c}}static load(t){const{id:e,src_addr:s,dst_addr:r,clr:n}=t,[i,c]=s,[h,d,f]=r,p={id:e,bid_src:i,bid_dst:h,cid_src:c,cid_dst:d,tgt_dst:f,clr:n},b=new ae;return Object.assign(b,p),b}clone(){return ae.load(this.save())}isConnectedToCell(t){return this.cid_src===t|this.cid_dst===t}isConnectedToBlock(t){return this.bid_src===t|this.bid_dst===t}static hasSameDstTarget(t,e){return t.bid_dst===e.bid_dst&t.cid_dst===e.cid_dst&t.tgt_dst===e.tgt_dst}}class Ce{constructor(...t){if(this.id=j.NONE,this.dimensions=null,this.str=null,this.fhgt=1,this.fclr=255,this.bclr=4294967295,this.oclr=255,ht.getConstructorOverloadIndex_throw(t,[[],[Mt,Number,Number,Number,Number,String]])===1){const[s,r,n,i,c,h]=t;this.id=j.next(),this.dimensions=s,this.str=h,this.fhgt=r,this.fclr=n,this.bclr=i,this.oclr=c}}save(){const{dimensions:t,id:e,str:s,fhgt:r,fclr:n,bclr:i,oclr:c}=this;return{dim:t.save(),id:e,str:s,fhgt:r,fclr:n,bclr:i,oclr:c}}static load(t){const e=new Ce;return Object.assign(e,t),e.dimensions=Mt.load(t.dim),e}clone(){return Ce.load(this.save())}}class Ve{constructor(...t){if(this.cells=null,this.links=null,this.texts=null,this.blocks=null,this.templateId=j.NONE,this.width=0,this.height=0,this.placeW=0,this.placeH=0,this.name=null,this.desc=null,ht.getConstructorOverloadIndex_throw(t,[[Number,Number]])===0){const[s,r]=t;this.cells=[],this.links=[],this.texts=[],this.blocks=[],this.templateId=j.next(),this.width=s,this.height=r,this.placeW=s/4,this.placeH=r/4,this.name="NAME_"+this.templateId,this.desc="DESCRIPTION"}}save(){const{cells:t,links:e,texts:s,blocks:r,templateId:n,width:i,height:c,placeW:h,placeH:d,name:f,desc:p}=this,b=[];for(const w of t)b.push(w.save());const _=[];for(const w of e)_.push(w.save());const v=[];for(const w of s)v.push(w.save());const g=[];for(const w of r)g.push(w.save());return{templateId:n,width:i,height:c,placeW:h,placeH:d,name:f,desc:p,cells:b,links:_,texts:v,blocks:g}}static load(t){const{templateId:e,width:s,height:r,placeW:n,placeH:i,name:c,desc:h,cells:d,links:f,texts:p,blocks:b}=t,_=new Ve(s,r);_.templateId=e,_.name=c,_.desc=h,_.placeW=n,_.placeH=i;for(const v of d)_.cells.push(rt.load(v));for(const v of f)_.links.push(ae.load(v));for(const v of p)_.texts.push(Ce.load(v));for(const v of b)_.blocks.push(Dt.load(v));return _}insertItem(t,e){t.push(e)}removeItem(t,e){for(let s=0;s<t.length;s++)t[s].id===e.id&&(t[s]=t[t.length-1],t.pop())}insertCell(t){this.insertItem(this.cells,t)}insertLink(t){this.insertItem(this.links,t)}insertText(t){this.insertItem(this.texts,t)}insertBlock(t){this.insertItem(this.blocks,t)}removeCell(t){this.removeItem(this.cells,t)}removeLink(t){this.removeItem(this.links,t)}removeText(t){this.removeItem(this.texts,t)}removeBlock(t){this.removeItem(this.blocks,t)}getValidCellTargets(t){const e=new Set,s=new Set,r=new Set,n=new Map;for(const d of this.cells)e.add(d),s.add(d),r.add(d),n.set(d.id,d);for(const d of this.cells){const f=d.numTargets;f<2&&s.delete(d),f<3&&r.delete(d)}const i=rt.LINK_TARGET.OUTPUT,c=rt.LINK_TARGET.INPUT_A,h=rt.LINK_TARGET.INPUT_B;if(!t)for(const d of this.links){const{bid_src:f,bid_dst:p,cid_src:b,cid_dst:_,tgt_src:v,tgt_dst:g}=d;g===i&&e.delete(n.get(_)),g===c&&s.delete(n.get(_)),g===h&&r.delete(n.get(_))}return{out:e,ina:s,inb:r}}}class lo{constructor(){R(this,"_countUsedTemplatesInTree_cache",new Map);this.templates=new Map,this.rootBlock=null}_countUsedTemplatesInTree(t){console.log("<>templateId",t);const e=this._countUsedTemplatesInTree_cache;if(e.has(t))return e.get(t);const s=new Map;s.set(t,1),console.log("<>this.templates",this.templates);const r=this.templates.get(t);for(const n of r.blocks){const i=this._countUsedTemplatesInTree(n.templateId);for(const[c,h]of i.entries())s.set(c,(s.get(c)??0)+h)}return e.set(t,s),s}countUsedTemplatesInTree(t){if(!t)throw"missing templateId";return this._countUsedTemplatesInTree_cache.clear(),this._countUsedTemplatesInTree(t)}containsTemplateInTree(t,e){return this.countUsedTemplatesInTree(t).has(e)}containsRootTemplateInTree(t){return this.countUsedTemplatesInTree(t).has(this.rootBlock.templateId)}set_root_block_template(t){const e=this.templates.get(t);this.rootBlock=new Dt(new Mt(0,0,e.width,e.height,0),t)}refresh_root_block_template(){const t=this.rootBlock.templateId,e=this.templates.get(t);this.rootBlock=new Dt(new Mt(0,0,e.width,e.height,0),t)}createNewBlockTemplate(t,e,s,r){const n=new Ve(t,e);n.name=s,n.desc=r,this.templates.set(n.templateId,n),x.gameUI.on_major_blocklib_change(),x.set_root_block_template(n.templateId)}getTemplateDependents(t){const e=[];for(const[s,r]of this.templates.entries())if(s!==t){const n=new Map;for(const i of r.blocks){const c=i.templateId;n.set(c,(n.get(c)??0)+1)}n.has(t)&&e.push([r,n.get(t)])}return e}canDeleteBlockTemplate(t){return!(t===this.rootBlock.templateId||this.getTemplateDependents(t).length>0)}deleteBlockTemplate(t){if(t===this.rootBlock.templateId){alert("cannot delete template while it is being edited");return}const e=this.getTemplateDependents(t);if(e.length>0){let s=[];for(const[r,n]of e)s.push(`[${r.templateId}] "${r.name}" contains ${n} instance(s)`);alert(`cannot delete template as other templates depend on it:

${s.join(`
`)}`);return}console.log("deleting template",t),this.templates.delete(t),x.gameUI.on_major_blocklib_change()}get_template_dependency_chain(t,e){const s=this.templates.get(t);for(const n of s.blocks)if(n.templateId===e){const i=this.templates.get(n.templateId);return[s,i]}const r=new Set;for(const n of s.blocks)r.add(n.templateId);for(const n of r.keys()){const i=this.get_template_dependency_chain(n,e);if(i)return[s,...i]}return null}get_root_template_dependency_chain(t){return this.get_template_dependency_chain(t,this.rootBlock.templateId)}exportTemplates(){let t=[];for(const[e,s]of this.templates.entries())t.push(s.save());return JSON.stringify(t)}importTemplates(t){const e=t.trim();if(e.length>0)try{const s=[],r=JSON.parse(e);console.log("<>arr",r);for(const n of r){const i=Ve.load(n);this.templates.set(i.templateId,i),x.simulationShouldRebuild=!0}}catch(s){alert(`failed to parse import text-area:

`+s.stack)}this.templates.size===0&&(x.createNewBlockTemplate(12,12,"New template",""),x.simulationShouldRebuild=!0),x.gameUI.on_major_blocklib_change()}get_link_point(t,e,s){ht.verifyType_throw(e,rt);let r=x.gameRenderer.renderBlock;t!==j.THIS_BLOCK&&t!==this.rootBlock.id&&(r=r.children.get(t));const n=r.c_points.get(e.id);return ht.verifyType_throw(n,Float32Array),n.slice(s*3,s*3+3)}get_all_cell_targets(){const t=[],e=rt.LINK_TARGET.OUTPUT,s=rt.LINK_TARGET.INPUT_A,r=rt.LINK_TARGET.INPUT_B;{const n=this.rootBlock,{out:i,ina:c,inb:h}=n.template.getValidCellTargets(!0),d=n.id;let f;f=e;for(const p of i.keys())t.push([this.get_link_point(d,p,f),d,p.id,f]);f=s;for(const p of c.keys())t.push([this.get_link_point(d,p,f),d,p.id,f]);f=r;for(const p of h.keys())t.push([this.get_link_point(d,p,f),d,p.id,f])}for(const n of this.templates.get(this.rootBlock.templateId).blocks){const{out:i,ina:c,inb:h}=n.template.getValidCellTargets(!1),d=n.id;let f;f=e;for(const p of i.keys())t.push([this.get_link_point(d,p,f),d,p.id,f]);f=s;for(const p of c.keys())t.push([this.get_link_point(d,p,f),d,p.id,f]);f=r;for(const p of h.keys())t.push([this.get_link_point(d,p,f),d,p.id,f])}return t}get_nearst_cell_target(t,e,s){if(t.length<=0)return null;let r=0,n=-1,i=!1;for(let c=0;c<t.length;c++){const[h,d,f,p]=t[c];if(s===rt.LINK_TARGET.NONE||rt.canLinkTargets(s,p)){const b=e.add(h,-1).hypotSquared();b<n|!i&&(r=c,n=b,i=!0)}}return t[r]}getLinksThatPointToCellInTemplate(t,e,s){const r=[];for(const[n,i]of this.templates.entries()){if(n===t&&!s)continue;const c=new Map;for(const d of i.blocks)c.set(d.id,d.templateId);const h=[];for(const d of i.links){const{bid_src:f,bid_dst:p,cid_src:b,cid_dst:_,tgt_src:v,tgt_dst:g}=d,w=f===j.THIS_BLOCK?n:c.get(f),k=p===j.THIS_BLOCK?n:c.get(p);w===t&b===e|k===t&_===e&&h.push(d)}h.length>0&&r.push([i,h])}return console.debug("<>getLinksThatPointToCellInTemplate(templateId, cid, includeSelf)",t,e,s,r),r}getLinksThatCantFindTargets(){const t=new Map;for(const[s,r]of this.templates.entries()){const n=new Set;for(const i of r.cells)n.add(i.id);t.set(s,n)}const e=[];for(const[s,r]of this.templates.entries()){const n=new Map;for(const c of r.blocks)n.set(c.id,c.templateId);const i=[];for(const c of r.links){const{bid_src:h,bid_dst:d,cid_src:f,cid_dst:p,tgt_src:b,tgt_dst:_}=c,v=h===j.THIS_BLOCK?s:n.get(h),g=d===j.THIS_BLOCK?s:n.get(d),w=t.get(v).has(f),k=t.get(g).has(p);!w|!k&&i.push(c)}i.length>0&&e.push([r,i])}return e}deleteLinksInTemplateLinkList(t){for(const[e,s]of t)for(const r of s)e.removeLink(r),x.onRootContentChanged_remLink(r)}verifyLinksCanFindTargets(){const t=this.getLinksThatCantFindTargets();return new Promise((s,r)=>{if(t.length===0)s(!0);else{const n=()=>{console.debug("<>verifyLinksCanFindTargets submit"),this.deleteLinksInTemplateLinkList(t),x.gameUI.hideLinkDeletionPopup(),s(!0)},i=()=>{console.debug("<>verifyLinksCanFindTargets cancel"),x.gameUI.hideLinkDeletionPopup(),s(!1)};x.gameUI.showLinkDeletionPopup(t,"WARNING - links in the following templates failed to find targets (delete links?):",n,i)}})}}const tt=class tt{constructor(t,e,s,r,n){this.parent=t,this.block=e,this.depth=r,this.externalTran=s,this.contentTran=null,this.itemTran=null,this.item_trans=new Map,this.c_points=new Map,this.l_points=new Map,this.children=new Map,this.render_data_cells=[],this.render_data_links=[],this.render_data_texts=[],this.render_data_blocks=[],this.is_hovered=!1,this.is_selected=!1,this.itemTran=tt.get_item_transformation(e,this.externalTran),this.contentTran=tt.get_content_transformation(e,this.externalTran);const i=this.contentTran,c=e.template;for(const h of c.cells)this.item_trans.set(h.id,tt.get_item_transformation(h,i));for(const h of c.texts)this.item_trans.set(h.id,tt.get_item_transformation(h,i));for(const h of c.blocks)this.item_trans.set(h.id,tt.get_item_transformation(h,i));for(const h of c.cells){const d=tt.LINK_POINTS_F32.slice();this.item_trans.get(h.id).apply(d,0,d.length,3),this.c_points.set(h.id,d)}if(r<n)for(const h of c.blocks){const d=new tt(this,h,i,r+1,n);this.children.set(h.id,d)}for(const h of c.links){let d=new Float32Array(6);const{bid_src:f,bid_dst:p,cid_src:b,cid_dst:_,tgt_src:v,tgt_dst:g}=h;d.set(this.get_cell_link_point(f,b,v),0),d.set(this.get_cell_link_point(p,_,g),3),this.l_points.set(h.id,d)}for(const h of c.cells)this.render_data_cells.push(this.get_render_data_cell(h));for(const h of c.links)this.render_data_links.push(this.get_render_data_link(h));for(const h of c.texts)this.render_data_texts.push(this.get_render_data_text(h));for(const h of c.blocks)this.render_data_blocks.push(this.get_render_data_block(h))}static get_item_transformation(t,e){const s=tt.UNIT_SQUARE_TRANSFORMATION,r=t.dimensions,n=new me(r.x,r.y,r.w,r.h,r.r);return e.compose(n).compose(s)}static get_content_transformation(t,e){ht.verifyTypes_throw([t,e],[Dt,me]);const s=t.template;ht.verifyTypes_throw([s],[Ve]);const r=new me(0,0,1/s.width,1/s.height,0);return this.get_item_transformation(t,e).compose(r)}get_cell_link_point(t,e,s){const r=s*3;if(t===j.THIS_BLOCK)return this.c_points.get(e).slice(r,r+3);if(this.children.has(t))return this.children.get(t).c_points.get(e).slice(r,r+3);const n=new Float32Array([.5,.5,0]);return this.item_trans.get(t).apply(n,0,n.length,3),n}get_axis_aligned_bounding_box(t){const e=[0,0,0,1,0,0,1,1,0,0,1,0];return this.item_trans.get(t.id).apply(e,0,e.length,3),Ft.get_AABB_from_points_2d(e,0,e.length,3)}get_render_data_cell(t){const e=t,s=tt.get_item_transformation(t,this.contentTran),r=e.numTargets;return{cell:e,tran:s,numTargets:r}}get_render_data_link(t){const e=t,s=this.l_points.get(e.id),r=[s[0],s[1]],n=[s[3],s[4]];return{link:e,p0:r,p1:n}}get_render_data_text(t){const e=t,s=tt.get_item_transformation(t,this.contentTran);return{text:e,tran:s}}get_render_data_block(t){const e=t,s=tt.get_item_transformation(t,this.contentTran);return{block:e,tran:s}}};R(tt,"LINK_POINTS_F32",new Float32Array([1,.5,0,0,.75,0,0,.25,0])),R(tt,"LINK_POINTS_ARR",[[1,.5,0],[0,.75,0],[0,.25,0]]),R(tt,"LINK_RECTS_ARR",tt.LINK_POINTS_ARR.map(([t,e,s])=>[t-.1,e-.1,.1*2,.1*2])),R(tt,"CELL_AREA_RECTS",[[.5,0,.5,1],[0,.5,.5,.5],[0,0,.5,.5]]),R(tt,"CELL_RECTS",[...tt.CELL_AREA_RECTS,...tt.LINK_RECTS_ARR]),R(tt,"UNIT_SQUARE_TRANSFORMATION",new me(-.5,-.5,1,1,0));let ie=tt;const B=WebGL2RenderingContext,Vr={ARRAY_BUFFER:B.ARRAY_BUFFER,INDEX_BUFFER:B.ELEMENT_ARRAY_BUFFER},ks={STATIC_DRAW:B.STATIC_DRAW,DYNAMIC_DRAW:B.DYNAMIC_DRAW,STREAM_DRAW:B.STREAM_DRAW},Er={BUFFER_SIZE:B.BUFFER_SIZE,BUFFER_USAGE:B.BUFFER_USAGE};class xr{static getBufferParam(t,e,s,r){return t.bindBuffer(e,s),t.getBufferParameter(e,r)}static getBufferSize(t,e,s){return as.getBufferParam(t,e,s,Er.BUFFER_SIZE)}static getBufferUsage(t,e,s){return as.getBufferParam(t,e,s,Er.BUFFER_USAGE)}static createBuffer(t,e,s,r){const n=t.createBuffer();return t.bindBuffer(s,n),t.bufferData(s,e,r),n}}class as{constructor(t,e,s,r,n){this.glContext=t,this.target=r,this.usage=n,this.arrayType=e,this.data=new e(s),this.buffer=xr.createBuffer(t,this.data.byteLength,r,n),this.writePos=0,this.bufferPos=0}get BYTES_PER_ELEMENT(){return this.arrayType.BYTES_PER_ELEMENT}get GL_ENUM_TYPE(){return ko(this.arrayType)}resize(t,e){const s=this.data.length;return this.data=zt.resize(this.data,Math.ceil(t),e),this.buffer=xr.createBuffer(this.glContext,this.data.byteLength,this.target,this.usage),this.writePos=e?Math.min(this.writePos,s):0,this.bufferPos=0,!0}clear(){this.writePos=0,this.bufferPos=0}reserve(t){const e=this.writePos+t;e>this.data.length&&this.resize(e*3/2+32,!0)}pushData(t,e,s){return zt.memcopy(this.data,this.writePos,t,e,s),this.writePos+=s,this.writePos}reserveAndPushData(t,e,s){this.reserve(s),this.pushData(t,e,s)}commitNewDataToBuffer(){const t=this.bufferPos,e=this.writePos-this.bufferPos,s=this.data,r=t*this.BYTES_PER_ELEMENT,n=t,i=this.glContext;i.bindBuffer(this.target,this.buffer),i.bufferSubData(this.target,r,s,n,e),this.bufferPos=this.writePos}}class ue extends as{constructor(t,e,s,r,n,i){super(t,e,s,Vr.ARRAY_BUFFER,r),this.attributeNames=i,this.vertexSize=n.getAttributeLayoutStride(i),this.vertexLength=this.vertexSize/this.BYTES_PER_ELEMENT}get vertexCount(){return this.writePos/this.vertexLength}}class Ts extends as{constructor(t,e,s,r){super(t,e,s,Vr.INDEX_BUFFER,r)}get indexCount(){return this.writePos}pushData(t,e,s,r=0){const n=this.writePos;super.pushData(t,e,s);const i=this.writePos;if(r!==0)for(let c=n;c<i;c++)this.data[c]+=r}reserveAndPushData(t,e,s,r=0){this.reserve(s),this.pushData(t,e,s,r)}}var Es=1e-6,je=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var l=0,t=arguments.length;t--;)l+=arguments[t]*arguments[t];return Math.sqrt(l)});function Rs(){var l=new je(16);return je!=Float32Array&&(l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[11]=0,l[12]=0,l[13]=0,l[14]=0),l[0]=1,l[5]=1,l[10]=1,l[15]=1,l}function jr(l){return l[0]=1,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=1,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=1,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l}function Sr(l,t,e){var s=t[0],r=t[1],n=t[2],i=t[3],c=t[4],h=t[5],d=t[6],f=t[7],p=t[8],b=t[9],_=t[10],v=t[11],g=t[12],w=t[13],k=t[14],C=t[15],L=e[0],I=e[1],T=e[2],N=e[3];return l[0]=L*s+I*c+T*p+N*g,l[1]=L*r+I*h+T*b+N*w,l[2]=L*n+I*d+T*_+N*k,l[3]=L*i+I*f+T*v+N*C,L=e[4],I=e[5],T=e[6],N=e[7],l[4]=L*s+I*c+T*p+N*g,l[5]=L*r+I*h+T*b+N*w,l[6]=L*n+I*d+T*_+N*k,l[7]=L*i+I*f+T*v+N*C,L=e[8],I=e[9],T=e[10],N=e[11],l[8]=L*s+I*c+T*p+N*g,l[9]=L*r+I*h+T*b+N*w,l[10]=L*n+I*d+T*_+N*k,l[11]=L*i+I*f+T*v+N*C,L=e[12],I=e[13],T=e[14],N=e[15],l[12]=L*s+I*c+T*p+N*g,l[13]=L*r+I*h+T*b+N*w,l[14]=L*n+I*d+T*_+N*k,l[15]=L*i+I*f+T*v+N*C,l}function co(l,t,e){var s=e[0],r=e[1],n=e[2];return l[0]=t[0]*s,l[1]=t[1]*s,l[2]=t[2]*s,l[3]=t[3]*s,l[4]=t[4]*r,l[5]=t[5]*r,l[6]=t[6]*r,l[7]=t[7]*r,l[8]=t[8]*n,l[9]=t[9]*n,l[10]=t[10]*n,l[11]=t[11]*n,l[12]=t[12],l[13]=t[13],l[14]=t[14],l[15]=t[15],l}function ho(l,t,e,s,r){var n=1/Math.tan(t/2);if(l[0]=n/e,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=n,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[11]=-1,l[12]=0,l[13]=0,l[15]=0,r!=null&&r!==1/0){var i=1/(s-r);l[10]=(r+s)*i,l[14]=2*r*s*i}else l[10]=-1,l[14]=-2*s;return l}var uo=ho;function _o(l,t,e,s){var r,n,i,c,h,d,f,p,b,_,v=t[0],g=t[1],w=t[2],k=s[0],C=s[1],L=s[2],I=e[0],T=e[1],N=e[2];return Math.abs(v-I)<Es&&Math.abs(g-T)<Es&&Math.abs(w-N)<Es?jr(l):(f=v-I,p=g-T,b=w-N,_=1/Math.hypot(f,p,b),f*=_,p*=_,b*=_,r=C*b-L*p,n=L*f-k*b,i=k*p-C*f,_=Math.hypot(r,n,i),_?(_=1/_,r*=_,n*=_,i*=_):(r=0,n=0,i=0),c=p*i-b*n,h=b*r-f*i,d=f*n-p*r,_=Math.hypot(c,h,d),_?(_=1/_,c*=_,h*=_,d*=_):(c=0,h=0,d=0),l[0]=r,l[1]=c,l[2]=f,l[3]=0,l[4]=n,l[5]=h,l[6]=p,l[7]=0,l[8]=i,l[9]=d,l[10]=b,l[11]=0,l[12]=-(r*v+n*g+i*w),l[13]=-(c*v+h*g+d*w),l[14]=-(f*v+p*g+b*w),l[15]=1,l)}function fo(){var l=new je(3);return je!=Float32Array&&(l[0]=0,l[1]=0,l[2]=0),l}function xs(l,t,e){var s=new je(3);return s[0]=l,s[1]=t,s[2]=e,s}(function(){var l=fo();return function(t,e,s,r,n,i){var c,h;for(e||(e=3),s||(s=0),r?h=Math.min(r*e+s,t.length):h=t.length,c=s;c<h;c+=e)l[0]=t[c],l[1]=t[c+1],l[2]=t[c+2],n(l,l,i),t[c]=l[0],t[c+1]=l[1],t[c+2]=l[2];return t}})();const Ls={RGB:B.RGB,RGBA:B.RGBA,ALPHA:B.ALPHA,LUMINANCE:B.LUMINANCE,LUM_ALPHA:B.LUMINANCE_ALPHA},Ns={UNSIGNED_BYTE:B.UNSIGNED_BYTE,U_SHORT_4444:B.UNSIGNED_SHORT_4_4_4_4,U_SHORT_5551:B.UNSIGNED_SHORT_5_5_5_1,U_SHORT_565:B.UNSIGNED_SHORT_5_6_5};class po{constructor(t){this.glContext=t,this.texture=t.createTexture()}configureTexture(t,e){const s=this.glContext,r=(t&t-1)===0,n=(e&e-1)===0;r&&n?(s.generateMipmap(s.TEXTURE_2D),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.REPEAT),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.REPEAT)):(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR))}setTextureData(t,e,s,r=Ls.RGBA,n=Ns.UNSIGNED_BYTE){const i=this.glContext,c=0,h=0,d=r;i.bindTexture(i.TEXTURE_2D,this.texture),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),i.texImage2D(i.TEXTURE_2D,c,d,t,e,h,r,n,s),this.configureTexture(t,e)}async setTextureUrl(t,e=Ls.RGBA,s=Ns.UNSIGNED_BYTE){return new Promise((r,n)=>{const i=new Image;i.onload=()=>{try{const c=this.glContext,h=0,d=e;c.bindTexture(c.TEXTURE_2D,this.texture),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0),c.texImage2D(c.TEXTURE_2D,h,d,e,s,i),this.configureTexture(i.width,i.height),r(i)}catch(c){n(c)}},i.onerror=c=>{n(c)},i.src=t})}}class mo{constructor(){this.aspectRatio=1,this.FOV=7/360,this.zNear=.1,this.zFar=1e3,this.pos=new Float32Array([0,0,-100]),this.dirX=new Float32Array([1,0,0]),this.dirY=new Float32Array([0,1,0]),this.dirZ=new Float32Array([0,0,1]),this.matrixProj=Rs(),this.matrixView=Rs(),this.updateProjection(),this.updateView()}setAspectRatio(t,e){this.aspectRatio=t/e,this.updateProjection()}updateProjection(){const t=this.FOV*(2*Math.PI);uo(this.matrixProj,t,this.aspectRatio,this.zNear,this.zFar),co(this.matrixProj,this.matrixProj,[-1,1,1])}updateView(){const t=xs(...this.pos),e=xs(...this.pos.map((r,n)=>r+this.dirZ[n])),s=xs(...this.dirY);_o(this.matrixView,t,e,s)}applyCameraMatrix(t){Sr(t,this.matrixView,t),Sr(t,this.matrixProj,t)}translate(t,e,s){this.pos[0]+=t,this.pos[1]+=e,this.pos[2]+=s,this.updateView()}move(t,e,s){for(let r=0;r<3;r++)this.pos[r]+=this.dirX[r]*t+this.dirY[r]*e+this.dirZ[r]*s;this.updateView()}zoom(t){const e=(t-1)*Math.cos(this.FOV*2*(2*Math.PI/4));this.FOV=Math.min(this.FOV*(e+1),.49),this.updateProjection()}rotate(t,e,s){[[e,this.dirZ,this.dirY],[t,this.dirZ,this.dirX],[s,this.dirY,this.dirX]].forEach(n=>{const[i,c,h]=n,d=i*2*Math.PI,f=Math.sin(d),p=Math.cos(d);for(let b=0;b<3;b++){const _=c[b],v=h[b];c[b]=_*p+v*f,h[b]=v*p-_*f}}),this.updateView()}getRayDirection(t){const[e,s]=t,r=new Float32Array([...this.dirX]),n=new Float32Array([...this.dirY]),i=new Float32Array([...this.dirZ]),c=e*(this.FOV/2)*(2*Math.PI),h=s*(this.FOV/2)*(2*Math.PI);return this.bivector_rotation_inplace(i,r,Math.sin(c),Math.cos(c)),this.bivector_rotation_inplace(i,n,Math.sin(h),Math.cos(h)),i}bivector_rotation_inplace(t,e,s,r){for(let n=0;n<3;n++){const i=t[n],c=e[n];t[n]=i*r+c*s,e[n]=c*r-i*s}}}function Ue(l){for(const t of Object.keys(l))if(l[t]===void 0)throw`missing attribute: ${t} is undefined`}class Kr{constructor(t){const{attribs:e,uniforms:s,vertSource:r,fragSource:n}=t;this.attribs=new Map,this.uniforms=new Map,this.vertSource=r,this.fragSource=n;for(const{name:i,type:c,numComponents:h,normalize:d}of e){const f={name:i,type:c,numComponents:h,normalize:d};Ue(f),this.attribs.set(i,f)}for(const{name:i}of s){const c={name:i};Ue(c),this.uniforms.set(i,c)}}getAttributeLayoutStride(t){let e=0;for(const s of t){const{name:r,type:n,numComponents:i,normalize:c}=this.attribs.get(s);e+=i*Cr(n)}return e}createAttributeLayout(t){let e=[],s=this.getAttributeLayoutStride(t),r=0;for(const n of t){const{name:i,type:c,numComponents:h,normalize:d}=this.attribs.get(n),f={name:i,type:c,numComponents:h,normalize:d,stride:s,offset:r};e.push(f),r+=h*Cr(c)}return e}}const Kt=class Kt{constructor(t,e,s,r,n){const{vertSource:i,fragSource:c,attribs:h,uniforms:d}=e;this.glContext=t,this.config=e,this.program=Kt.initShaderProgram(t,i,c),this.locations=Kt.getProgramBindingLocations(t,this.program,h,d),this.attributeBuffers=s,this.indexBuffer=r,this.drawMode=n}static loadShader(t,e,s){const r=t.createShader(e);return t.shaderSource(r,s),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?r:(alert(`An error occurred compiling the shaders: ${t.getShaderInfoLog(r)}`),t.deleteShader(r),null)}static initShaderProgram(t,e,s){const r=Kt.loadShader(t,B.VERTEX_SHADER,e),n=Kt.loadShader(t,B.FRAGMENT_SHADER,s),i=t.createProgram();return t.attachShader(i,r),t.attachShader(i,n),t.linkProgram(i),t.getProgramParameter(i,t.LINK_STATUS)?i:(alert(`Unable to initialize the shader program: ${t.getProgramInfoLog(i)}`),null)}static getProgramBindingLocations(t,e,s,r){const n=new Map;for(const i of s.keys())n.set(i,t.getAttribLocation(e,i));for(const i of r.keys())n.set(i,t.getUniformLocation(e,i));return n}useProgram(){Kt.currentProgram!==this.program&&(this.glContext.useProgram(this.program),Kt.currentProgram=this.program)}bindAttributes(t,e,s){this.useProgram();const r=this.glContext;r.bindBuffer(t,e);for(const n of s){const{name:i,type:c,numComponents:h,normalize:d,stride:f,offset:p}=n;Ue({name:i,type:c,numComponents:h,normalize:d,stride:f,offset:p});const _=this.locations.get(i);To(c)?r.vertexAttribIPointer(_,h,c,d,f,p):r.vertexAttribPointer(_,h,c,d,f,p),r.enableVertexAttribArray(_)}}setUniform_mat4fv(t,e,s){const r=this.config.uniforms.get(e),n=this.locations.get(e),{name:i}=r;Ue({name:i}),this.useProgram(),this.useProgram(),t.uniformMatrix4fv(n,!1,s)}setUniform_texbuf(t,e,s,r=B.TEXTURE0){const n=this.config.uniforms.get(e),i=this.locations.get(e),{name:c}=n;Ue({name:c}),this.useProgram(),t.activeTexture(r),t.bindTexture(t.TEXTURE_2D,s.texture),t.uniform1i(i,0)}bindAttributeBuffers(){for(const t of this.attributeBuffers){const e=this.config.createAttributeLayout(t.attributeNames);this.bindAttributes(t.target,t.buffer,e)}}drawElements(){this.bindAttributeBuffers(),this.useProgram();const t=this.glContext,e=this.indexBuffer,s=e.GL_ENUM_TYPE,r=xo,n=0,i=e.indexCount;t.bindBuffer(B.ELEMENT_ARRAY_BUFFER,e.buffer);for(let c=n;c<i;c+=r){const h=Math.min(i-c,r),d=c*e.BYTES_PER_ELEMENT;t.drawElements(this.drawMode,h,s,d)}}};R(Kt,"currentProgram",null);let Fe=Kt;class Hs{static packed_rgba_8bit(t,e,s,r){return t<<24|e<<16|s<<8|r<<0}static unpack_rgba_8bit(t,e){return`
			const float cmult = 1.0 / float(0xff);
			const uint  cmask = uint(0xff);
			${t}.r = float((${e} >> 24) & cmask) * cmult;
			${t}.g = float((${e} >> 16) & cmask) * cmult;
			${t}.b = float((${e} >>  8) & cmask) * cmult;
			${t}.a = float((${e} >>  0) & cmask) * cmult;
		`}static packed_normal_10bit(t,e,s){return Math.round(t*511+511)<<0|Math.round(e*511+511)<<10|Math.round(s*511+511)<<20}static unpack_normal_10bit(t,e){return`
			const float nmult = 1.0 / float(0x1ff);
			const uint  noffs = uint(0x1ff);
			const uint  nmask = uint(0x3ff);
			${t}.x = float(((${e} >>  0) & nmask) - noffs) * nmult;
			${t}.y = float(((${e} >> 10) & nmask) - noffs) * nmult;
			${t}.z = float(((${e} >> 20) & nmask) - noffs) * nmult;
		`}}const Ir=new Kr({attribs:[{name:"pos",type:B.FLOAT,numComponents:3,normalize:!1},{name:"clr",type:B.UNSIGNED_INT,numComponents:1,normalize:!1}],uniforms:[{name:"mvp"}],vertSource:`#version 300 es
		in			vec4		pos;
		in			uint		clr;
		uniform		mat4		mvp;
		out			lowp vec4	fragclr;
		void main() {
			gl_Position = mvp * pos;
			${Hs.unpack_rgba_8bit("fragclr","clr")}
		}
	`,fragSource:`#version 300 es
		in			lowp vec4	fragclr;
		out			lowp vec4	outclr;
		void main() {
			outclr = fragclr;
		}
	`}),vo=new Kr({attribs:[{name:"pos",type:B.FLOAT,numComponents:3,normalize:!1},{name:"clr",type:B.UNSIGNED_INT,numComponents:1,normalize:!1},{name:"tex",type:B.FLOAT,numComponents:2,normalize:!1}],uniforms:[{name:"mvp"},{name:"texsampler"}],vertSource:`#version 300 es
		uniform			mat4	mvp;
		in				vec4	pos;
		in				uint	clr;
		in				vec2	tex;
		out		lowp	vec4	fragclr;
		out		highp	vec2	fragtex;
		void main() {
			gl_Position = mvp * pos;
			${Hs.unpack_rgba_8bit("fragclr","clr")}
			fragtex = tex;
		}
	`,fragSource:`#version 300 es
		uniform			sampler2D	texsampler;
		in		lowp	vec4		fragclr;
		in		highp	vec2		fragtex;
		out		lowp	vec4		outclr;
		void main() {
			outclr = fragclr * texture(texsampler, fragtex);
		}
	`}),go={CURSIVE:"cursive",COURIER:"courier",FANTASY:"fantasy",MATH:"math",MONO:"mono",MONOSPACE:"monospace",SANS:"sans",SERIF:"serif",SYSTEM_UI:"system-ui"},zr={NONE:"",BOLD:"bold",ITALIC:"italic",CAPS:"small-caps"},Ds={ALPHABETIC:"alphabetic",IDEAGRAPHIC:"ideagraphic",HANGING:"hanging",BOTTOM:"bottom",MIDDLE:"middle",TOP:"top"};class bo{constructor(t,e,s){const r=document.createElement("canvas"),n=r.getContext("2d");r.width=t,r.height=e,r.id=s,this.canvas=r,this.ctx=n}fillStyle(t){this.ctx.fillStyle=t}fillStyle_rgba(t,e,s,r){this.fillStyle(`rgba(${t*255},${e*255},${s*255},${r})`)}fillStyle_hex(t,e,s,r){this.fillStyle(`rgba(${t},${e},${s},${r/255})`)}lineWidth(t){this.ctx.lineWidth=t}lineStyle(t){this.ctx.strokeStyle=t}lineStyle_rgba(t,e,s,r){this.lineStyle(`rgba(${t*255},${e*255},${s*255},${r})`)}lineStyle_hex(t,e,s,r){this.lineStyle(`rgba(${t},${e},${s},${r/255})`)}fillRect(t,e,s,r){this.ctx.fillRect(t,e,s,r)}lineRect(t,e,s,r){this.ctx.strokeRect(t,e,s,r)}clearRect(t,e,s,r){this.ctx.clearRect(t,e,s,r)}path(t,e=!0){if(this.ctx.beginPath(),!(t.length<2)){this.ctx.moveTo(t[0],t[1]);for(let s=1;s<t.length;s++)this.ctx.lineTo(t[s*2+0],t[s*2+1]);e&&this.ctx.closePath()}}fillPath(t){this.path(t),this.ctx.fill()}linePath(t){this.path(t),this.ctx.stroke()}arc(t,e,s,r,n,i,c=!0){this.ctx.beginPath(),r*=2*Math.PI,n*=2*Math.PI,i&&(n=-n,r=-r),this.ctx.arc(t,e,s,r,n,i),this.ctx.closePath()}arcTo(t,e,s,r,n){this.ctx.arcTo(t,e,s,r,n)}fillArc(t,e,s,r,n,i,c=!0){this.arc(t,e,s,r,n,i,c),this.ctx.fill()}lineArc(t,e,s,r,n,i,c=!1){this.arc(t,e,s,r,n,i,c),this.ctx.stroke()}setFont(t,e,s=zr.NONE,r=Ds.TOP){this.ctx.font=`${t}px ${s} ${e}`,this.ctx.textBaseline=r}getTextWidth(t){return this.ctx.measureText(t).width}fillText(t,e,s){this.ctx.fillText(t,e,s)}lineText(t,e,s){this.ctx.strokeText(t,e,s)}getImageData(t,e,s,r){return this.ctx.getImageData(t,e,s,r)}putImageData(t,e=0,s=0){this.ctx.putImageData(t,e,s)}static getImageDataValue(t,e,s,r,n,i){return t[n*e*4+r*4+i]}toDataURL(){return this.canvas.toDataURL("image/png")}}class wo{constructor(){this.texCoords=new Float32Array(6)}get widthRatio(){return this.texCoords[2]/this.texCoords[3]*this.texCoords[5]}setTexCoords(t,e,s,r,n,i){this.texCoords.set([t,e,s,r,i,n/i],0)}}class yo{constructor(t,e,s,r,n){this.glContext=t,this.glyphmap=new Map,this.texBuffer=new po(t),this.height=s,this.family=r,this.style=n,this.initialize(e)}initialize(t){const e=[...t.keys()];this.glyphmap.clear();for(const p of e)this.glyphmap.set(p,new wo);const s=new bo(0,0,"FontEngine_initialize_canvas");s.setFont(this.height,this.family,this.style,Ds.BOTTOM);const r=Math.ceil(this.height*.1);let n=64,i=64,c=!1;for(;!c;){const p=this.height;let b=0,_=0,v=!1;for(const g of e){const w=s.getTextWidth(g);b+w>n&&(b=0,_+=p);const k=1/n,C=1/i;if(this.glyphmap.get(g).setTexCoords(b*k,_*C,w*k,p*C,n,i),w>n){v=!0;break}if(_+p>i){v=!0;break}b+=w+r}v?n<=i?n*=2:i*=2:c=!0}s.canvas.width=n,s.canvas.height=i,s.setFont(this.height,this.family,this.style,Ds.BOTTOM),s.fillStyle_hex(255,255,255,255),s.lineStyle_hex(255,255,255,127);for(const p of e){const b=this.glyphmap.get(p),_=b.texCoords[0]*n,v=b.texCoords[1]*i;s.fillText(p,_,i-v)}const h=s.getImageData(0,0,n,i),d=n*i,f=new Uint8Array(d*2);for(let p=0;p<d;p++)f[p*2+0]=h.data[p*4+0],f[p*2+1]=h.data[p*4+3];this.texBuffer.setTextureData(h.width,h.height,f,Ls.LUM_ALPHA,Ns.UNSIGNED_BYTE)}getRequiredGlyphs(t,e){for(let s=0;s<e.length;s++)this.glyphmap.has(e[s])||t.add(e[s])}addRequiredGlyphs(t){if(t.size<=0)return!1;const e=new Set(this.glyphmap.keys());for(const s of t.keys())e.add(s);return e.size>this.glyphmap.size?(console.debug("addRequiredGlyphs(charset)",t),this.initialize(e),!0):!1}getTotalWidth(t,e,s){let r=0;for(let n=0;n<t.length;n++){const i=t[n],c=this.glyphmap.get(i),h=e*c.widthRatio*s;r+=h}return r}generateVertexData3d(t,e,s,r,n,i,c,h,d,f){h=new Float32Array(h),h[0]+=r.x,h[1]+=r.y;const p=0,b=0,_=r.w,v=r.h,g=3,w=2,k=t.length*4*g,C=t.length*4*w,L=t.length*6;let I=new Float32Array(k),T=new Float32Array(C),N=new Uint32Array(L);const O=new Uint32Array([0,1,2,2,3,0]);let et=0,F=0,ut=0,K=p,J=v-e,vt=[];for(let at=0;at<t.length;at++){const st=t[at],lt=this.glyphmap.get(st),Ct=e*lt.widthRatio*s,Ht=e;if(K+Ct>_&c&&(vt.push(et,K,J),K=p,J-=e),st===`
`){vt.push(et,K,J),K=p,J-=e;continue}const[Rt,Bt,Ot,Wt]=lt.texCoords,Lt=et*g,Qt=F*w,he=ut;I.set([K+0,J+0,0,K+Ct,J+0,0,K+Ct,J+Ht,0,K+0,J+Ht,0],Lt),T.set([Rt+0,Bt+0,Rt+Ot,Bt+0,Rt+Ot,Bt+Wt,Rt+0,Bt+Wt],Qt);for(let _t=0;_t<6;_t++)N[he+_t]=O[_t]+et;et+=4,F+=4,ut+=6,K+=Ct}vt.push(et,K,J);let At=0,It=0;for(;It<vt.length;){const at=vt[It*3+0],st=vt[It*3+1];vt[It*3+2],It++;const lt=_-p,Ct=v-b,Ht=_-st,Rt=J,Bt=+n[0]*Ht-i[0]*lt,Ot=-n[1]*Rt-i[1]*Ct;for(;At<at;){const Wt=At*g;I[Wt+0]+=Bt,I[Wt+1]+=Ot,At++}}const $t=3;for(let at=0;at<et;at++){const st=I[at*$t+0],lt=I[at*$t+1],Ct=at*$t;I[Ct+0]=h[0]+d[0]*st+f[0]*lt,I[Ct+1]=h[1]+d[1]*st+f[1]*lt,I[Ct+2]=h[2]+d[2]*st+f[2]*lt}return{vdata:I,vcount:et,tdata:T,tcount:F,idata:N,icount:ut}}}const Cr=l=>l===B.FLOAT?Float32Array.BYTES_PER_ELEMENT:l===B.UNSIGNED_INT?Uint32Array.BYTES_PER_ELEMENT:l===B.UNSIGNED_SHORT?Uint16Array.BYTES_PER_ELEMENT:l===B.UNSIGNED_BYTE?Uint8Array.BYTES_PER_ELEMENT:l===B.INT?Int32Array.BYTES_PER_ELEMENT:l===B.SHORT?Int16Array.BYTES_PER_ELEMENT:l===B.BYTE?Int8Array.BYTES_PER_ELEMENT:0,ko=l=>l===Float32Array?B.FLOAT:l===Uint32Array?B.UNSIGNED_INT:l===Uint16Array?B.UNSIGNED_SHORT:l===Uint8Array?B.UNSIGNED_BYTE:l===Int32Array?B.INT:l===Int16Array?B.SHORT:l===Int8Array?B.BYTE:B.NONE,To=l=>[B.UNSIGNED_INT,B.UNSIGNED_SHORT,B.UNSIGNED_BYTE,B.INT,B.SHORT,B.BYTE].includes(l),Ss={TRIANGLES:B.TRIANGLES,TRIANGLE_STRIP:B.TRIANGLE_STRIP,TRIANGLE_FAN:B.TRIANGLE_FAN,LINES:B.LINES,LINE_STRIP:B.LINE_STRIP,LINE_LOOP:B.LINE_LOOP,POINTS:B.POINTS},Eo=1,xo=3e7;class yt{static reset(){for(const[t,e]of this.timings.entries())this.timings.set(t,this.timings.get(t)*.98);for(const[t,e]of this.counts.entries())this.counts.set(t,0)}static increment_time(t,e){const s=this.timings.has(t)?this.timings.get(t):0;this.timings.set(t,s+e*.02)}static increment_count(t,e){const s=this.counts.has(t)?this.counts.get(t):0;this.counts.set(t,s+e)}static log(t){const e=this.timings.get(t);console.log(`${t}`,e)}static log_all(){let t="";for(const[e,s]of this.timings.entries())t+=`time : ${e}	${s.toFixed(3)}
`;for(const[e,s]of this.counts.entries())t+=`count: ${e}	${s}
`;console.log(t)}}R(yt,"timings",new Map),R(yt,"counts",new Map);const Is=4294967295,So=0;class Yr{constructor(t){R(this,"_renderBlock_cache",new bt(()=>this._renderBlock()));R(this,"DEPTH_ON_TOP",33);const e=t.getContext("webgl2",{alpha:!0,antialias:!0});if(e===null){alert("Unable to initialize WebGL2. Your browser or machine may not support it.");return}this.canvas=t,this.gl=e,e.viewport(0,0,t.width,t.height),e.clearColor(0,0,0,1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.clearDepth(1),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),t.style.background="unset";const s=this.camera=new mo,{width:r,height:n}=t.getClientRects()[0];s.setAspectRatio(r,n),this.matrixMVP=Rs();{const i=this.triangles_config=Ir,c=ks.DYNAMIC_DRAW,h=new Ts(e,Uint32Array,0,c),d=new ue(e,Float32Array,0,c,i,["pos"]),f=new ue(e,Uint32Array,0,c,i,["clr"]);this.triangles_shader=new Fe(e,i,[d,f],h,Ss.TRIANGLES),this.triangles_buffer_ind=h,this.triangles_buffer_pos=d,this.triangles_buffer_clr=f}{const i=this.lines_config=Ir,c=ks.DYNAMIC_DRAW,h=new Ts(e,Uint32Array,0,c),d=new ue(e,Float32Array,0,c,i,["pos"]),f=new ue(e,Uint32Array,0,c,i,["clr"]);this.lines_shader=new Fe(e,i,[d,f],h,Ss.LINES),this.lines_buffer_ind=h,this.lines_buffer_pos=d,this.lines_buffer_clr=f}{const i=this.font_config=vo,c=ks.DYNAMIC_DRAW,h=new Ts(e,Uint32Array,0,c),d=new ue(e,Float32Array,0,c,i,["pos"]),f=new ue(e,Uint32Array,0,c,i,["clr"]),p=new ue(e,Float32Array,0,c,i,["tex"]);this.font_shader=new Fe(e,i,[d,f,p],h,Ss.TRIANGLES),this.font_buffer_ind=h,this.font_buffer_pos=d,this.font_buffer_clr=f,this.font_buffer_tex=p;const b="",_=new Set(b);this.fontRenderer_0=new yo(e,_,60,go.SERIF,zr.NONE)}}render(){this.clear_buffers();const t=Date.now(),e=this.renderBlock;if(!e)throw"!renblock";const s=Date.now();this.drawBlock(e,e.get_render_data_block(x.blockLibrary.rootBlock),So),this.drawCursor(),x.gameUI.cursor_isSelecting&&this.drawDragArea(),this.drawSelection(),this.drawPreviewCell(),this.drawPreviewLink(),this.drawPreviewBlock(),this.drawHovered();const r=Date.now();this.commit_buffers();const n=this.triangles_shader.glContext;n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);const i=this.matrixMVP;jr(i),this.camera.applyCameraMatrix(i),this.triangles_shader.setUniform_mat4fv(n,"mvp",i),this.lines_shader.setUniform_mat4fv(n,"mvp",i),this.font_shader.setUniform_mat4fv(n,"mvp",i),this.font_shader.setUniform_texbuf(n,"texsampler",this.fontRenderer_0.texBuffer),this.triangles_shader.drawElements(),this.lines_shader.drawElements(),this.font_shader.drawElements();const c=Date.now();yt.increment_time("render.update",s-t),yt.increment_time("render.gather",r-s),yt.increment_time("render.draw",c-r)}clear_buffers(){this.triangles_buffer_ind.clear(),this.triangles_buffer_pos.clear(),this.triangles_buffer_clr.clear(),this.lines_buffer_ind.clear(),this.lines_buffer_pos.clear(),this.lines_buffer_clr.clear(),this.font_buffer_ind.clear(),this.font_buffer_pos.clear(),this.font_buffer_clr.clear(),this.font_buffer_tex.clear();const t=Eo;let e,s;e=this.triangles_buffer_clr,s=t*e.vertexLength,e.reserveAndPushData(new Uint32Array(s),0,s),e=this.lines_buffer_clr,s=t*e.vertexLength,e.reserveAndPushData(new Uint32Array(s),0,s),e=this.font_buffer_clr,s=t*e.vertexLength,e.reserveAndPushData(new Uint32Array(s),0,s)}commit_buffers(){this.triangles_buffer_ind.commitNewDataToBuffer(),this.triangles_buffer_pos.commitNewDataToBuffer(),this.triangles_buffer_clr.commitNewDataToBuffer(),this.lines_buffer_ind.commitNewDataToBuffer(),this.lines_buffer_pos.commitNewDataToBuffer(),this.lines_buffer_clr.commitNewDataToBuffer(),this.font_buffer_ind.commitNewDataToBuffer(),this.font_buffer_pos.commitNewDataToBuffer(),this.font_buffer_clr.commitNewDataToBuffer(),this.font_buffer_tex.commitNewDataToBuffer()}transform_vdata(t,e,s,r,n){t&&t.apply(s,r,n,3);const i=e*-.01;for(let c=r+2;c<n;c+=3)s[c]+=i}triangles_reserve(t,e,s){this.triangles_buffer_ind.reserve(t),this.triangles_buffer_pos.reserve(e),this.triangles_buffer_clr.reserve(s)}triangles_push(t,e,s){this.triangles_buffer_ind.pushData(t,0,t.length,this.triangles_buffer_pos.vertexCount),this.triangles_buffer_pos.pushData(e,0,e.length),this.triangles_buffer_clr.pushData(s,0,s.length)}triangles_transform(t,e,s){const r=this.triangles_buffer_pos,n=r.writePos-s,i=r.writePos;this.transform_vdata(t,e,r.data,n,i)}lines_reserve(t,e,s){this.lines_buffer_ind.reserve(t),this.lines_buffer_pos.reserve(e),this.lines_buffer_clr.reserve(s)}lines_push(t,e,s){this.lines_buffer_ind.pushData(t,0,t.length,this.lines_buffer_pos.vertexCount),this.lines_buffer_pos.pushData(e,0,e.length),this.lines_buffer_clr.pushData(s,0,s.length)}lines_transform(t,e,s){const r=this.lines_buffer_pos,n=r.writePos-s,i=r.writePos;this.transform_vdata(t,e,r.data,n,i)}_renderBlock(){const t=x.blockLibrary.rootBlock,e=new me;ie.get_content_transformation(t,e);const s=0;return new ie(null,t,e,s,x.maxDrawDepth)}get renderBlock(){return this._renderBlock_cache.value}tri_rects_reserve(t){const e=t*6,s=t*4*3,r=t*4;this.triangles_reserve(e,s,r)}tri_rects_write(t,e){const[s,r,n,i]=t,c=[0,1,2,2,3,0],h=[s+0,r+0,0,s+n,r+0,0,s+n,r+i,0,s+0,r+i,0],d=[e,e,e,e];this.triangles_push(c,h,d)}tri_rects_transform(t,e,s){this.triangles_transform(e,s,t*4*3)}tri_rects_push(t,e,s,r){this.tri_rects_reserve(1),this.tri_rects_write(s,r),this.tri_rects_transform(1,t,e)}line_rects_reserve(t){const e=t*8,s=t*4*3,r=t*4;this.lines_reserve(e,s,r)}line_rects_write(t,e){const[s,r,n,i]=t,c=[0,1,1,2,2,3,3,0],h=[s+0,r+0,0,s+n,r+0,0,s+n,r+i,0,s+0,r+i,0],d=[e,e,e,e];this.lines_push(c,h,d)}line_rects_transform(t,e,s){this.lines_transform(e,s,t*4*3)}line_rects_push(t,e,s,r){this.line_rects_reserve(1),this.line_rects_write(s,r),this.line_rects_transform(1,t,e)}transform_and_push_lines(t,e,s,r,n){this.transform_vdata(t,e,r,0,r.length);const i=this.lines_buffer_pos.vertexCount;this.lines_buffer_ind.reserveAndPushData(s,0,s.length,i),this.lines_buffer_pos.reserveAndPushData(r,0,r.length),this.lines_buffer_clr.reserveAndPushData(n,0,n.length)}transform_and_push_font(t,e,s,r,n,i){this.transform_vdata(t,e,r,0,r.length);const c=this.font_buffer_pos.vertexCount;this.font_buffer_ind.reserveAndPushData(s,0,s.length,c),this.font_buffer_pos.reserveAndPushData(r,0,r.length),this.font_buffer_clr.reserveAndPushData(n,0,n.length),this.font_buffer_tex.reserveAndPushData(i,0,i.length)}push_content_line(t,e,s,r,n){const i=[0,1],c=[s[0],s[1],0,r[0],r[1],0],h=[n,n];this.transform_and_push_lines(t,e,i,c,h)}push_content_line_grid(t,e,s,r,n,i){n=Math.floor(n),i=Math.floor(i);const[c,h,d,f]=s,p=2*(n+1)+2*(i+1),b=new Array(p),_=new Array(p*3),v=new Array(p).fill(r);for(let I=0;I<p;I++)b[I]=I;let g=0,w=c;const k=d/n;for(let I=0;I<=n;I++)_[g+0]=w,_[g+1]=h+0,_[g+2]=0,_[g+3]=w,_[g+4]=h+f,_[g+5]=0,w+=k,g+=6;let C=h;const L=f/i;for(let I=0;I<=i;I++)_[g+0]=c+0,_[g+1]=C,_[g+2]=0,_[g+3]=c+d,_[g+4]=C,_[g+5]=0,C+=L,g+=6;this.transform_and_push_lines(t,e,b,_,v)}push_content_line_circle(t,e,s,r,n,i,c){const h=new Array(i*2),d=new Array(i*3),f=new Array(i).fill(c);for(let _=0;_<i;_++)h[_*2+0]=_,h[_*2+1]=_+1;h[i*2-1]=0;let p=0,b=Math.PI*2/(i-1);for(let _=0;_<i;_++)d[_*3+0]=Math.cos(p)*n+s,d[_*3+1]=Math.sin(p)*n+r,d[_*3+2]=0,p+=b;this.transform_and_push_lines(t,e,h,d,f)}push_content_text_box(t,e,s,r,n,i,c,h,d){const f=this.fontRenderer_0,p=new Set;f.getRequiredGlyphs(p,s),f.addRequiredGlyphs(p);const b=1,_=[0,0,0],v=[1,0,0],g=[0,1,0];let{vdata:w,vcount:k,idata:C,icount:L,tdata:I}=f.generateVertexData3d(s,r,b,i,c,h,d,_,v,g);const T=new Array(k).fill(n);this.transform_and_push_font(t,e,C,w,T,I)}push_content_text_box_against_circle(t,e,s,r,n,i,c){const h=this.fontRenderer_0,d=new Set;h.getRequiredGlyphs(d,s),h.addRequiredGlyphs(d);const f=1,p=r,b=h.getTotalWidth(s,r,f),_=!1,[v,g]=i,w=[1-((v-.5)*c+.5),1-((g-.5)*c+.5)],k=[.5,.5],C=new os(v,g,b,p),L=[0,0,0],I=[1,0,0],T=[0,1,0];let{vdata:N,vcount:O,idata:et,icount:F,tdata:ut}=h.generateVertexData3d(s,r,f,C,k,w,_,L,I,T);const K=new Array(O).fill(n);this.transform_and_push_font(t,e,et,N,K,ut)}valueToHex_u32(t,e){const s=t.toString(16).toUpperCase();let r="0x";for(let n=s.length;n<e;n++)r+="0";return r+s}hexColour_scale(t,e){return(t>>24&255)*e<<24|(t>>16&255)*e<<16|(t>>8&255)*e<<8|(t>>0&255)*1<<0}drawCell(t,e,s=Is){const{cell:r,tran:n,numTargets:i}=e,c=t.depth,h=[r.value,0,0];s!==Is&&(h[0]=x.gameServer.simulation_get_cell_value(r.id,s,0),h[1]=x.gameServer.simulation_get_cell_value(r.id,s,1),h[2]=x.gameServer.simulation_get_cell_value(r.id,s,2));const d=[0,0,0,4293840127,4293840127,4293840127],f=r.clr,p=this.hexColour_scale(f,.5);for(let g=0;g<3;g++)d[g]=h[g]?f:p;const b=3+i;this.tri_rects_reserve(b);for(let g=0;g<b;g++)this.tri_rects_write(ie.CELL_RECTS[g],d[g]);if(this.tri_rects_transform(b,n,c),c>=2)return;const _=x.gameUI.collectionSelected.cells.has(r)|t.is_selected,v=x.gameUI.collectionHovered.cells.has(r)|t.is_hovered;if(_|v|t.is_selected|t.is_hovered){const g=c+1,w=.3,k=4294967295,C=1.2;{const I=r.typeString,T=k,N=[.5,1];this.push_content_text_box_against_circle(n,g,I,w,255,N,C),this.push_content_text_box_against_circle(n,g,I,w,T,N,C)}const L=["OUT:","A:","B:"];for(let I=0;I<i;I++){const T=L[I]+this.valueToHex_u32(h[I],8),N=k&(h[I]===0?2004318207:4294967295),O=[ie.LINK_POINTS_F32[I*3+0],ie.LINK_POINTS_F32[I*3+1]];this.push_content_text_box_against_circle(n,g,T,w,255,O,C),this.push_content_text_box_against_circle(n,g,T,w,N,O,C)}}}drawLink(t,e){const{link:s,p0:r,p1:n}=e,i=t.depth;this.push_content_line(null,i+1,r,n,s.clr)}drawLink_alt(t,e,s,r=0){this.push_content_line(null,r+1,t,e,s)}drawText(t,e){const{text:s,tran:r}=e,n=t.depth;{const i=s.str,c=s.dimensions,h=s.fclr,d=s.fhgt;VerificationUtil.verifyObjectEntriesDefined({str:i,dim:c,fontColour:h,fontHeight:d});const f=new os(c.x,c.y,c.w,c.h),p=[0,0],b=[0,0];this.push_content_text_box(r,n,i,d,h,f,p,b,!0)}}drawBlockPlaceholder(t,e){const{block:s,tran:r}=e,n=t.depth;this.tri_rects_push(r,n,[0,0,1,1],51),this.line_rects_push(r,n,[0,0,1,1],2007695257)}drawBlock(t,e,s=Is){const r=Date.now();t.is_hovered=x.gameUI.collectionHovered.blocks.has(t.block),t.is_selected=x.gameUI.collectionSelected.blocks.has(t.block);{const{block:d,tran:f}=e,p=t.depth-.5,b=t.itemTran;if(this.tri_rects_push(b,p,[0,0,1,1],51),t.depth===0){const _=d.templateWidth,v=d.templateHeight;this.push_content_line_grid(b,p,[0,0,1,1],2007695257,_,v)}else this.line_rects_push(b,p,[0,0,1,1],2007695257)}const n=Date.now();for(const d of t.render_data_texts)this.drawText(t,d);const i=Date.now();for(const d of t.render_data_cells)this.drawCell(t,d,s);const c=Date.now();for(const d of t.render_data_links)this.drawLink(t,d);const h=Date.now();for(const d of t.render_data_blocks){const f=t.children.get(d.block.id),p=x.gameServer.simulation_get_child_simblock(d.block.id,s);f?this.drawBlock(f,d,p):this.drawBlockPlaceholder(t,d)}yt.increment_time("render.gather.block",n-r),yt.increment_time("render.gather.texts",i-n),yt.increment_time("render.gather.cells",c-i),yt.increment_time("render.gather.links",h-c)}drawPreviewCell(){const t=x.gameUI.get_render_preview_cell();if(!t)return;const e=this.renderBlock;this.drawCell(e,e.get_render_data_cell(t))}drawPreviewBlock(){const t=x.gameUI.get_render_preview_block();if(!t)return;const e=this.renderBlock,s=e.contentTran,r=e.depth+1,n=e.depth+2,i=new ie(e,t,s,r,n);this.drawBlock(i,i.get_render_data_block(t))}drawPreviewLink(){const t=x.gameUI.get_link_draw_points(),e=x.gameUI.get_wire_colour();for(const s of t){const n=this.DEPTH_ON_TOP;this.push_content_line_circle(null,n,s[0],s[1],.2,20,e)}t.length>=2&&this.drawLink_alt(t[0],t[1],e,0)}drawCursor(){const e=this.DEPTH_ON_TOP,s=Hs.packed_rgba_8bit(255,255,111,255),r=x.gameUI.cursor_pos,n=x.gameUI.cursor_radius;this.push_content_line_circle(null,e,r[0],r[1],n,30,s)}drawDragArea(){const[t,e,s,r]=x.gameUI.cursor_dragAABB,n=null,i=this.DEPTH_ON_TOP,c=[t,e,s-t,r-e];this.tri_rects_push(n,i,c,4294967125)}pushSelectionRectangles(t,e,s){const r=this.renderBlock,n=this.DEPTH_ON_TOP;for(const i of t.cells){const c=r.item_trans.get(i.id);this.line_rects_push(c,n,e,s)}for(const i of t.texts){const c=r.item_trans.get(i.id);this.line_rects_push(c,n,e,s)}for(const i of t.blocks){const c=r.item_trans.get(i.id);this.line_rects_push(c,n,e,s)}}drawSelection(){const e=[-.03,-.03,1.06,1.06];this.pushSelectionRectangles(x.gameUI.collectionSelected,e,4294923775)}drawHovered(){const e=[0,0,1,1];this.pushSelectionRectangles(x.gameUI.collectionHovered,e,2865561599)}}R(Yr,"DEPTH_ON_TOP",33);class Io{constructor(){this.handlers=new Map,this.keydown_curr=new Map,this.keydown_prev=new Map,this.keydown_delta=new Map,this.keydown_event=null,this.button_curr=new Map,this.button_prev=new Map,this.button_delta=new Map,this.button_event=null,this.cursor_curr=[0,0],this.cursor_prev=[0,0],this.cursor_delta=[0,0],this.cursor_event=null,this.wheel_curr=[0,0],this.wheel_prev=[0,0],this.wheel_delta=[0,0],this.wheel_event=null,this.dragbeg_pos=[0,0],this.dragend_pos=[0,0],this.dragbeg_event=null,this.dragend_event=null,this.dragbeg_event_prev=null,this.dragend_event_prev=null,this.dragbeg_event_delta=0,this.dragend_event_delta=0,this.addInputHandler("mousemove","default",t=>this.defaultHandler_mousemove.call(this,t)),this.addInputHandler("mousedown","default",t=>this.defaultHandler_mousedown.call(this,t)),this.addInputHandler("mouseup","default",t=>this.defaultHandler_mouseup.call(this,t)),this.addInputHandler("wheel","default",t=>this.defaultHandler_wheel.call(this,t)),this.addInputHandler("keydown","default",t=>this.defaultHandler_keydown.call(this,t)),this.addInputHandler("keyup","default",t=>this.defaultHandler_keyup.call(this,t))}updateInputDeltas(){for(const t of this.keydown_curr.keys()){const e=this.keydown_curr.get(t)?1:0,s=this.keydown_prev.get(t)?1:0,r=e-s;this.keydown_delta.set(t,r),this.keydown_prev.set(t,e)}for(const t of this.button_curr.keys()){const e=this.button_curr.get(t)?1:0,s=this.button_prev.get(t)?1:0,r=e-s;this.button_delta.set(t,r),this.button_prev.set(t,e)}for(let t=0;t<this.cursor_curr.length;t++)this.cursor_delta[t]=this.cursor_curr[t]-this.cursor_prev[t],this.cursor_prev[t]=this.cursor_curr[t];for(let t=0;t<this.wheel_curr.length;t++)this.wheel_delta[t]=this.wheel_curr[t]-this.wheel_prev[t],this.wheel_prev[t]=this.wheel_curr[t];this.dragbeg_event_delta=(this.dragbeg_event&!this.dragbeg_event_prev?1:0)-(!this.dragbeg_event&this.dragbeg_event_prev?1:0),this.dragend_event_delta=(this.dragend_event&!this.dragend_event_prev?1:0)-(!this.dragend_event&this.dragend_event_prev?1:0),this.dragbeg_event_prev=this.dragbeg_event,this.dragend_event_prev=this.dragend_event}clearInputEvents(){this.keydown_event=null,this.button_event=null,this.cursor_event=null,this.wheel_event=null,this.dragbeg_event=null,this.dragend_event=null}getKeydown(t){const e=this.keydown_curr;return e.get(t)||e.get(t.toLowerCase())||e.get(t.toUpperCase())}getKeydownDelta(t){const e=this.keydown_delta;return e.get(t)||e.get(t.toLowerCase())||e.get(t.toUpperCase())}addInputHandler(t,e,s){this.handlers.has(t)||this.handlers.set(t,new Map);const r=this.handlers.get(t);return r.has(e)&&this.removeInputHandler(t,e),window.addEventListener(t,s),r.set(e,s),!0}removeInputHandler(t,e){const s=this.handlers.get(t);if(!s)return!1;const r=s.get(e);return r?(window.removeEventListener(t,r),s.delete(e),!0):!1}defaultHandler_mousemove(t){const{clientX:e,clientY:s}=t;this.cursor_curr[0]=e,this.cursor_curr[1]=s}defaultHandler_mousedown(t){const{button:e}=t;this.button_event=t,this.button_curr.set(e,!0),this.dragbeg_pos[0]=this.cursor_curr[0],this.dragbeg_pos[1]=this.cursor_curr[1],this.dragbeg_event=t}defaultHandler_mouseup(t){const{button:e}=t;this.button_event=t,this.button_curr.set(e,!1),this.dragbeg_pos[0]!==this.cursor_curr[0]|this.dragbeg_pos[1]!==this.cursor_curr[1]&&(this.dragend_event=t),this.dragend_pos[0]=this.cursor_curr[0],this.dragend_pos[1]=this.cursor_curr[1]}defaultHandler_wheel(t){const{wheelDeltaX:e,wheelDeltaY:s}=t;this.wheel_event=t,this.wheel_curr[0]=-e,this.wheel_curr[1]=-s}defaultHandler_keydown(t){const{key:e}=t;this.keydown_event=t,this.keydown_curr.set(e.toLowerCase(),!0)}defaultHandler_keyup(t){const{key:e}=t;this.keydown_event=t,this.keydown_curr.set(e.toLowerCase(),!1)}}class He{constructor(){this.cells=new Set,this.texts=new Set,this.blocks=new Set}count(){return this.cells.size+this.texts.size+this.blocks.size}clear(){this.cells.clear(),this.texts.clear(),this.blocks.clear()}addFromCollection(t){for(const e of t.cells)this.cells.add(e);for(const e of t.texts)this.texts.add(e);for(const e of t.blocks)this.blocks.add(e)}addFirstComponentFromCollection(t){for(const e of t.texts){this.texts.add(e);return}for(const e of t.blocks){this.blocks.add(e);return}for(const e of t.cells){this.cells.add(e);return}}getFirstComponentFromCollection(){for(const t of this.texts)return t;for(const t of this.blocks)return t;for(const t of this.cells)return t}intersection(t){const e=new He;for(const s of this.cells)t.cells.has(s)&&e.cells.add(s);for(const s of this.texts)t.texts.has(s)&&e.texts.add(s);for(const s of this.blocks)t.blocks.has(s)&&e.blocks.add(s);return e}}class Q{constructor(t,e,s,r,n){this.id=t,this.label=e,this.type=s,this.initial=r,this.oninput=n}get_parsed_input(){const t=document.getElementById(this.id);return Ws(t.value,this.type)}}const G={u32:1,u8:2,f32:3,dim:4,str:5,name:6};function Ws(l,t){if(t===G.u32)return Co(l);if(t===G.u8)return Po(l);if(t===G.f32)return Ao(l);if(t===G.dim)return $s(l);if(t===G.str)return Xr(l);if(t===G.name)return qr(l)}function Co(l){let t=Number(l),e=!0;return!Number.isInteger(t)|t<0|4294967295<t&&(e=!1),[t,e]}function Po(l){let t=Number(l),e=!0;return!Number.isInteger(t)|t<0|255<t&&(e=!1),[t,e]}function Ao(l){let t=Number(l),e=!0;return Number.isNaN(t)&&(e=!1),[t,e]}function $s(l){let t=Number(l),e=!0;return Number.isNaN(t)|t<=0&&(e=!1),[t,e]}function Xr(l){return[l,!0]}function qr(l){let t=l,e=l.length>0;return[t,e]}class Ro{constructor(){R(this,"MODES",{FILE:"File",SELECT:"Select",SET_VALUES:"Outputs",PLACE_CELLS:"Cells",PLACE_LINKS:"Links",PLACE_BLOCKS:"Blocks",ROOT_BLOCK:"Template"});R(this,"currentMode",this.MODES.SELECT);R(this,"setCurrentMode_callback",null);R(this,"elementMap",new Map);R(this,"isCanvasHovered",!0);R(this,"listener_window_onresize",null);R(this,"listener_canvas_onmouseenter",null);R(this,"listener_canvas_onmouseleave",null);R(this,"listener_canvas_contextmenu",null);R(this,"canvas",null);R(this,"show_tooltip_callback",null);R(this,"hide_tooltip_callback",null);R(this,"show_popup_callback",null);R(this,"hide_popup_callback",null);R(this,"header_btn_play",null);R(this,"place_dim_cell",[1,1,0]);R(this,"place_dim_block",[1,1,0]);R(this,"place_preview_cell",null);R(this,"place_preview_block",null);R(this,"cursor_isSelecting",!1);R(this,"cursor_isTranslating",!1);R(this,"cursor_radius",.5);R(this,"cursor_snap",.5);R(this,"cursor_pos",new ft);R(this,"cursor_dragBeg",new ft);R(this,"cursor_dragEnd",new ft);R(this,"cursor_dragAABB",new Float32Array(4));R(this,"translate_start",new ft);R(this,"translate_prev",new ft);R(this,"translate_curr",new ft);R(this,"collectionSelected",new He);R(this,"collectionHovered",new He);R(this,"collectionTranslating",new He);R(this,"info_select",["(Hotkey: x)","- Select items by clicking them, or by dragging to select all items in drag-area.","- Delete selected items by pressing 'DELETE' key.","- Move selected items by hovering over any selected item, then clicking and dragging cursor."].join(`
`));R(this,"table_select_cells",{title:"Cells",style:"width: 120px;",inputs:[new Q("tselcv","initial value",G.u32,0,this.oninput_select_c_v),new Q("tselcw","width",G.dim,1,this.oninput_select_c_w),new Q("tselch","height",G.dim,1,this.oninput_select_c_h),new Q("tselcr","rotation (deg)",G.f32,0,this.oninput_select_c_r)]});R(this,"table_select_blocks",{title:"Blocks",style:"width: 120px;",inputs:[new Q("tselbw","width",G.dim,1,this.oninput_select_b_w),new Q("tselbh","height",G.dim,1,this.oninput_select_b_h),new Q("tselbr","rotation (deg)",G.f32,0,this.oninput_select_b_r)]});R(this,"setval_value_lmb",4294967295);R(this,"setval_value_rmb",0);R(this,"info_setval",["(Hotkey: v)","- Set the output value of cells by hovering over them while the left or right mouse-button is down."].join(`
`));R(this,"table_setval",{title:"Set cell values",style:"width: 120px;",inputs:[new Q("tsetvl","value (LMB)",G.u32,"0xFFFFFFFF",this.oninput_setval_lmb),new Q("tsetvr","value (RMB)",G.u32,"0x00000000",this.oninput_setval_rmb)]});R(this,"info_place_cells",["(Hotkey: c)","- To place cells, click one of the cell types (ex: XOR), then clicking on canvas."].join(`
`));R(this,"table_place_cells",{title:"Cell properties",style:"width: 120px;",inputs:[new Q("tpcw","width",G.dim,"1",this.oninput_cell_w),new Q("tpch","height",G.dim,"1",this.oninput_cell_h),new Q("tpcr","rotation (deg)",G.f32,"0",this.oninput_cell_r)]});R(this,"wire_buttonStep",0);R(this,"wire_cell_targets",[]);R(this,"wire_cell_target_nearest",null);R(this,"wire_target1",null);R(this,"wire_target2",null);R(this,"wire_colour_r",255);R(this,"wire_colour_g",255);R(this,"wire_colour_b",200);R(this,"info_place_links",["(Hotkey: l)","- To place links, click near desired input/output of first cell,","then click again near desired output/input of second cell.","- To remove links, hold down the right mouse button and drag across them."].join(`
`));R(this,"table_place_links",{title:"Link properties",style:"width: 120px;",inputs:[new Q("tplr","red",G.u8,this.wire_colour_r,this.oninput_link_colour_r),new Q("tplg","green",G.u8,this.wire_colour_g,this.oninput_link_colour_g),new Q("tplb","blue",G.u8,this.wire_colour_b,this.oninput_link_colour_b)]});R(this,"info_place_blocks",["(Hotkey: b)","- To place blocks, click the block's name in the list of available block-templates.","- To edit a block, click the 'Edit' button beside the desired block's name.","- To remove a block-template, click the 'X' button beside the desired block's name."].join(`
`));R(this,"table_place_blocks",{title:"Block properties",style:"width: 120px;",inputs:[new Q("tpbw","width",G.dim,"1",this.oninput_block_w),new Q("tpbh","height",G.dim,"1",this.oninput_block_h),new Q("tpbr","rotation (deg)",G.f32,"0",this.oninput_block_r)]});R(this,"update_template_list_callback",null);R(this,"info_root_template",["- To modify properties of the current block-template, edit the desired fields, then press 'Submit'.","- To reset fields, press 'Cancel'."].join(`
`));R(this,"input_root_template_name",{style:"width: 150px;",input:new Q("trnm","Name",G.name,"_",this.empty_handler)});R(this,"input_root_template_desc",{style:"width: 150px; height: 80px;",input:new Q("trds","Description",G.str,"_",this.empty_handler)});R(this,"table_root_template",{title:"Properties",style:"width: 150px;",inputs:[new Q("triw","internal width",G.dim,"8",this.empty_handler),new Q("trih","internal height",G.dim,"8",this.empty_handler),new Q("trew","default block width",G.dim,"2",this.empty_handler),new Q("treh","default block height",G.dim,"2",this.empty_handler)]});R(this,"info_file_export",["- To create a new block, click 'New Block', then fill in block details.","- To import block-templates, paste text into text-area below 'Import' button, then press 'Import' button.","- To export block-templates, press 'Export' button. This will put a text representation of all loaded block-templates into the text-area below."].join(`
`));R(this,"input_file_export_exp",{style:"width: 150px; height: 80px; margin-top: 5px;",input:new Q("fexp","",G.str,"",this.empty_handler)});R(this,"input_file_export_imp",{style:"width: 150px; height: 80px; margin-top: 5px;",input:new Q("fimp","",G.str,"",this.empty_handler)})}init(){this.input=new Io}setCurrentMode(t){console.log("GameUI_v2.setCurrentMode(mode)",t),t===this.MODES.ROOT_BLOCK&&(t=this.MODES.SELECT),t===this.MODES.FILE&&(t=this.MODES.SELECT),this.currentMode=t,ys.tryUntilTruthy(()=>this.setCurrentMode_callback,[],100,20).then(e=>e(t)).catch(()=>console.error("failed to call setCurrentMode_callback"))}get buttonDownL(){return this.input.button_prev.get(0)}get buttonDownR(){return this.input.button_prev.get(2)}get clickDeltaL(){return this.input.button_delta.get(0)}get clickDeltaR(){return this.input.button_delta.get(2)}get dragBegan(){return this.clickDeltaL===1&&this.isCanvasHovered&&this.isCanvasActive}get dragEnded(){return this.clickDeltaL===-1&&this.isCanvasHovered&&this.isCanvasActive}update(){const t=x.gameRenderer.camera,e=this.input;e.updateInputDeltas();const[s,r]=e.cursor_curr,{x:n,y:i,width:c,height:h}=this.getCanvas().getClientRects()[0];let d=Math.min(Math.max((s-n)/c,0),1),f=Math.min(Math.max((r-i)/h,0),1);d=(d*2-1)*1*t.aspectRatio,f=(f*2-1)*-1;const p=[d,f],b=new ft(t.pos.slice()),_=new ft(t.getRayDirection(p)),v=new ft([0,0,0]),g=new ft([1,0,0]),w=new ft([0,1,0]),[k,C]=Ft.collision_line_plane_3d(b,_,v,g,w);if(this.cursor_pos.set(C,0),this.dragBegan&&this.cursor_dragBeg.set(this.cursor_pos,0),this.buttonDownL){this.cursor_dragEnd.set(this.cursor_pos,0);const L=new Float32Array([...this.cursor_dragBeg,...this.cursor_dragEnd]);this.cursor_dragAABB.set(Ft.get_AABB_from_points_2d(L,0,6,3),0)}this.updateHoveredItems(),this.currentMode===this.MODES.SELECT?this.update_mode_select():(this.collectionSelected.clear(),this.collectionTranslating.clear(),this.cursor_isSelecting=!1,this.cursor_isTranslating=!1),this.currentMode===this.MODES.SET_VALUES&&this.update_mode_setval(),this.currentMode===this.MODES.PLACE_CELLS&&this.update_mode_place_cells(),this.currentMode===this.MODES.PLACE_LINKS?this.update_mode_place_links():this.wire_buttonStep=0,this.currentMode===this.MODES.PLACE_BLOCKS?this.update_mode_place_blocks():this.place_preview_block=null,this.update_hotkeys(),this.input.clearInputEvents()}update_hotkeys(){const t=!this.isInputElementActive,e=this.input,s=x.gameRenderer.camera;if(t&e.getKeydownDelta("p")===1&&this.onclick_toggle_play(this.header_btn_play,!0),t&e.getKeydownDelta("x")===1&&this.setCurrentMode(this.MODES.SELECT),t&e.getKeydownDelta("v")===1&&this.setCurrentMode(this.MODES.SET_VALUES),t&e.getKeydownDelta("c")===1&&this.setCurrentMode(this.MODES.PLACE_CELLS),t&e.getKeydownDelta("l")===1&&this.setCurrentMode(this.MODES.PLACE_LINKS),t&e.getKeydownDelta("b")===1&&this.setCurrentMode(this.MODES.PLACE_BLOCKS),t){const r=e.getKeydown("w")|e.getKeydown("ArrowUp"),n=e.getKeydown("a")|e.getKeydown("ArrowLeft"),i=e.getKeydown("s")|e.getKeydown("ArrowDown"),c=e.getKeydown("d")|e.getKeydown("ArrowRight"),h=(e.getKeydown("shift")?.5:5)*s.FOV;r&&s.move(0,+h,0),i&&s.move(0,-h,0),n&&s.move(-h,0,0),c&&s.move(+h,0,0);const d=.025;e.getKeydown("e")&&s.zoom(1-d),e.getKeydown("q")&&s.zoom(1+d)}this.isCanvasHovered&&e.wheel_event&&s.zoom(1+e.wheel_curr[1]*.001)}get isInputElementActive(){const e=document.activeElement.tagName.toLowerCase();return!!(e=="input"|e=="textarea")}unfocus(t){t.blur()}clickButton(t){t.toggled||(t.focus(),t.click(),t.blur())}empty_handler(t){}getElement(t){return this.elementMap.get(t)}setElement(t,e){return this.elementMap.set(t,e)}getElementValue(t){const e=this.elementMap.get(t);if(e)return e.value;console.error(`getElementValue(): elem with id ${t} not found`)}setElementValue(t,e){const s=this.elementMap.get(t);s?s.value=e:console.error(`setElementValue(): elem with id ${t} not found`)}setElementEnabled(t,e){const s=this.elementMap.get(t);s?s.disabled=!e:console.error(`setElementEnabled(): elem with id ${t} not found`)}getElementInputValid(t){const e=this.elementMap.get(t);if(e)return e.classList.contains("valid");console.error(`getElementInputValid(): elem with id ${t} not found`)}get isCanvasActive(){return!this.isInputElementActive}canvas_onmouseenter(){this.isCanvasHovered=!0}canvas_onmouseleave(){this.isCanvasHovered=!1}window_onresize(){console.log("resizing canvas");const t=this.getCanvas(),e=t.width,s=t.height,r=t.parentElement.getBoundingClientRect();Math.min(r.width/e,r.height/s);const n=window.devicePixelRatio;t.width=Math.floor(r.width*n),t.height=Math.floor(r.height*n),x.recreateRenderer(t)}getCanvas(){return this.canvas}setCanvas(t){if(this.canvas){const s=this.canvas;s.removeEventListener("mouseenter",this.listener_canvas_onmouseenter),s.removeEventListener("mouseleave",this.listener_canvas_onmouseleave),s.removeEventListener("contextmenu",this.listener_canvas_contextmenu),window.removeEventListener("resize",this.listener_window_onresize)}const e=this.canvas=t;this.listener_canvas_onmouseenter=s=>this.canvas_onmouseenter.call(this),this.listener_canvas_onmouseleave=s=>this.canvas_onmouseleave.call(this),this.listener_canvas_contextmenu=s=>s.preventDefault(),this.listener_window_onresize=s=>this.window_onresize.call(this),e.addEventListener("mouseenter",this.listener_canvas_onmouseenter),e.addEventListener("mouseleave",this.listener_canvas_onmouseleave),e.addEventListener("contextmenu",this.listener_canvas_contextmenu),window.addEventListener("resize",this.listener_window_onresize),this.window_onresize()}show_tooltip(t,e){this.show_tooltip_callback({target:t,innerHTML:e})}hide_tooltip(){this.hide_tooltip_callback()}show_tooltip_block_place(t,e){const s=x.blockLibrary.get_root_template_dependency_chain(e);let r="";if(s){r+='<div style="color:pink;">(Recursion safety) Block is not safe to place because it contains this template in its tree:</div>';for(let i=0;i<s.length;i++)r+=`<div>${i>0?"+":""}${new Array(i).fill("-").join("")}${s[i].name}</div>`}else e===x.blockLibrary.rootBlock.templateId?r+='<div style="color:pink;">(Recursion safety) Cannot place block inside of itself.</div>':r+='<div style="color:#afa;">Block is safe to place.</div>';const n=x.blockLibrary.templates.get(e);r+="<hr>",r+=`<div>${n.name}</div>`,r+="<br>",r+=`<div>${n.desc}</div>`,this.show_tooltip(t,r)}show_tooltip_block_remove(t,e){const s=x.blockLibrary.getTemplateDependents(e);if(s.length===0)this.show_tooltip(t,'<div style="color:#afa;">Block is safe to remove.</div>');else{let r="";r+='<div style="color:pink;">Block is not safe to remove because other templates are using it:</div>';for(const[n,i]of s)r+=`<div>${n.name} (${i}x)</div>`;this.show_tooltip(t,r)}}show_popup(t,e,s){this.show_popup_callback({innerHTML:t,onsubmit:e,oncancel:s})}hide_popup(){this.hide_popup_callback()}showLinkDeletionPopup(t,e,s,r){let n="";n+=`<div style="color:pink;">${e}</div>`;for(const[i,c]of t)i.templateId,n+=`<div>${i.name} (${c.length}x)</div>`;this.show_popup(n,s,r)}hideLinkDeletionPopup(){this.hide_popup()}showCrashPopup(t,e){alert(e+`

`+t)}onclick_toggle_play(t,e){e&&(x.simulationIsRunning=!x.simulationIsRunning),console.log("<>main.simulationIsRunning",x.simulationIsRunning);const s=x.simulationIsRunning;t.innerText=s?"Pause":"Play",t.title=s?"(Hotkey: p) Pause simulation":"(Hotkey: p) Run simulation"}onclick_reset_simulation(){x.simulationShouldReset=!0}init_play_header(t,e,s,r){console.log("<>",t,s,r),this.header_btn_play=t,t.onclick=()=>this.onclick_toggle_play(t,!0),this.onclick_toggle_play(t,!1),e.onclick=this.onclick_reset_simulation,e.title="Reset simulation";const n=.5,i=Math.round(1/n),c=20,h=(c-i)*6,d=v=>n*(v%(c-i)+i)*Math.pow(10,Math.floor(v/(c-i))),p=(v=>{let g=0,w=h,k=h/2;for(;g<k&&k<w;){const C=d(k);C<=v&&(g=k,k=(g+w)/2),C>=v&&(w=k,k=(g+w)/2)}return k})(x.simulationSpeed),b=v=>{const g=d(Number(v.target.value));x.simulationSpeed=g,r.innerText=`Speed: ${Number(g).toFixed(1)} steps/sec.`},_=s;_.min=0,_.max=h,_.step=1,_.value=p,_.oninput=b,_.oninput({target:{value:p}})}changedContent(){bt.onChange()}changedRendering(){bt.onChange()}add_cell(t){x.blockLibrary.rootBlock.insertCell(t)}add_link(t){x.blockLibrary.rootBlock.insertLink(t)}add_block(t){x.blockLibrary.rootBlock.insertBlock(t),this.on_minor_blocklib_change()}add_text(t){x.blockLibrary.rootBlock.insertText(t)}rem_cell(t){x.blockLibrary.rootBlock.deleteCell(t)}rem_link(t){x.blockLibrary.rootBlock.deleteLink(t)}rem_block(t){x.blockLibrary.rootBlock.deleteBlock(t),this.on_minor_blocklib_change()}rem_text(t){x.blockLibrary.rootBlock.deleteText(t)}move_item(t,e,s,r,n,i){const c=t.dimensions;c.x===e&c.y===s&c.w===r&c.h===n&c.r===i||(c.x=e,c.y=s,c.w=r,c.h=n,c.r=i,this.changedRendering())}translate_item(t,e,s){e===0&s===0||(t.dimensions.x+=e,t.dimensions.y+=s,this.changedRendering())}get_render_preview_cell(){return this.currentMode===this.MODES.PLACE_CELLS?this.place_preview_cell:null}get_render_preview_block(){return this.currentMode===this.MODES.PLACE_BLOCKS?this.place_preview_block:null}place_cursor_xy(){const t=this.cursor_snap,e=1/t,s=this.cursor_pos.slice(),r=[0,0];x.gameRenderer.renderBlock.contentTran.applyOffset(r,0,2,2);const n=Math.round((s[0]-r[0])*e)*t,i=Math.round((s[1]-r[1])*e)*t;return[n,i]}place_placementUpdate_cell(){const[t,e]=this.place_cursor_xy(),[s,r,n]=this.place_dim_cell;this.move_item(this.place_preview_cell,t,e,s,r,n)}place_placementUpdate_block(){if(!this.place_preview_block)return;const[e,s]=this.place_cursor_xy(),[r,n,i]=this.place_dim_block;this.move_item(this.place_preview_block,e,s,r,n,i)}place_placementPlace_cell(){const t=this.place_preview_cell.clone();t.id=j.next(),this.add_cell(t)}place_placementPlace_block(){const t=this.place_preview_block.clone();t.id=j.next(),this.add_block(t)}update_mode_place_cells(){this.place_preview_cell&&(this.place_placementUpdate_cell(),this.isCanvasHovered&&this.clickDeltaL==1&&this.place_placementPlace_cell())}update_mode_place_blocks(){this.place_preview_block&&(this.place_placementUpdate_block(),this.isCanvasHovered&&this.clickDeltaL==1&&this.place_placementPlace_block())}update_mode_select(){if(this.buttonDownL||this.collectionTranslating.clear(),this.dragBegan&&this.isCanvasHovered){let t=!1,e=this.input.getKeydown("Shift");if(!e){const s=this.collectionHovered.intersection(this.collectionSelected);console.log("hoveredAndSelected.count()",s.count()),s.count()>0?this.collectionTranslating.addFromCollection(this.collectionSelected):(this.collectionSelected.clear(),this.collectionSelected.addFirstComponentFromCollection(this.collectionHovered),this.collectionTranslating.clear(),this.collectionTranslating.addFromCollection(this.collectionSelected),this.on_selection_update()),t=this.collectionTranslating.count()>0,t&&(this.translate_start.set(this.cursor_pos),this.translate_prev.set(this.cursor_pos),this.translate_curr.set(this.cursor_pos))}this.cursor_isTranslating=t,this.cursor_isSelecting=!t,!e&&!t&&this.collectionSelected.clear()}this.dragEnded&&this.isCanvasHovered&&this.cursor_isSelecting&&(this.selectAllItemsInDragArea(),this.on_selection_update()),this.buttonDownL||(this.cursor_isSelecting=!1,this.cursor_isTranslating=!1),this.cursor_isTranslating&&this.translateAllSelectedItems(),this.input.getKeydownDelta("Delete")===1&&this.deleteSelectedItems()}clearCollections(){this.collectionSelected.clear(),this.collectionHovered.clear(),this.collectionTranslating.clear()}isItemInDragArea(t){const e=x.gameRenderer.renderBlock.get_axis_aligned_bounding_box(t);return ht.verifyType_throw(e,Float32Array),Ft.collision_aabb_aabb_2d(e,this.cursor_dragAABB)}isItemHovered(t){const e=x.gameRenderer.renderBlock.get_axis_aligned_bounding_box(t);return ht.verifyType_throw(e,Float32Array),Ft.collision_aabb_point_2d(e,this.cursor_pos)}selectAllItemsInDragArea(){const t=x.blockLibrary.rootBlock;for(const e of t.cells)this.isItemInDragArea(e)&&this.collectionSelected.cells.add(e);for(const e of t.texts)this.isItemInDragArea(e)&&this.collectionSelected.texts.add(e);for(const e of t.blocks)this.isItemInDragArea(e)&&this.collectionSelected.blocks.add(e)}updateHoveredItems(){this.collectionHovered.clear();const t=x.blockLibrary.rootBlock;for(const e of t.cells)this.isItemHovered(e)&&this.collectionHovered.cells.add(e);for(const e of t.texts)this.isItemHovered(e)&&this.collectionHovered.texts.add(e);for(const e of t.blocks)this.isItemHovered(e)&&this.collectionHovered.blocks.add(e)}translateAllSelectedItems(){this.translate_prev.set(this.translate_curr),this.translate_curr.set(this.cursor_pos);const t=this.cursor_snap,e=this.translate_prev.add(this.translate_start,-1).round(t),r=this.translate_curr.add(this.translate_start,-1).round(t).add(e,-1),n=r[0],i=r[1];for(const c of this.collectionTranslating.cells)this.translate_item(c,n,i);for(const c of this.collectionTranslating.texts)this.translate_item(c,n,i);for(const c of this.collectionTranslating.blocks)this.translate_item(c,n,i)}deleteSelectedItems(){x.blockLibrary.rootBlock;for(const t of this.collectionSelected.cells)this.rem_cell(t);for(const t of this.collectionSelected.texts)this.rem_text(t);for(const t of this.collectionSelected.blocks)this.rem_block(t);this.clearCollections()}get_selected_cells(){return[...this.collectionSelected.cells.values()]}get_selected_blocks(){return[...this.collectionSelected.blocks.values()]}items_set_v(t,e){if(t.length>0){this.changedContent();for(const s of t)s.value=e}}items_set_w(t,e){if(t.length>0){this.changedRendering();for(const s of t)s.dimensions.w=e}}items_set_h(t,e){if(t.length>0){this.changedRendering();for(const s of t)s.dimensions.h=e}}items_set_r(t,e){if(t.length>0){this.changedRendering();for(const s of t)s.dimensions.r=e/360}}oninput_select_c_v(t){const e=this.get_selected_cells();this.items_set_v(e,t),console.log("X",t)}oninput_select_c_w(t){const e=this.get_selected_cells();this.items_set_w(e,t)}oninput_select_c_h(t){const e=this.get_selected_cells();this.items_set_h(e,t)}oninput_select_c_r(t){const e=this.get_selected_cells();this.items_set_r(e,t)}oninput_select_b_w(t){const e=this.get_selected_blocks();this.items_set_w(e,t)}oninput_select_b_h(t){const e=this.get_selected_blocks();this.items_set_h(e,t)}oninput_select_b_r(t){const e=this.get_selected_blocks();this.items_set_r(e,t)}on_selection_update(){{const t=this.table_select_cells.inputs,e=this.get_selected_cells(),s=e.length>0;for(let r=0;r<t.length;r++)this.setElementEnabled(t[r].id,s);if(e.length>0){const r=e[0],n=[r.value,r.dimensions.w,r.dimensions.h,r.dimensions.r*360];for(let i=0;i<t.length;i++)this.setElementValue(t[i].id,n[i])}}{const t=this.table_select_blocks.inputs,e=this.get_selected_blocks(),s=e.length>0;for(let r=0;r<t.length;r++)this.setElementEnabled(t[r].id,s);if(e.length>0){const r=e[0],n=[r.dimensions.w,r.dimensions.h,r.dimensions.r*360];for(let i=0;i<t.length;i++)this.setElementValue(t[i].id,n[i])}}}update_mode_setval(){this.isCanvasHovered&&this.buttonDownL&&this.setval_hovered(this.setval_value_lmb),this.isCanvasHovered&&this.buttonDownR&&this.setval_hovered(this.setval_value_rmb)}setval_hovered(t){for(const e of this.collectionHovered.cells)x.gameServer.simulation_set_cell_value(j.THIS_BLOCK,e.id,t),e.type===Se.CONSTANT.type&&(e.value=t)}oninput_setval_lmb(t){this.setval_value_lmb=t}oninput_setval_rmb(t){this.setval_value_rmb=t}onclick_cell_type(t,e){e&&(this.place_preview_cell=new rt(e,0)),this.place_preview_cell?this.setCurrentMode(this.MODES.PLACE_CELLS):this.setCurrentMode(null);const s="panel_cell_btn_toggled";let r=this.getElement(s);r==null||r.setAttribute("toggled",!1),r=t.target,r==null||r.setAttribute("toggled",!0),this.setElement(s,r)}oninput_cell_w(t){this.place_dim_cell[0]=t}oninput_cell_h(t){this.place_dim_cell[1]=t}oninput_cell_r(t){this.place_dim_cell[2]=t/360}get_wire_colour(){return this.wire_colour_r<<24|this.wire_colour_g<<16|this.wire_colour_b<<8|255}update_mode_place_links(){const t=x.blockLibrary,e=t.get_all_cell_targets();this.wire_cell_targets=e;const s=this.wire_buttonStep>0?this.wire_target1[3]:rt.LINK_TARGET.NONE;if(this.wire_cell_target_nearest=t.get_nearst_cell_target(e,this.cursor_pos,s),this.wire_buttonStep===0&&this.dragBegan&&(this.wire_target1=this.wire_cell_target_nearest,this.wire_target1!==null&&(this.wire_buttonStep=1)),this.wire_buttonStep===1&&this.dragBegan){this.wire_target2=this.wire_cell_target_nearest;const r=this.wire_target1[3],n=this.wire_target2[3],i=rt.LINK_TARGET.OUTPUT;r!=n&(r==i|n==i)&&(this.wire_buttonStep=2)}if(this.wire_buttonStep===2){const r=rt.LINK_TARGET.OUTPUT,n=this.wire_target1,i=this.wire_target2;let c=n[3]===r?n:i,h=n[3]!==r?n:i;const[d,f,p,b]=c,[_,v,g,w]=h,k=this.get_wire_colour(),C=new ae(f,v,p,g,w,k);this.add_link(C),console.log("NEW LINK",C),this.wire_buttonStep=0}this.buttonDownR&&(this.wire_buttonStep=0,this.deleteHoveredLinks())}isLinkHovered(t){const e=x.gameRenderer.renderBlock.l_points.get(t.id),s=new oe(this.cursor_pos.slice(0,2)),r=new oe(e.slice(0,2)),n=new oe(e.slice(3,5)),i=Ft.nearestPoint_point_line_segment_2d(s,r,n);return new ft([i[0],i[1],0]).add(this.cursor_pos,-1).hypot()<=this.cursor_radius}deleteHoveredLinks(){const t=x.blockLibrary.rootBlock,e=new Set;for(const s of t.links)this.isLinkHovered(s)&&e.add(s);for(const s of e.keys())this.rem_link(s)}get_link_draw_points(){if(this.currentMode!==this.MODES.PLACE_LINKS)return[];if(!this.wire_cell_target_nearest)return[];const t=[];return this.wire_cell_target_nearest,t.push(this.wire_cell_target_nearest[0]),this.wire_buttonStep>=1&&t.push(this.wire_target1[0]),this.wire_buttonStep>=2&&t.push(this.wire_target2[0]),t}oninput_link_colour_r(t){this.wire_colour_r=t}oninput_link_colour_g(t){this.wire_colour_g=t}oninput_link_colour_b(t){this.wire_colour_b=t}onclick_block_type(t,e){if(e){const c=new Mt(0,0,1,1,0);this.place_preview_block=new Dt(c,e)}const s=x.blockLibrary,r=e&&s.templates.has(e)&&!s.containsRootTemplateInTree(e);this.place_preview_block&&r?this.setCurrentMode(this.MODES.PLACE_BLOCKS):this.setCurrentMode(null);const n="panel_block_btn_toggled";let i=this.getElement(n);i==null||i.setAttribute("toggled",!1),i=t==null?void 0:t.target,i==null||i.setAttribute("toggled",!0),this.setElement(n,i)}onclick_block_edit(t,e){x.set_root_block_template(e)}onclick_block_place(t,e){this.onclick_block_type(t,e);const s=this.table_place_blocks.inputs,r=x.blockLibrary.templates.get(e);this.setElementValue(s[0].id,r.placeW),this.setElementValue(s[1].id,r.placeH),this.oninput_block_w(r.placeW),this.oninput_block_h(r.placeH)}onclick_block_remove(t,e){this.onclick_block_type(null,j.NONE),x.blockLibrary.deleteBlockTemplate(e),this.changedRendering()}oninput_block_w(t){this.place_dim_block[0]=t}oninput_block_h(t){this.place_dim_block[1]=t}oninput_block_r(t){this.place_dim_block[2]=t/360}update_template_list(){const t=x.blockLibrary;if(!t.rootBlock)return;const e=[];for(const[s,r]of t.templates.entries()){const i=t.rootBlock.templateId===s,c=!t.containsRootTemplateInTree(s),h=t.canDeleteBlockTemplate(s),d={templateId:s,name:r.name,isEditing:i,canPlace:c,canRemove:h};e.push(d)}ys.tryUntilTruthy(()=>this.update_template_list_callback,[],100,20).then(s=>s(e)).catch(()=>console.error("failed to call update_template_list_callback"))}onmouseenter_block_place(t,e){this.show_tooltip_block_place(t.target,e)}onmouseleave_block_place(t,e){this.hide_tooltip()}onmouseenter_block_remove(t,e){this.show_tooltip_block_remove(t.target,e)}onmouseleave_block_remove(t,e){this.hide_tooltip()}on_major_blocklib_change(){this.clearCollections(),this.update_template_list(),this.rootbt_panel&&this.refresh_rootbt_inputs()}on_minor_blocklib_change(){this.update_template_list(),this.rootbt_panel&&this.refresh_rootbt_inputs()}root_template_reset_inputs(){ys.tryUntilTruthy(t=>this.getElement.call(this,t),this.input_root_template_name.input.id,100,20).then(()=>{const t=x.blockLibrary.rootBlock.template;this.setElementValue(this.input_root_template_name.input.id,t.name),this.setElementValue(this.input_root_template_desc.input.id,t.desc),this.setElementValue(this.table_root_template.inputs[0].id,t.width),this.setElementValue(this.table_root_template.inputs[1].id,t.height),this.setElementValue(this.table_root_template.inputs[2].id,t.placeW),this.setElementValue(this.table_root_template.inputs[3].id,t.placeH)})}root_template_onsubmit(){const t=x.blockLibrary.rootBlock.template,e=[];let s="",r="",n=[0,0,0,0];{const i=this.input_root_template_name.input.id,c=this.getElementValue(i);this.getElementInputValid(i)?s=c:e.push(`name [${c}] is not valid.`)}{const i=this.input_root_template_desc.input.id;r=this.getElementValue(i)}for(let i=0;i<this.table_root_template.inputs.length;i++){const c=this.table_root_template.inputs[i],[h,d]=c.get_parsed_input();d?n[i]=h:e.push(`${c.label} [${h}] is not valid.`)}e.length>0?alert(`failed to submit some or all of given inputs:
`+e.join(`
`)):(t.name=s,t.desc=r,t.width=n[0],t.height=n[1],t.placeW=n[2],t.placeH=n[3],x.refresh_root_block_template(),this.root_template_reset_inputs())}root_template_oncancel(){this.root_template_reset_inputs()}onclick_file_export(){const t=this.getElement(this.input_file_export_exp.input.id);t.value=x.blockLibrary.exportTemplates()}onclick_file_import(){const e=this.getElement(this.input_file_export_imp.input.id).value;x.blockLibrary.importTemplates(e),x.refresh_root_block_template()}show_new_template_popup(){const t="ntpw",e="ntph",s="ntpn",r="ntpd";let n="";n+=`
			<div>Width</div>
			<input type="text" id=${t}></input>
			<div>Height</div>
			<input type="text" id=${e}></input>
			<div>Name</div>
			<input type="text" id=${s}></input>
			<div>Description (optional)</div>
			<textarea id=${r} style:"width:500px;height:300px;"></textarea>
		`;const i=()=>{const[h,d]=$s(document.getElementById(t).value),[f,p]=$s(document.getElementById(e).value),[b,_]=qr(document.getElementById(s).value),[v,g]=Xr(document.getElementById(r).value),w=[];d||w.push(`width [${h}] is not valid.`),p||w.push(`height [${f}] is not valid.`),_||w.push(`name [${b}] is not valid.`),g||w.push(`description [${v}] is not valid.`),w.length>0?alert(`One or more inputs were invalid:
`+w.join(`
`)):(x.blockLibrary.createNewBlockTemplate(Math.ceil(h),Math.ceil(f),b,v),this.hide_new_template_popup())},c=()=>{this.hide_new_template_popup()};this.show_popup(n,i,c)}hide_new_template_popup(){this.hide_popup()}}class Lo{constructor(){this.gameServer=null,this.gameUI=null,this.gameRenderer=null,this.blockLibrary=null,this.frameCounter=0,this.simulationShouldRebuild=!0,this.simulationShouldReset=!0,this.simulationSpeed=60,this.simulationDatePrev=0,this.simulationIsRunning=!0,this.maxDrawDepth=2}async init(){this.gameUI=new Ro,this.gameUI.init(),this.gameServer=new ao,await this.gameServer.isReady,console.log("gameServer is ready"),this.blockLibrary=new lo,this.blockLibrary.importTemplates(JSON.stringify(io)),console.log("loaded templates",this.blockLibrary.templates);let t=null;for(const e of this.blockLibrary.templates.keys()){t=e;break}this.set_root_block_template(t),requestAnimationFrame(e=>this.update.call(this,e))}recreateRenderer(t){this.gameRenderer=new Yr(t)}async update(t){try{if(!this.gameRenderer){console.log("game renderer is not ready yet!"),requestAnimationFrame(b=>this.update.call(this,b));return}yt.reset();const e=Date.now();this.frameCounter++;const s=this.blockLibrary;await s.verifyLinksCanFindTargets(),this.gameUI.update(),await s.verifyLinksCanFindTargets();const r=s.rootBlock.templateId,n=Date.now();if(this.simulationShouldRebuild|this.simulationShouldReset){console.log("REBUILDING SIMULATION");const b=!this.simulationShouldReset;this.gameServer.send_templates(s.templates,r),this.gameServer.simulation_rebuild(r,b),this.simulationShouldRebuild=!1,this.simulationShouldReset=!1}const i=Date.now();this.simulationDatePrev===0&&(this.simulationDatePrev=Date.now());const c=Math.floor(this.simulationSpeed*.001*this.simulationDatePrev),d=Math.floor(this.simulationSpeed*.001*Date.now())-c;this.simulationIsRunning&&this.gameServer.simulation_update(d),this.simulationDatePrev=Date.now();const f=Date.now();this.gameRenderer.render();const p=Date.now();yt.increment_time("sim.rebuild",i-n),yt.increment_time("sim.update ",f-i),yt.increment_time("main.update",p-e),yt.log_all(),requestAnimationFrame(b=>this.update.call(this,b))}catch(e){throw this.gameUI.showCrashPopup(e,"application crashed during Main.update()"),e}}onRootContentChanged_addCell(t){this.simulationShouldRebuild=!0}onRootContentChanged_remCell(t){this.simulationShouldRebuild=!0}onRootContentChanged_addLink(t){this.simulationShouldRebuild=!0}onRootContentChanged_remLink(t){this.simulationShouldRebuild=!0}onRootContentChanged_addBlock(t){this.simulationShouldRebuild=!0}onRootContentChanged_remBlock(t){this.simulationShouldRebuild=!0}set_root_block_template(t){this.blockLibrary.set_root_block_template(t),bt.onChange(),this.simulationShouldRebuild=!0,this.gameUI.on_major_blocklib_change(),this.gameUI.root_template_reset_inputs(),this.gameUI.onclick_block_type(null,j.NONE)}refresh_root_block_template(){this.blockLibrary.refresh_root_block_template(),bt.onChange(),this.gameUI.on_minor_blocklib_change()}}const x=new Lo;var No=V("<button><!></button>");function St(l,t){it(t,!0);const e=Xt(t,["$$slots","$$events","$$legacy"]);let s=null;be(()=>{x.gameUI.elementMap.set(t.id,s)});var r=No();let n;var i=z(r);le(i,()=>(t==null?void 0:t.children)??we),Y(r),mt(()=>n=qt(r,n,{...e},"svelte-1ao9cra")),U(l,r),ot()}var Do=V("<canvas></canvas>");function $o(l,t){it(t,!0);const e=Xt(t,["$$slots","$$events","$$legacy"]);let s=nt(null);be(()=>{x.gameUI.setCanvas($(s))});function r(c){console.log("resize",c)}var n=Do();let i;Ie(n,c=>Z(s,c),()=>$(s)),mt(()=>i=qt(n,i,{onresize:r,...e},"svelte-eeadlf")),U(l,n),ot()}var Oo=V("<div><!></div>");function Mo(l,t){it(t,!0);const e=Xt(t,["$$slots","$$events","$$legacy"]);var s=Oo();let r;var n=z(s);le(n,()=>(t==null?void 0:t.children)??we),Y(s),mt(()=>r=qt(s,r,{...e},"svelte-15xi3mk")),U(l,s),ot()}var Bo=V("<div><!></div>");function Uo(l,t){it(t,!0);const e=Xt(t,["$$slots","$$events","$$legacy"]);var s=Bo();let r;var n=z(s);le(n,()=>(t==null?void 0:t.children)??we),Y(s),mt(()=>r=qt(s,r,{...e},"svelte-189klgo")),U(l,s),ot()}var Fo=V("<div><!></div>");function Cs(l,t){it(t,!0);const e=Xt(t,["$$slots","$$events","$$legacy"]);var s=Fo();let r;var n=z(s);le(n,()=>(t==null?void 0:t.children)??we),Y(s),mt(()=>r=qt(s,r,{...e},"svelte-y9e8ss")),U(l,s),ot()}var Ho=V("<div><!></div>");function Wo(l,t){it(t,!0);const e=Xt(t,["$$slots","$$events","$$legacy"]);var s=Ho();let r;var n=z(s);le(n,()=>(t==null?void 0:t.children)??we),Y(s),mt(()=>r=qt(s,r,{...e},"svelte-1o4do4g")),U(l,s),ot()}var Go=V("<div><!></div>");function ce(l,t){it(t,!0);const e=ve(()=>t.rows?`grid-template-rows: ${t.rows};`:""),s=ve(()=>t.cols?`grid-template-columns: ${t.cols};`:"");var r=Go(),n=z(r);le(n,()=>(t==null?void 0:t.children)??we),Y(r),mt(()=>{Yt(r,"id",t==null?void 0:t.id),Wr(r,Fr(t==null?void 0:t.class),"svelte-xca7rc"),Yt(r,"style",`${$(s)??""} ${$(e)??""} ${(t==null?void 0:t.style)??""}`)}),U(l,r),ot()}var Vo=V("<div></div>"),jo=V("<div><!> <input></div>");function Qr(l,t){it(t,!0);const e=Xt(t,["$$slots","$$events","$$legacy"]),{type:s,label:r,initial:n,oninput:i}=e;let c=nt(null);be(()=>{x.gameUI.elementMap.set(t.id,$(c))});let h=nt(pt(n)),d=nt(!0);function f(){const[w,k]=Ws($(h),s);Z(d,pt(k)),k&&i.call(x.gameUI,w)}var p=jo(),b=z(p);{var _=w=>{var k=Vo();k.textContent=r,U(w,k)};Or(b,w=>{r&&w(_)})}var v=X(b,2);so(v);let g;Ie(v,w=>Z(c,w),()=>$(c)),Y(p),mt(()=>g=qt(v,g,{...e,class:$(d)?"valid":"error",oninput:f},"svelte-1p5jytf")),Gr(v,()=>$(h),w=>Z(h,w)),U(l,p),ot()}var Ko=V("<div></div>"),zo=V("<div><!> <textarea></textarea></div>");function Os(l,t){it(t,!0);const e=Xt(t,["$$slots","$$events","$$legacy"]),{type:s,label:r,initial:n,oninput:i}=e;let c=nt(null);be(()=>{x.gameUI.elementMap.set(t.id,$(c))});let h=nt(pt(n)),d=nt(!0);function f(){const[w,k]=Ws($(h),s);Z(d,pt(k)),k&&i.call(x.gameUI,w)}var p=zo(),b=z(p);{var _=w=>{var k=Ko();k.textContent=r,U(w,k)};Or(b,w=>{r&&w(_)})}var v=X(b,2);Qi(v);let g;Ie(v,w=>Z(c,w),()=>$(c)),Y(p),mt(()=>g=qt(v,g,{...e,class:$(d)?"valid":"error",oninput:f},"svelte-bezk3n")),Gr(v,()=>$(h),w=>Z(h,w)),U(l,p),ot()}var Yo=V('<div><div class="title svelte-1ou3wvw"></div> <!></div>');function ge(l,t){const e=Xt(t,["$$slots","$$events","$$legacy"]),{title:s,inputs:r}=e;var n=Yo();let i;var c=z(n);c.textContent=s;var h=X(c,2);Ge(h,17,()=>r,We,(d,f)=>{Qr(d,xt(()=>$(f)))}),Y(n),mt(()=>i=qt(n,i,{class:"wrapper outline",...e},"svelte-1ou3wvw")),U(l,n)}var Xo=V("<!> <!>",1),qo=V('<div style="margin-bottom:10px;"><!></div> <!>',1),Qo=V('<div><div class="outline inner svelte-n6pyet"><!></div></div>');function Zo(l,t){it(t,!0);var e=Qo(),s=z(e),r=z(s);ce(r,{rows:"auto auto",children:(n,i)=>{var c=qo(),h=kt(c),d=z(h);Br(d,()=>t.innerHTML),Y(h);var f=X(h,2);ce(f,{cols:"1fr 1fr",children:(p,b)=>{var _=Xo(),v=kt(_);St(v,{onclick:()=>t.oncancel(),style:"background:#300; left:0px;",children:(w,k)=>{Et();var C=Tt("Cancel");U(w,C)},$$slots:{default:!0}});var g=X(v,2);St(g,{onclick:()=>t.onsubmit(),style:"background:#033; right:0px;",children:(w,k)=>{Et();var C=Tt("Submit");U(w,C)},$$slots:{default:!0}}),U(p,_)},$$slots:{default:!0}}),U(n,c)},$$slots:{default:!0}}),Y(s),Y(e),mt(()=>{Wr(e,`${`underlay ${t==null?void 0:t.class}`??""} svelte-n6pyet`),Yt(e,"style",t==null?void 0:t.style)}),U(l,e),ot()}var Jo=V('<div class="tooltip outline svelte-i3efh6"><!></div>');function ta(l,t){it(t,!0);let e=nt(null);be(()=>{{const n=t.target;if(!n)return;const{x:i,y:c,width:h,height:d}=n.getClientRects()[0];$(e).style.top=`${c}px`,$(e).style.left=`${i+h+5}px`}{const n=$(e).parentElement.getClientRects()[0],{x:i,y:c,width:h,height:d}=$(e).getClientRects()[0],f=n.right-(i+h),p=n.bottom-(c+d);f<0&&($(e).style.left=`${f+i+h}px`),p<0&&($(e).style.top=`${p+c}px`)}});var s=Jo(),r=z(s);Br(r,()=>t.innerHTML),Y(s),Ie(s,n=>Z(e,n),()=>$(e)),U(l,s),ot()}var ea=V("<div><!></div>");function sa(l,t){it(t,!1),Ke();var e=ea(),s=z(e);ge(s,xt(()=>x.gameUI.table_setval)),Y(e),U(l,e),ot()}var ra=V("<div><!> <!></div>");function na(l,t){it(t,!0),be(()=>{x.gameUI.on_selection_update()});var e=ra(),s=z(e);ge(s,xt(()=>x.gameUI.table_select_cells));var r=X(s,2);ge(r,xt(()=>x.gameUI.table_select_blocks)),Y(e),U(l,e),ot()}var ia=V('<div><!> <div style="margin:5px;"><!></div></div>');function oa(l,t){it(t,!1);const e=[...Object.values(Se)];function s(d,f){x.gameUI.onclick_cell_type.call(x.gameUI,d,f)}function r(d){const f=(d>>24&255)/2,p=(d>>16&255)/2,b=(d>>8&255)/2,_=d>>0&255;return f<<24|p<<16|b<<8|_}Ke();var n=ia(),i=z(n);ge(i,xt(()=>x.gameUI.table_place_cells));var c=X(i,2),h=z(c);ce(h,{cols:"1fr 1fr",children:(d,f)=>{var p=Be(),b=kt(p);Ge(b,1,()=>e,We,(_,v)=>{var g=Wi(()=>`
					height:24px; border-radius:2px; margin:1px;
					background:#${r($(v).clr).toString(16)};
				`);St(_,{onclick:w=>s(w,$(v).type),class:"outline",get style(){return $(g)},children:(w,k)=>{Et();var C=Tt();mt(()=>Fs(C,$(v).tstr)),U(w,C)},$$slots:{default:!0}})}),U(d,p)},$$slots:{default:!0}}),Y(c),Y(n),U(l,n),ot()}var aa=V("<div><!></div>");function la(l,t){it(t,!1),Ke();var e=aa(),s=z(e);ge(s,xt(()=>x.gameUI.table_place_links)),Y(e),U(l,e),ot()}var ca=V("<!> <!> <!>",1),ha=V("<div><!> <!></div>");function da(l,t){it(t,!0);let e=nt(pt([]));function s(h){Z(e,pt(h))}const r=x.gameUI;r.update_template_list_callback=s;var n=ha(),i=z(n);ge(i,xt(()=>r.table_place_blocks));var c=X(i,2);ce(c,{cols:"auto 1fr auto",children:(h,d)=>{var f=Be(),p=kt(f);Ge(p,17,()=>$(e),We,(b,_)=>{let v=()=>$(_).templateId,g=()=>$(_).name,w=()=>$(_).isEditing,k=()=>$(_).canPlace,C=()=>$(_).canRemove;var L=ca(),I=kt(L);St(I,{get disabled(){return w()},onclick:F=>r.onclick_block_edit(F,v()),get toggled(){return w()},children:(F,ut)=>{Et();var K=Tt("Edit");U(F,K)},$$slots:{default:!0}});var T=X(I,2),N=ve(()=>!k());St(T,{get disabled(){return $(N)},onclick:F=>r.onclick_block_place(F,v()),onmouseenter:F=>r.onmouseenter_block_place(F,v()),onmouseleave:F=>r.onmouseleave_block_place(F,v()),children:(F,ut)=>{Et();var K=Tt();mt(()=>Fs(K,g())),U(F,K)},$$slots:{default:!0}});var O=X(T,2),et=ve(()=>!C());St(O,{get disabled(){return $(et)},onclick:F=>r.onclick_block_remove(F,v()),onmouseenter:F=>r.onmouseenter_block_remove(F,v()),onmouseleave:F=>r.onmouseleave_block_remove(F,v()),style:"min-width:20px; background:#703;",children:(F,ut)=>{Et();var K=Tt("X");U(F,K)},$$slots:{default:!0}}),U(b,L)}),U(h,f)},$$slots:{default:!0}}),Y(n),U(l,n),ot()}var ua=V("<!> <!>",1),_a=V('<div><div class="outline" style="margin:5px; padding:5px;"><!> <!></div> <!> <!></div>');function fa(l,t){it(t,!1);const e=x.gameUI,s=e.input_root_template_name,r=e.input_root_template_desc,n={...s.input,style:s.style},i={...r.input,style:r.style},c=()=>e.root_template_oncancel.call(e),h=()=>e.root_template_onsubmit.call(e);Ke();var d=_a(),f=z(d),p=z(f);Qr(p,xt(n));var b=X(p,2);Os(b,xt(i)),Y(f);var _=X(f,2);ge(_,xt(()=>e.table_root_template));var v=X(_,2);ce(v,{cols:"1fr 1fr",style:"margin:5px; width:unset;",children:(g,w)=>{var k=ua(),C=kt(k);St(C,{onclick:c,class:"outline",style:"width:unset;",children:(I,T)=>{Et();var N=Tt("Cancel");U(I,N)},$$slots:{default:!0}});var L=X(C,2);St(L,{onclick:h,class:"outline",style:"width:unset;",children:(I,T)=>{Et();var N=Tt("Submit");U(I,N)},$$slots:{default:!0}}),U(g,k)},$$slots:{default:!0}}),Y(d),U(l,d),ot()}var pa=V('<div><div class="outline" style="margin:5px; padding:2px;"><!></div> <div class="outline" style="margin:5px; padding:2px;"><!> <!></div> <div class="outline" style="margin:5px; padding:2px;"><!> <!></div></div>');function ma(l,t){it(t,!1);const e=x.gameUI,s=e.input_file_export_exp,r=e.input_file_export_imp,n={...s.input,style:s.style},i={...r.input,style:r.style},c=()=>e.show_new_template_popup.call(e),h=()=>e.onclick_file_export.call(e),d=()=>e.onclick_file_import.call(e);Ke();var f=pa(),p=z(f),b=z(p);St(b,{onclick:c,style:"width:100%;",children:(L,I)=>{Et();var T=Tt("New Block");U(L,T)},$$slots:{default:!0}}),Y(p);var _=X(p,2),v=z(_);St(v,{onclick:d,style:"width:100%;",children:(L,I)=>{Et();var T=Tt("Import");U(L,T)},$$slots:{default:!0}});var g=X(v,2);Os(g,xt(i)),Y(_);var w=X(_,2),k=z(w);St(k,{onclick:h,style:"width:100%;",children:(L,I)=>{Et();var T=Tt("Export");U(L,T)},$$slots:{default:!0}});var C=X(k,2);Os(C,xt(n)),Y(w),Y(f),U(l,f),ot()}var va=V('<input type="range"> <div style="align-content:center;"></div>',1),ga=V("<div></div> <!> <!> <!>",1);function ba(l,t){it(t,!0);const e=x.gameUI;let s=nt(null),r=nt(null);be(()=>{const n=document.getElementById("btn_reset"),i=document.getElementById("btn_play");e.init_play_header.call(e,i,n,$(s),$(r))}),ce(l,{cols:"1fr auto auto auto 1fr",children:(n,i)=>{var c=ga(),h=X(kt(c),2);St(h,{class:"outline",id:"btn_play",children:(p,b)=>{Et();var _=Tt("Play");U(p,_)},$$slots:{default:!0}});var d=X(h,2);ce(d,{class:"outline",cols:"auto 200px",children:(p,b)=>{var _=va(),v=kt(_);Ie(v,w=>Z(s,w),()=>$(s));var g=X(v,2);Ie(g,w=>Z(r,w),()=>$(r)),U(p,_)},$$slots:{default:!0}});var f=X(d,2);St(f,{class:"outline",id:"btn_reset",children:(p,b)=>{Et();var _=Tt("Reset");U(p,_)},$$slots:{default:!0}}),U(n,c)},$$slots:{default:!0}}),ot()}var wa=V("<div><!></div>"),ya=V("<!> <!>",1),ka=V("<!> <!>",1),Ta=V("<!> <!>",1),Ea=V('<div id="page" class="svelte-vd6q55"><!> <div><!></div> <div><!></div></div>');function $a(l,t){it(t,!0);let e=nt(pt([])),s=nt(pt(new Map)),r=nt(pt(new Map)),n=nt(null),i=nt(null);function c(O){Z(i,pt(O))}function h(O){Z(n,pt($(n)===O?null:O)),x.gameUI.setCurrentMode(O)}let d=nt(null),f=nt(!1);function p(O){Z(d,pt(O)),Z(f,!0)}function b(){Z(f,!1)}let _=nt(null),v=nt(!1);function g(O){Z(_,pt(O)),Z(v,!0)}function w(){Z(v,!1)}x.init().then(()=>{const O=x.gameUI;Z(e,pt([...Object.values(O.MODES)])),O.setCurrentMode_callback=c,O.setCurrentMode(O.MODES.SELECT),Z(n,null),O.show_popup_callback=p,O.hide_popup_callback=b,O.show_tooltip_callback=g,O.hide_tooltip_callback=w,Z(s,pt(new Map([[O.MODES.FILE,O.info_file_export],[O.MODES.SELECT,O.info_select],[O.MODES.SET_VALUES,O.info_setval],[O.MODES.PLACE_CELLS,O.info_place_cells],[O.MODES.PLACE_LINKS,O.info_place_links],[O.MODES.PLACE_BLOCKS,O.info_place_blocks],[O.MODES.ROOT_BLOCK,O.info_root_template]]))),Z(r,pt(new Map([[O.MODES.FILE,ma],[O.MODES.SELECT,na],[O.MODES.SET_VALUES,sa],[O.MODES.PLACE_CELLS,oa],[O.MODES.PLACE_LINKS,la],[O.MODES.PLACE_BLOCKS,da],[O.MODES.ROOT_BLOCK,fa]]))),O.update_template_list(),O.root_template_reset_inputs()});var k=Ea(),C=z(k);Cs(C,{children:(O,et)=>{var F=Ta(),ut=kt(F);Mo(ut,{id:"header",children:(J,vt)=>{var At=Be(),It=kt(At);le(It,()=>ba),U(J,At)},$$slots:{default:!0}});var K=X(ut,2);Uo(K,{id:"middle",children:(J,vt)=>{ce(J,{cols:"1fr",children:(At,It)=>{var $t=ka(),at=kt($t);$o(at,{class:"first_cell",id:"canvas"});var st=X(at,2);Wo(st,{class:"first_cell clickthrough",style:"width: fit-content; height: 100%;",children:(lt,Ct)=>{var Ht=ya(),Rt=kt(Ht);Cs(Rt,{class:"clickable",style:"height: fit-content;",children:(Ot,Wt)=>{var Lt=Be(),Qt=kt(Lt);Ge(Qt,17,()=>$(e),We,(he,_t)=>{var Zt=ve(()=>$(n)===$(_t)),Pe=ve(()=>$(i)===$(_t)?"background:#047;":""),cs=ve(()=>$(s).get($(_t)));St(he,{get toggled(){return $(Zt)},get style(){return $(Pe)},onclick:()=>h($(_t)),get title(){return $(cs)},children:(Ae,Gs)=>{Et();var Re=Tt();mt(()=>Fs(Re,$(_t))),U(Ae,Re)},$$slots:{default:!0}})}),U(Ot,Lt)},$$slots:{default:!0}});var Bt=X(Rt,2);Cs(Bt,{class:"clickable",style:"height: fit-content; background: #000a;",children:(Ot,Wt)=>{var Lt=Be(),Qt=kt(Lt);Ge(Qt,17,()=>$(e),We,(he,_t)=>{var Zt=wa(),Pe=z(Zt);le(Pe,()=>$(r).get($(_t))??we),Y(Zt),mt(()=>Yt(Zt,"style",$(n)===$(_t)?"":"display: none;")),U(he,Zt)}),U(Ot,Lt)},$$slots:{default:!0}}),U(lt,Ht)},$$slots:{default:!0}}),U(At,$t)},$$slots:{default:!0}})},$$slots:{default:!0}}),U(O,F)},$$slots:{default:!0}});var L=X(C,2),I=z(L);Zo(I,xt(()=>$(d))),Y(L);var T=X(L,2),N=z(T);ta(N,xt(()=>$(_))),Y(T),Y(k),mt(()=>{Yt(L,"style",$(f)?"":"visibility:hidden;"),Yt(T,"style",$(v)?"":"visibility:hidden;")}),U(l,k),ot()}export{$a as component};
