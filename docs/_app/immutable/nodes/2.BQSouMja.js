var gi=Object.defineProperty;var bi=(l,t,e)=>t in l?gi(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var R=(l,t,e)=>bi(l,typeof t!="symbol"?t+"":t,e);import{b as wr,e as wi,a as M,t as G,c as le,d as gt}from"../chunks/disclose-version.xy2xlNg-.js";import{b as Rr,h as Et,s as os,a8 as yi,e as Ds,P as ki,an as Nr,H as Ti,r as yr,f as Es,c as ge,as,g as Dr,a as Ws,p as Ei,T as xi,M as kr,at as Gs,au as Tr,av as Vs,aw as Si,ac as Ii,ax as Ci,d as Or,ay as $r,a9 as Br,ak as Ai,ae as Pi,az as Li,a6 as Ri,I as Er,aA as Ni,ai as Mr,al as Di,aj as Oi,aB as $i,aC as Bi,O as Mi,aD as Ui,aE as Fi,j as Hi,R as Wi,x as nt,u as ke,A as mt,z as it,n as ue,B as z,C as Y,q as O,K as Z,ar as st,v as ce,D as K,y as dt,aF as bt,a5 as Gi}from"../chunks/runtime.Ec6j9ccR.js";import{a as Vi,i as ji,c as Ki,d as zi,b as Yi,n as Xi,e as qi,l as Qi,r as Ji,s as _s}from"../chunks/render.BdM5TC2M.js";import{s as qt}from"../chunks/snippet.CgDhepUT.js";import{r as Qt,b as Pe,a as _t,s as It}from"../chunks/props.C_OZB70W.js";import{i as Ce}from"../chunks/if.B9OObBUH.js";import{i as Ye}from"../chunks/legacy.DVzOJGYT.js";function Le(l,t){return t}function Zi(l,t,e,s){for(var r=[],n=t.length,i=0;i<n;i++)Si(t[i].e,r,!0);var c=n>0&&r.length===0&&e!==null;if(c){var h=e.parentNode;Ii(h),h.append(e),s.clear(),oe(l,t[0].prev,t[n-1].next)}Ci(r,()=>{for(var d=0;d<n;d++){var f=t[d];c||(s.delete(f.k),oe(l,f.prev,f.next)),Or(f.e,!c)}})}function Re(l,t,e,s,r,n=null){var i=l,c={flags:t,items:new Map,first:null},h=(t&$r)!==0;if(h){var d=l;i=Et?os(Br(d)):d.appendChild(yi())}Et&&Ds();var f=null,p=!1;Rr(()=>{var b=e(),_=ki(b)?b:b==null?[]:Nr(b),v=_.length;if(p&&v===0)return;p=v===0;let g=!1;if(Et){var w=i.data===Ti;w!==(v===0)&&(i=yr(),os(i),Es(!1),g=!0)}if(Et){for(var y=null,I,A=0;A<v;A++){if(ge.nodeType===8&&ge.data===Ai){i=ge,g=!0,Es(!1);break}var E=_[A],k=s(E,A);I=Ur(ge,c,y,null,E,k,A,r,t),c.items.set(k,I),y=I}v>0&&os(yr())}if(!Et){var N=Pi;to(_,c,i,r,t,(N.f&as)!==0,s)}n!==null&&(v===0?f?Dr(f):f=Ws(()=>n(i)):f!==null&&Ei(f,()=>{f=null})),g&&Es(!0),e()}),Et&&(i=ge)}function to(l,t,e,s,r,n,i,c){var yt,Rt,at,tt;var h=(r&Li)!==0,d=(r&(Gs|Vs))!==0,f=l.length,p=t.items,b=t.first,_=b,v,g=null,w,y=[],I=[],A,E,k,N;if(h)for(N=0;N<f;N+=1)A=l[N],E=i(A,N),k=p.get(E),k!==void 0&&((yt=k.a)==null||yt.measure(),(w??(w=new Set)).add(k));for(N=0;N<f;N+=1){if(A=l[N],E=i(A,N),k=p.get(E),k===void 0){var J=_?_.e.nodes_start:e;g=Ur(J,t,g,g===null?t.first:g.next,A,E,N,s,r),p.set(E,g),y=[],I=[],_=g.next;continue}if(d&&eo(k,A,N,r),k.e.f&as&&(Dr(k.e),h&&((Rt=k.a)==null||Rt.unfix(),(w??(w=new Set)).delete(k))),k!==_){if(v!==void 0&&v.has(k)){if(y.length<I.length){var D=I[0],H;g=D.prev;var ft=y[0],X=y[y.length-1];for(H=0;H<y.length;H+=1)xr(y[H],D,e);for(H=0;H<I.length;H+=1)v.delete(I[H]);oe(t,ft.prev,X.next),oe(t,g,ft),oe(t,X,D),_=D,g=X,N-=1,y=[],I=[]}else v.delete(k),xr(k,_,e),oe(t,k.prev,k.next),oe(t,k,g===null?t.first:g.next),oe(t,g,k),g=k;continue}for(y=[],I=[];_!==null&&_.k!==E;)(n||!(_.e.f&as))&&(v??(v=new Set)).add(_),I.push(_),_=_.next;if(_===null)continue;k=_}y.push(k),g=k,_=k.next}if(_!==null||v!==void 0){for(var ot=v===void 0?[]:Nr(v);_!==null;)(n||!(_.e.f&as))&&ot.push(_),_=_.next;var pt=ot.length;if(pt>0){var Wt=r&$r&&f===0?e:null;if(h){for(N=0;N<pt;N+=1)(at=ot[N].a)==null||at.measure();for(N=0;N<pt;N+=1)(tt=ot[N].a)==null||tt.fix()}Zi(t,ot,Wt,p)}}h&&xi(()=>{var lt;if(w!==void 0)for(k of w)(lt=k.a)==null||lt.apply()}),kr.first=t.first&&t.first.e,kr.last=g&&g.e}function eo(l,t,e,s){s&Gs&&Tr(l.v,t),s&Vs?Tr(l.i,e):l.i=e}function Ur(l,t,e,s,r,n,i,c,h,d){var f=(h&Gs)!==0,p=(h&Ni)===0,b=f?p?Ri(r):Er(r):r,_=h&Vs?Er(i):i,v={i:_,v:b,k:n,a:null,e:null,prev:e,next:s};try{return v.e=Ws(()=>c(l,b,_),Et),v.e.prev=e&&e.e,v.e.next=s&&s.e,e===null?t.first=v:(e.next=v,e.e.next=v.e),s!==null&&(s.prev=v,s.e.prev=v.e),v}finally{}}function xr(l,t,e){for(var s=l.next?l.next.e.nodes_start:e,r=t?t.e.nodes_start:e,n=l.e.nodes_start;n!==s;){var i=Mr(n);r.before(n),n=i}}function oe(l,t,e){t===null?l.first=e:(t.next=e,t.e.next=e&&e.e),e!==null&&(e.prev=t,e.e.prev=t&&t.e)}function ls(l,t,e,s,r){var n=l,i="",c;Rr(()=>{if(i===(i=t()??"")){Et&&Ds();return}c!==void 0&&(Or(c),c=void 0),i!==""&&(c=Ws(()=>{if(Et){ge.data;for(var h=Ds(),d=h;h!==null&&(h.nodeType!==8||h.data!=="");)d=h,h=Mr(h);if(h===null)throw Di(),Oi;wr(ge,d),n=os(h);return}var f=i+"",p=wi(f);wr(Br(p),p.lastChild),n.before(p)}))})}function Fr(l){var t,e,s="";if(typeof l=="string"||typeof l=="number")s+=l;else if(typeof l=="object")if(Array.isArray(l)){var r=l.length;for(t=0;t<r;t++)l[t]&&(e=Fr(l[t]))&&(s&&(s+=" "),s+=e)}else for(e in l)l[e]&&(s&&(s+=" "),s+=e);return s}function so(){for(var l,t,e=0,s="",r=arguments.length;e<r;e++)(l=arguments[e])&&(t=Fr(l))&&(s&&(s+=" "),s+=t);return s}function Hr(l){return typeof l=="object"?so(l):l??""}function ro(l){if(Et){var t=!1,e=()=>{if(!t){if(t=!0,l.hasAttribute("value")){var s=l.value;Xt(l,"value",null),l.value=s}if(l.hasAttribute("checked")){var r=l.checked;Xt(l,"checked",null),l.checked=r}}};l.__on_r=e,$i(e),Vi()}}function no(l,t){t?l.hasAttribute("selected")||l.setAttribute("selected",""):l.removeAttribute("selected")}function Xt(l,t,e,s){var r=l.__attributes??(l.__attributes={});Et&&(r[t]=l.getAttribute(t),t==="src"||t==="srcset"||t==="href"&&l.nodeName==="LINK")||r[t]!==(r[t]=e)&&(t==="style"&&"__styles"in l&&(l.__styles={}),t==="loading"&&(l[Bi]=e),e==null?l.removeAttribute(t):typeof e!="string"&&Wr(l).includes(t)?l[t]=e:l.setAttribute(t,e))}function Jt(l,t,e,s,r=!1,n=!1,i=!1){var c=t||{},h=l.tagName==="OPTION";for(var d in t)d in e||(e[d]=null);e.class&&(e.class=Hr(e.class)),s!==void 0&&(e.class=e.class?e.class+" "+s:s);var f=Wr(l),p=l.__attributes??(l.__attributes={});for(const y in e){let I=e[y];if(h&&y==="value"&&I==null){l.value=l.__value="",c[y]=I;continue}var b=c[y];if(I!==b){c[y]=I;var _=y[0]+y[1];if(_!=="$$"){if(_==="on"){const A={},E="$$"+y;let k=y.slice(2);var v=qi(k);if(ji(k)&&(k=k.slice(0,-7),A.capture=!0),!v&&b){if(I!=null)continue;l.removeEventListener(k,c[E],A),c[E]=null}if(I!=null)if(v)l[`__${k}`]=I,zi([k]);else{let N=function(J){c[y].call(this,J)};c[E]=Ki(k,l,N,A)}else v&&(l[`__${k}`]=void 0)}else if(y==="style"&&I!=null)l.style.cssText=I+"";else if(y==="autofocus")Yi(l,!!I);else if(y==="__value"||y==="value"&&I!=null)l.value=l[y]=l.__value=I;else if(y==="selected"&&h)no(l,I);else{var g=y;r||(g=Xi(g));var w=g==="defaultValue"||g==="defaultChecked";if(I==null&&!n&&!w)if(p[y]=null,g==="value"||g==="checked"){let A=l;if(g==="value"){let E=A.defaultValue;A.removeAttribute(g),A.defaultValue=E}else{let E=A.defaultChecked;A.removeAttribute(g),A.defaultChecked=E}}else l.removeAttribute(y);else w||f.includes(g)&&(n||typeof I!="string")?l[g]=I:typeof I!="function"&&(Et&&(g==="src"||g==="href"||g==="srcset")||Xt(l,g,I))}y==="style"&&"__styles"in l&&(l.__styles={})}}}return c}var Sr=new Map;function Wr(l){var t=Sr.get(l.nodeName);if(t)return t;Sr.set(l.nodeName,t=[]);for(var e,s=l,r=Element.prototype;r!==s;){e=Ui(s);for(var n in e)e[n].set&&t.push(n);s=Mi(s)}return t}function Gr(l,t,e){var s=l.__className,r=io(t,e);Et&&l.className===r?l.__className=r:(s!==r||Et&&l.className!==r)&&(t==null&&!e?l.removeAttribute("class"):l.className=r,l.__className=r)}function io(l,t){return(l??"")+(t?" "+t:"")}function Vr(l,t,e=t){var s=Fi();Qi(l,"input",r=>{var n=r?l.defaultValue:l.value;if(n=xs(l)?Ss(n):n,e(n),s&&n!==(n=t())){var i=l.selectionStart,c=l.selectionEnd;l.value=n??"",c!==null&&(l.selectionStart=i,l.selectionEnd=Math.min(c,l.value.length))}}),(Et&&l.defaultValue!==l.value||Hi(t)==null&&l.value)&&e(xs(l)?Ss(l.value):l.value),Wi(()=>{var r=t();xs(l)&&r===Ss(l.value)||l.type==="date"&&!r&&!l.value||r!==l.value&&(l.value=r??"")})}function xs(l){var t=l.type;return t==="number"||t==="range"}function Ss(l){return l===""?null:+l}const oo=[{templateId:1731786847186,width:12,height:12,placeW:4,placeH:4,name:"Test Block",desc:`A block with various cells and sub-blocks.

(for testing purposes)`,cells:[{dim:[8,1.5,1,1,0],id:1731787677167,type:120,value:0},{dim:[9.5,.5,1,1,0],id:1731787677168,type:15933,value:0},{dim:[9.5,2.5,1,1,0],id:1731787677169,type:15421,value:0},{dim:[.5,11.5,1,1,0],id:1731787677176,type:1129206612,value:74565},{dim:[2.5,11.5,1,1,0],id:1731787677177,type:1129271385,value:0},{dim:[4.5,11.5,1,1,0],id:1731787677178,type:20306,value:0},{dim:[6.5,11.5,1,1,0],id:1731787677179,type:5787474,value:0},{dim:[8.5,11.5,1,1,0],id:1731787677180,type:5132116,value:0},{dim:[10.5,11.5,1,1,0],id:1731787677181,type:4279876,value:0},{dim:[4.5,7.5,1,1,0],id:1731789026881,type:15677,value:0},{dim:[.5,9.5,1,1,0],id:1731787677183,type:5002056,value:0},{dim:[2.5,9.5,1,1,0],id:1731787677184,type:5395272,value:0},{dim:[4.5,9.5,1,1,0],id:1731787677185,type:43,value:0},{dim:[6.5,9.5,1,1,0],id:1731787677186,type:45,value:0},{dim:[8.5,9.5,1,1,0],id:1731787677187,type:120,value:0},{dim:[10.5,9.5,1,1,0],id:1731787677188,type:247,value:0},{dim:[.5,7.5,1,1,0],id:1731787677189,type:62,value:0},{dim:[2.5,7.5,1,1,0],id:1731787677190,type:60,value:0},{dim:[6.5,7.5,1,1,0],id:1731787677191,type:15933,value:0},{dim:[8.5,7.5,1,1,0],id:1731787677192,type:15421,value:0},{dim:[.5,2.5,1,1,0],id:1736011115513,type:1129206612,value:7},{dim:[.5,.5,1,1,0],id:1736011115514,type:1129206612,value:2},{dim:[11.5,1.5,1,1,0],id:1736012693229,type:1129271385,value:0}],links:[{id:1734119501955,src_addr:[1,1731787677176],dst_addr:[1,1731787677177,1],clr:4294967295},{id:1732933058482,src_addr:[1,1731787677192],dst_addr:[1,1731787677188,2],clr:4294967295},{id:1736011115516,src_addr:[1,1736011115513],dst_addr:[1731786847240,1731786847218,1],clr:-14081},{id:1736012693224,src_addr:[1731786847240,1731786847223],dst_addr:[1,1731787677167,2],clr:-14081},{id:1736012693225,src_addr:[1736011258536,1736011258530],dst_addr:[1,1731787677167,1],clr:-14081},{id:1736012693226,src_addr:[1,1731787677167],dst_addr:[1,1731787677168,1],clr:-14081},{id:1732933058479,src_addr:[1731786847240,1731786847223],dst_addr:[1,1731787677169,1],clr:4294967295},{id:1732933058480,src_addr:[1,1731787677167],dst_addr:[1,1731787677169,2],clr:4294967295},{id:1732933058481,src_addr:[1,1731787677192],dst_addr:[1,1731787677188,1],clr:4294967295},{id:1736011115515,src_addr:[1,1736011115514],dst_addr:[1731786847240,1731786847219,1],clr:-14081},{id:1736012693227,src_addr:[1731786847240,1731786847223],dst_addr:[1,1731787677168,2],clr:-14081},{id:1736012693230,src_addr:[1,1731787677167],dst_addr:[1,1736012693229,1],clr:-14081}],texts:[],blocks:[{dim:[4,1.5,4,3,0],id:1731786847240,templateId:1731786847210},{dim:[6,4.5,"2","1",0],id:1736011258536,templateId:1736011258525}]},{templateId:1731786847210,width:9,height:6,placeW:3,placeH:2,name:"XOR Gate",desc:"An implementation of an XOR gate using simpler gates",cells:[{dim:[3.5,5,1,1,0],id:1731786847221,type:4279876,value:0},{dim:[1,5,2,2,0],id:1731786847218,type:1129271385,value:0},{dim:[1,1,2,2,0],id:1731786847219,type:1129271385,value:0},{dim:[3.5,1,1,1,0],id:1731786847220,type:20306,value:0},{dim:[5.5,4.5,1,1,-.08333333333333333],id:1731786847222,type:5132116,value:0},{dim:[8,3,2,2,0],id:1731786847223,type:4279876,value:0},{dim:[5.5,1.5,1,1,.08333333333333333],id:1735948428212,type:1129271385,value:0}],links:[{id:1732933058488,src_addr:[1,1731786847218],dst_addr:[1,1731786847220,1],clr:4294967295},{id:1732933058489,src_addr:[1,1731786847219],dst_addr:[1,1731786847220,2],clr:4294967295},{id:1732933058490,src_addr:[1,1731786847219],dst_addr:[1,1731786847221,2],clr:4294967295},{id:1732933058491,src_addr:[1,1731786847218],dst_addr:[1,1731786847221,1],clr:4294967295},{id:1732933058492,src_addr:[1,1731786847221],dst_addr:[1,1731786847222,1],clr:4294967295},{id:1732933058493,src_addr:[1,1731786847222],dst_addr:[1,1731786847223,1],clr:4294967295},{id:1735948428213,src_addr:[1,1731786847220],dst_addr:[1,1735948428212,1],clr:-14081},{id:1735948428214,src_addr:[1,1735948428212],dst_addr:[1,1731786847223,2],clr:-14081}],texts:[],blocks:[]},{templateId:1736011258525,width:4,height:2,placeW:2,placeH:1,name:"Frame Counter",desc:"This block has a cell which increments by 1 each simulation step.",cells:[{dim:[.5,1,1,1,0],id:1736011258528,type:1129206612,value:1},{dim:[3,1,2,2,0],id:1736011258530,type:43,value:0}],links:[{id:1736011258532,src_addr:[1,1736011258528],dst_addr:[1,1736011258530,1],clr:-14081},{id:1736011258533,src_addr:[1,1736011258530],dst_addr:[1,1736011258530,2],clr:-14081}],texts:[],blocks:[]}];var ao=(()=>{var l=import.meta.url;return function(t={}){var e,s=t,r,n,i=new Promise((a,o)=>{r=a,n=o}),c=Object.assign({},s),h="";function d(a){return s.locateFile?s.locateFile(a,h):h+a}var f;typeof document<"u"&&document.currentScript&&(h=document.currentScript.src),l&&(h=l),h.startsWith("blob:")?h="":h=h.substr(0,h.replace(/[?#].*/,"").lastIndexOf("/")+1),f=a=>fetch(a,{credentials:"same-origin"}).then(o=>o.ok?o.arrayBuffer():Promise.reject(new Error(o.status+" : "+o.url)));var p=s.print||console.log.bind(console),b=s.printErr||console.error.bind(console);Object.assign(s,c),c=null,s.arguments&&s.arguments,s.thisProgram&&s.thisProgram,s.quit&&s.quit;var _;s.wasmBinary&&(_=s.wasmBinary);var v,g=!1,w,y,I,A,E,k,N,J;function D(){var a=v.buffer;s.HEAP8=w=new Int8Array(a),s.HEAP16=I=new Int16Array(a),s.HEAPU8=y=new Uint8Array(a),s.HEAPU16=A=new Uint16Array(a),s.HEAP32=E=new Int32Array(a),s.HEAPU32=k=new Uint32Array(a),s.HEAPF32=N=new Float32Array(a),s.HEAPF64=J=new Float64Array(a)}var H=[],ft=[],X=[];function ot(){if(s.preRun)for(typeof s.preRun=="function"&&(s.preRun=[s.preRun]);s.preRun.length;)yt(s.preRun.shift());Oe(H)}function pt(){Oe(ft)}function Wt(){if(s.postRun)for(typeof s.postRun=="function"&&(s.postRun=[s.postRun]);s.postRun.length;)at(s.postRun.shift());Oe(X)}function yt(a){H.unshift(a)}function Rt(a){ft.unshift(a)}function at(a){X.unshift(a)}var tt=0,lt=null;function xt(a){var o;tt++,(o=s.monitorRunDependencies)==null||o.call(s,tt)}function _e(a){var u;if(tt--,(u=s.monitorRunDependencies)==null||u.call(s,tt),tt==0&&lt){var o=lt;lt=null,o()}}function At(a){var u;(u=s.onAbort)==null||u.call(s,a),a="Aborted("+a+")",b(a),g=!0,a+=". Build with -sASSERTIONS for more info.";var o=new WebAssembly.RuntimeError(a);throw n(o),o}var Nt="data:application/octet-stream;base64,",Gt=a=>a.startsWith(Nt);function Dt(){if(s.locateFile){var a="em_index.wasm";return Gt(a)?a:d(a)}return new URL(""+new URL("../assets/em_index.BKILPcjZ.wasm",import.meta.url).href,import.meta.url).href}var Zt;function Bt(a){if(a==Zt&&_)return new Uint8Array(_);throw"both async and sync fetching of the wasm failed"}function fe(a){return _?Promise.resolve().then(()=>Bt(a)):f(a).then(o=>new Uint8Array(o),()=>Bt(a))}function Ot(a,o,u){return fe(a).then(m=>WebAssembly.instantiate(m,o)).then(u,m=>{b(`failed to asynchronously prepare wasm: ${m}`),At(m)})}function Mt(a,o,u,m){return!a&&typeof WebAssembly.instantiateStreaming=="function"&&!Gt(o)&&typeof fetch=="function"?fetch(o,{credentials:"same-origin"}).then(T=>{var C=WebAssembly.instantiateStreaming(T,u);return C.then(m,function(P){return b(`wasm streaming compile failed: ${P}`),b("falling back to ArrayBuffer instantiation"),Ot(o,u,m)})}):Ot(o,u,m)}function te(){return{env:ur,wasi_snapshot_preview1:ur}}function De(){var a=te();function o(m,T){return Ut=m.exports,v=Ut.memory,D(),tr=Ut.__indirect_function_table,Rt(Ut.__wasm_call_ctors),_e(),Ut}xt();function u(m){o(m.instance)}if(s.instantiateWasm)try{return s.instantiateWasm(a,o)}catch(m){b(`Module.instantiateWasm callback failed with error: ${m}`),n(m)}return Zt||(Zt=Dt()),Mt(_,Zt,a,u).catch(n),{}}var Oe=a=>{for(;a.length>0;)a.shift()(s)};s.noExitRuntime;class fs{constructor(o){this.excPtr=o,this.ptr=o-24}set_type(o){k[this.ptr+4>>2]=o}get_type(){return k[this.ptr+4>>2]}set_destructor(o){k[this.ptr+8>>2]=o}get_destructor(){return k[this.ptr+8>>2]}set_caught(o){o=o?1:0,w[this.ptr+12]=o}get_caught(){return w[this.ptr+12]!=0}set_rethrown(o){o=o?1:0,w[this.ptr+13]=o}get_rethrown(){return w[this.ptr+13]!=0}init(o,u){this.set_adjusted_ptr(0),this.set_type(o),this.set_destructor(u)}set_adjusted_ptr(o){k[this.ptr+16>>2]=o}get_adjusted_ptr(){return k[this.ptr+16>>2]}get_exception_ptr(){var o=fr(this.get_type());if(o)return k[this.excPtr>>2];var u=this.get_adjusted_ptr();return u!==0?u:this.excPtr}}var ps=0,Xe=(a,o,u)=>{var m=new fs(a);throw m.init(o,u),ps=a,ps},tn=()=>{At("")},en=(a,o,u,m,T)=>{},sn=()=>{for(var a=new Array(256),o=0;o<256;++o)a[o]=String.fromCharCode(o);zs=a},zs,Pt=a=>{for(var o="",u=a;y[u];)o+=zs[y[u++]];return o},Te={},Ee={},qe={},xe,W=a=>{throw new xe(a)},Ys,Qe=a=>{throw new Ys(a)},pe=(a,o,u)=>{a.forEach(function(S){qe[S]=o});function m(S){var L=u(S);L.length!==a.length&&Qe("Mismatched type converter count");for(var $=0;$<a.length;++$)Vt(a[$],L[$])}var T=new Array(o.length),C=[],P=0;o.forEach((S,L)=>{Ee.hasOwnProperty(S)?T[L]=Ee[S]:(C.push(S),Te.hasOwnProperty(S)||(Te[S]=[]),Te[S].push(()=>{T[L]=Ee[S],++P,P===C.length&&m(T)}))}),C.length===0&&m(T)};function rn(a,o,u={}){var m=o.name;if(a||W(`type "${m}" must have a positive integer typeid pointer`),Ee.hasOwnProperty(a)){if(u.ignoreDuplicateRegistrations)return;W(`Cannot register type '${m}' twice`)}if(Ee[a]=o,delete qe[a],Te.hasOwnProperty(a)){var T=Te[a];delete Te[a],T.forEach(C=>C())}}function Vt(a,o,u={}){if(!("argPackAdvance"in o))throw new TypeError("registerType registeredInstance requires argPackAdvance");return rn(a,o,u)}var ee=8,nn=(a,o,u,m)=>{o=Pt(o),Vt(a,{name:o,fromWireType:function(T){return!!T},toWireType:function(T,C){return C?u:m},argPackAdvance:ee,readValueFromPointer:function(T){return this.fromWireType(y[T])},destructorFunction:null})},on=a=>({count:a.count,deleteScheduled:a.deleteScheduled,preservePointerOnDelete:a.preservePointerOnDelete,ptr:a.ptr,ptrType:a.ptrType,smartPtr:a.smartPtr,smartPtrType:a.smartPtrType}),ms=a=>{function o(u){return u.$$.ptrType.registeredClass.name}W(o(a)+" instance already deleted")},vs=!1,Xs=a=>{},an=a=>{a.smartPtr?a.smartPtrType.rawDestructor(a.smartPtr):a.ptrType.registeredClass.rawDestructor(a.ptr)},qs=a=>{a.count.value-=1;var o=a.count.value===0;o&&an(a)},Qs=(a,o,u)=>{if(o===u)return a;if(u.baseClass===void 0)return null;var m=Qs(a,o,u.baseClass);return m===null?null:u.downcast(m)},Js={},ln=()=>Object.keys(Me).length,cn=()=>{var a=[];for(var o in Me)Me.hasOwnProperty(o)&&a.push(Me[o]);return a},$e=[],gs=()=>{for(;$e.length;){var a=$e.pop();a.$$.deleteScheduled=!1,a.delete()}},Be,hn=a=>{Be=a,$e.length&&Be&&Be(gs)},dn=()=>{s.getInheritedInstanceCount=ln,s.getLiveInheritedInstances=cn,s.flushPendingDeletes=gs,s.setDelayFunction=hn},Me={},un=(a,o)=>{for(o===void 0&&W("ptr should not be undefined");a.baseClass;)o=a.upcast(o),a=a.baseClass;return o},_n=(a,o)=>(o=un(a,o),Me[o]),Je=(a,o)=>{(!o.ptrType||!o.ptr)&&Qe("makeClassHandle requires ptr and ptrType");var u=!!o.smartPtrType,m=!!o.smartPtr;return u!==m&&Qe("Both smartPtrType and smartPtr must be specified"),o.count={value:1},Ue(Object.create(a,{$$:{value:o,writable:!0}}))};function fn(a){var o=this.getPointee(a);if(!o)return this.destructor(a),null;var u=_n(this.registeredClass,o);if(u!==void 0){if(u.$$.count.value===0)return u.$$.ptr=o,u.$$.smartPtr=a,u.clone();var m=u.clone();return this.destructor(a),m}function T(){return this.isSmartPointer?Je(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:o,smartPtrType:this,smartPtr:a}):Je(this.registeredClass.instancePrototype,{ptrType:this,ptr:a})}var C=this.registeredClass.getActualType(o),P=Js[C];if(!P)return T.call(this);var S;this.isConst?S=P.constPointerType:S=P.pointerType;var L=Qs(o,this.registeredClass,S.registeredClass);return L===null?T.call(this):this.isSmartPointer?Je(S.registeredClass.instancePrototype,{ptrType:S,ptr:L,smartPtrType:this,smartPtr:a}):Je(S.registeredClass.instancePrototype,{ptrType:S,ptr:L})}var Ue=a=>typeof FinalizationRegistry>"u"?(Ue=o=>o,a):(vs=new FinalizationRegistry(o=>{qs(o.$$)}),Ue=o=>{var u=o.$$,m=!!u.smartPtr;if(m){var T={$$:u};vs.register(o,T,o)}return o},Xs=o=>vs.unregister(o),Ue(a)),pn=()=>{Object.assign(Ze.prototype,{isAliasOf(a){if(!(this instanceof Ze)||!(a instanceof Ze))return!1;var o=this.$$.ptrType.registeredClass,u=this.$$.ptr;a.$$=a.$$;for(var m=a.$$.ptrType.registeredClass,T=a.$$.ptr;o.baseClass;)u=o.upcast(u),o=o.baseClass;for(;m.baseClass;)T=m.upcast(T),m=m.baseClass;return o===m&&u===T},clone(){if(this.$$.ptr||ms(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var a=Ue(Object.create(Object.getPrototypeOf(this),{$$:{value:on(this.$$)}}));return a.$$.count.value+=1,a.$$.deleteScheduled=!1,a},delete(){this.$$.ptr||ms(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&W("Object already scheduled for deletion"),Xs(this),qs(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)},isDeleted(){return!this.$$.ptr},deleteLater(){return this.$$.ptr||ms(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&W("Object already scheduled for deletion"),$e.push(this),$e.length===1&&Be&&Be(gs),this.$$.deleteScheduled=!0,this}})};function Ze(){}var ts=(a,o)=>Object.defineProperty(o,"name",{value:a}),Zs=(a,o,u)=>{if(a[o].overloadTable===void 0){var m=a[o];a[o]=function(...T){return a[o].overloadTable.hasOwnProperty(T.length)||W(`Function '${u}' called with an invalid number of arguments (${T.length}) - expects one of (${a[o].overloadTable})!`),a[o].overloadTable[T.length].apply(this,T)},a[o].overloadTable=[],a[o].overloadTable[m.argCount]=m}},mn=(a,o,u)=>{s.hasOwnProperty(a)?(W(`Cannot register public name '${a}' twice`),Zs(s,a,a),s.hasOwnProperty(u)&&W(`Cannot register multiple overloads of a function with the same number of arguments (${u})!`),s[a].overloadTable[u]=o):s[a]=o},vn=48,gn=57,bn=a=>{if(a===void 0)return"_unknown";a=a.replace(/[^a-zA-Z0-9_]/g,"$");var o=a.charCodeAt(0);return o>=vn&&o<=gn?`_${a}`:a};function wn(a,o,u,m,T,C,P,S){this.name=a,this.constructor=o,this.instancePrototype=u,this.rawDestructor=m,this.baseClass=T,this.getActualType=C,this.upcast=P,this.downcast=S,this.pureVirtualFunctions=[]}var es=(a,o,u)=>{for(;o!==u;)o.upcast||W(`Expected null or instance of ${u.name}, got an instance of ${o.name}`),a=o.upcast(a),o=o.baseClass;return a};function yn(a,o){if(o===null)return this.isReference&&W(`null is not a valid ${this.name}`),0;o.$$||W(`Cannot pass "${ys(o)}" as a ${this.name}`),o.$$.ptr||W(`Cannot pass deleted object as a pointer of type ${this.name}`);var u=o.$$.ptrType.registeredClass,m=es(o.$$.ptr,u,this.registeredClass);return m}function kn(a,o){var u;if(o===null)return this.isReference&&W(`null is not a valid ${this.name}`),this.isSmartPointer?(u=this.rawConstructor(),a!==null&&a.push(this.rawDestructor,u),u):0;(!o||!o.$$)&&W(`Cannot pass "${ys(o)}" as a ${this.name}`),o.$$.ptr||W(`Cannot pass deleted object as a pointer of type ${this.name}`),!this.isConst&&o.$$.ptrType.isConst&&W(`Cannot convert argument of type ${o.$$.smartPtrType?o.$$.smartPtrType.name:o.$$.ptrType.name} to parameter type ${this.name}`);var m=o.$$.ptrType.registeredClass;if(u=es(o.$$.ptr,m,this.registeredClass),this.isSmartPointer)switch(o.$$.smartPtr===void 0&&W("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:o.$$.smartPtrType===this?u=o.$$.smartPtr:W(`Cannot convert argument of type ${o.$$.smartPtrType?o.$$.smartPtrType.name:o.$$.ptrType.name} to parameter type ${this.name}`);break;case 1:u=o.$$.smartPtr;break;case 2:if(o.$$.smartPtrType===this)u=o.$$.smartPtr;else{var T=o.clone();u=this.rawShare(u,ws.toHandle(()=>T.delete())),a!==null&&a.push(this.rawDestructor,u)}break;default:W("Unsupporting sharing policy")}return u}function Tn(a,o){if(o===null)return this.isReference&&W(`null is not a valid ${this.name}`),0;o.$$||W(`Cannot pass "${ys(o)}" as a ${this.name}`),o.$$.ptr||W(`Cannot pass deleted object as a pointer of type ${this.name}`),o.$$.ptrType.isConst&&W(`Cannot convert argument of type ${o.$$.ptrType.name} to parameter type ${this.name}`);var u=o.$$.ptrType.registeredClass,m=es(o.$$.ptr,u,this.registeredClass);return m}function ss(a){return this.fromWireType(k[a>>2])}var En=()=>{Object.assign(rs.prototype,{getPointee(a){return this.rawGetPointee&&(a=this.rawGetPointee(a)),a},destructor(a){var o;(o=this.rawDestructor)==null||o.call(this,a)},argPackAdvance:ee,readValueFromPointer:ss,fromWireType:fn})};function rs(a,o,u,m,T,C,P,S,L,$,B){this.name=a,this.registeredClass=o,this.isReference=u,this.isConst=m,this.isSmartPointer=T,this.pointeeType=C,this.sharingPolicy=P,this.rawGetPointee=S,this.rawConstructor=L,this.rawShare=$,this.rawDestructor=B,!T&&o.baseClass===void 0?m?(this.toWireType=yn,this.destructorFunction=null):(this.toWireType=Tn,this.destructorFunction=null):this.toWireType=kn}var xn=(a,o,u)=>{s.hasOwnProperty(a)||Qe("Replacing nonexistent public symbol"),s[a].overloadTable!==void 0&&u!==void 0||(s[a]=o,s[a].argCount=u)},Sn=(a,o,u)=>{a=a.replace(/p/g,"i");var m=s["dynCall_"+a];return m(o,...u)},ns=[],tr,er=a=>{var o=ns[a];return o||(a>=ns.length&&(ns.length=a+1),ns[a]=o=tr.get(a)),o},In=(a,o,u=[])=>{if(a.includes("j"))return Sn(a,o,u);var m=er(o)(...u);return m},Cn=(a,o)=>(...u)=>In(a,o,u),se=(a,o)=>{a=Pt(a);function u(){return a.includes("j")?Cn(a,o):er(o)}var m=u();return typeof m!="function"&&W(`unknown function pointer with signature ${a}: ${o}`),m},An=(a,o)=>{var u=ts(o,function(m){this.name=o,this.message=m;var T=new Error(m).stack;T!==void 0&&(this.stack=this.toString()+`
`+T.replace(/^Error(:[^\n]*)?\n/,""))});return u.prototype=Object.create(a.prototype),u.prototype.constructor=u,u.prototype.toString=function(){return this.message===void 0?this.name:`${this.name}: ${this.message}`},u},sr,Pn=a=>{var o=_r(a),u=Pt(o);return jt(o),u},Fe=(a,o)=>{var u=[],m={};function T(C){if(!m[C]&&!Ee[C]){if(qe[C]){qe[C].forEach(T);return}u.push(C),m[C]=!0}}throw o.forEach(T),new sr(`${a}: `+u.map(Pn).join([", "]))},Ln=(a,o,u,m,T,C,P,S,L,$,B,F,q)=>{B=Pt(B),C=se(T,C),S&&(S=se(P,S)),$&&($=se(L,$)),q=se(F,q);var ut=bn(B);mn(ut,function(){Fe(`Cannot construct ${B} due to unbound types`,[m])}),pe([a,o,u],m?[m]:[],kt=>{var gr;kt=kt[0];var ne,Kt;m?(ne=kt.registeredClass,Kt=ne.instancePrototype):Kt=Ze.prototype;var ie=ts(B,function(...Ts){if(Object.getPrototypeOf(this)!==He)throw new xe("Use 'new' to construct "+B);if(Ct.constructor_body===void 0)throw new xe(B+" has no accessible constructor");var br=Ct.constructor_body[Ts.length];if(br===void 0)throw new xe(`Tried to invoke ctor of ${B} with invalid number of parameters (${Ts.length}) - expected (${Object.keys(Ct.constructor_body).toString()}) parameters instead!`);return br.apply(this,Ts)}),He=Object.create(Kt,{constructor:{value:ie}});ie.prototype=He;var Ct=new wn(B,ie,He,q,ne,C,S,$);Ct.baseClass&&((gr=Ct.baseClass).__derivedClasses??(gr.__derivedClasses=[]),Ct.baseClass.__derivedClasses.push(Ct));var vi=new rs(B,Ct,!0,!1,!1),mr=new rs(B+"*",Ct,!1,!1,!1),vr=new rs(B+" const*",Ct,!1,!0,!1);return Js[a]={pointerType:mr,constPointerType:vr},xn(ut,ie),[vi,mr,vr]})},rr=(a,o)=>{for(var u=[],m=0;m<a;m++)u.push(k[o+m*4>>2]);return u},nr=a=>{for(;a.length;){var o=a.pop(),u=a.pop();u(o)}};function ir(a){for(var o=1;o<a.length;++o)if(a[o]!==null&&a[o].destructorFunction===void 0)return!0;return!1}function Rn(a,o){if(!(a instanceof Function))throw new TypeError(`new_ called with constructor type ${typeof a} which is not a function`);var u=ts(a.name||"unknownFunctionName",function(){});u.prototype=a.prototype;var m=new u,T=a.apply(m,o);return T instanceof Object?T:m}function Nn(a,o,u,m){for(var T=ir(a),C=a.length,P="",S="",L=0;L<C-2;++L)P+=(L!==0?", ":"")+"arg"+L,S+=(L!==0?", ":"")+"arg"+L+"Wired";var $=`
        return function (${P}) {
        if (arguments.length !== ${C-2}) {
          throwBindingError('function ' + humanName + ' called with ' + arguments.length + ' arguments, expected ${C-2}');
        }`;T&&($+=`var destructors = [];
`);var B=T?"destructors":"null",F=["humanName","throwBindingError","invoker","fn","runDestructors","retType","classParam"];o&&($+="var thisWired = classParam['toWireType']("+B+`, this);
`);for(var L=0;L<C-2;++L)$+="var arg"+L+"Wired = argType"+L+"['toWireType']("+B+", arg"+L+`);
`,F.push("argType"+L);if(o&&(S="thisWired"+(S.length>0?", ":"")+S),$+=(u||m?"var rv = ":"")+"invoker(fn"+(S.length>0?", ":"")+S+`);
`,T)$+=`runDestructors(destructors);
`;else for(var L=o?1:2;L<a.length;++L){var q=L===1?"thisWired":"arg"+(L-2)+"Wired";a[L].destructorFunction!==null&&($+=`${q}_dtor(${q});
`,F.push(`${q}_dtor`))}return u&&($+=`var ret = retType['fromWireType'](rv);
return ret;
`),$+=`}
`,[F,$]}function or(a,o,u,m,T,C){var P=o.length;P<2&&W("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var S=o[1]!==null&&u!==null,L=ir(o),$=o[0].name!=="void",B=[a,W,m,T,nr,o[0],o[1]],F=0;F<P-2;++F)B.push(o[F+2]);if(!L)for(var F=S?1:2;F<o.length;++F)o[F].destructorFunction!==null&&B.push(o[F].destructorFunction);let[q,ut]=Nn(o,S,$,C);q.push(ut);var kt=Rn(Function,q)(...B);return ts(a,kt)}var Dn=(a,o,u,m,T,C)=>{var P=rr(o,u);T=se(m,T),pe([],[a],S=>{S=S[0];var L=`constructor ${S.name}`;if(S.registeredClass.constructor_body===void 0&&(S.registeredClass.constructor_body=[]),S.registeredClass.constructor_body[o-1]!==void 0)throw new xe(`Cannot register multiple constructors with identical number of parameters (${o-1}) for class '${S.name}'! Overload resolution is currently only performed using the parameter count, not actual type info!`);return S.registeredClass.constructor_body[o-1]=()=>{Fe(`Cannot construct ${S.name} due to unbound types`,P)},pe([],P,$=>($.splice(1,0,null),S.registeredClass.constructor_body[o-1]=or(L,$,null,T,C),[])),[]})},On=a=>{a=a.trim();const o=a.indexOf("(");return o!==-1?a.substr(0,o):a},$n=(a,o,u,m,T,C,P,S,L)=>{var $=rr(u,m);o=Pt(o),o=On(o),C=se(T,C),pe([],[a],B=>{B=B[0];var F=`${B.name}.${o}`;o.startsWith("@@")&&(o=Symbol[o.substring(2)]),S&&B.registeredClass.pureVirtualFunctions.push(o);function q(){Fe(`Cannot call ${F} due to unbound types`,$)}var ut=B.registeredClass.instancePrototype,kt=ut[o];return kt===void 0||kt.overloadTable===void 0&&kt.className!==B.name&&kt.argCount===u-2?(q.argCount=u-2,q.className=B.name,ut[o]=q):(Zs(ut,o,F),ut[o].overloadTable[u-2]=q),pe([],$,ne=>{var Kt=or(F,ne,B,C,P,L);return ut[o].overloadTable===void 0?(Kt.argCount=u-2,ut[o]=Kt):ut[o].overloadTable[u-2]=Kt,[]}),[]})},ar=(a,o,u)=>(a instanceof Object||W(`${u} with invalid "this": ${a}`),a instanceof o.registeredClass.constructor||W(`${u} incompatible with "this" of type ${a.constructor.name}`),a.$$.ptr||W(`cannot call emscripten binding method ${u} on deleted object`),es(a.$$.ptr,a.$$.ptrType.registeredClass,o.registeredClass)),Bn=(a,o,u,m,T,C,P,S,L,$)=>{o=Pt(o),T=se(m,T),pe([],[a],B=>{B=B[0];var F=`${B.name}.${o}`,q={get(){Fe(`Cannot access ${F} due to unbound types`,[u,P])},enumerable:!0,configurable:!0};return L?q.set=()=>Fe(`Cannot access ${F} due to unbound types`,[u,P]):q.set=ut=>W(F+" is a read-only property"),Object.defineProperty(B.registeredClass.instancePrototype,o,q),pe([],L?[u,P]:[u],ut=>{var kt=ut[0],ne={get(){var ie=ar(this,B,F+" getter");return kt.fromWireType(T(C,ie))},enumerable:!0};if(L){L=se(S,L);var Kt=ut[1];ne.set=function(ie){var He=ar(this,B,F+" setter"),Ct=[];L($,He,Kt.toWireType(Ct,ie)),nr(Ct)}}return Object.defineProperty(B.registeredClass.instancePrototype,o,ne),[]}),[]})},bs=[],re=[],Mn=a=>{a>9&&--re[a+1]===0&&(re[a]=void 0,bs.push(a))},Un=()=>re.length/2-5-bs.length,Fn=()=>{re.push(0,1,void 0,1,null,1,!0,1,!1,1),s.count_emval_handles=Un},ws={toValue:a=>(a||W("Cannot use deleted val. handle = "+a),re[a]),toHandle:a=>{switch(a){case void 0:return 2;case null:return 4;case!0:return 6;case!1:return 8;default:{const o=bs.pop()||re.length;return re[o]=a,re[o+1]=1,o}}}},Hn={name:"emscripten::val",fromWireType:a=>{var o=ws.toValue(a);return Mn(a),o},toWireType:(a,o)=>ws.toHandle(o),argPackAdvance:ee,readValueFromPointer:ss,destructorFunction:null},Wn=a=>Vt(a,Hn),ys=a=>{if(a===null)return"null";var o=typeof a;return o==="object"||o==="array"||o==="function"?a.toString():""+a},Gn=(a,o)=>{switch(o){case 4:return function(u){return this.fromWireType(N[u>>2])};case 8:return function(u){return this.fromWireType(J[u>>3])};default:throw new TypeError(`invalid float width (${o}): ${a}`)}},Vn=(a,o,u)=>{o=Pt(o),Vt(a,{name:o,fromWireType:m=>m,toWireType:(m,T)=>T,argPackAdvance:ee,readValueFromPointer:Gn(o,u),destructorFunction:null})},jn=(a,o,u)=>{switch(o){case 1:return u?m=>w[m]:m=>y[m];case 2:return u?m=>I[m>>1]:m=>A[m>>1];case 4:return u?m=>E[m>>2]:m=>k[m>>2];default:throw new TypeError(`invalid integer width (${o}): ${a}`)}},Kn=(a,o,u,m,T)=>{o=Pt(o);var C=B=>B;if(m===0){var P=32-8*u;C=B=>B<<P>>>P}var S=o.includes("unsigned"),L=(B,F)=>{},$;S?$=function(B,F){return L(F,this.name),F>>>0}:$=function(B,F){return L(F,this.name),F},Vt(a,{name:o,fromWireType:C,toWireType:$,argPackAdvance:ee,readValueFromPointer:jn(o,u,m!==0),destructorFunction:null})},zn=(a,o,u)=>{var m=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],T=m[o];function C(P){var S=k[P>>2],L=k[P+4>>2];return new T(w.buffer,L,S)}u=Pt(u),Vt(a,{name:u,fromWireType:C,argPackAdvance:ee,readValueFromPointer:C},{ignoreDuplicateRegistrations:!0})},Yn=(a,o,u,m)=>{if(!(m>0))return 0;for(var T=u,C=u+m-1,P=0;P<a.length;++P){var S=a.charCodeAt(P);if(S>=55296&&S<=57343){var L=a.charCodeAt(++P);S=65536+((S&1023)<<10)|L&1023}if(S<=127){if(u>=C)break;o[u++]=S}else if(S<=2047){if(u+1>=C)break;o[u++]=192|S>>6,o[u++]=128|S&63}else if(S<=65535){if(u+2>=C)break;o[u++]=224|S>>12,o[u++]=128|S>>6&63,o[u++]=128|S&63}else{if(u+3>=C)break;o[u++]=240|S>>18,o[u++]=128|S>>12&63,o[u++]=128|S>>6&63,o[u++]=128|S&63}}return o[u]=0,u-T},Xn=(a,o,u)=>Yn(a,y,o,u),qn=a=>{for(var o=0,u=0;u<a.length;++u){var m=a.charCodeAt(u);m<=127?o++:m<=2047?o+=2:m>=55296&&m<=57343?(o+=4,++u):o+=3}return o},lr=typeof TextDecoder<"u"?new TextDecoder:void 0,cr=(a,o,u)=>{for(var m=o+u,T=o;a[T]&&!(T>=m);)++T;if(T-o>16&&a.buffer&&lr)return lr.decode(a.subarray(o,T));for(var C="";o<T;){var P=a[o++];if(!(P&128)){C+=String.fromCharCode(P);continue}var S=a[o++]&63;if((P&224)==192){C+=String.fromCharCode((P&31)<<6|S);continue}var L=a[o++]&63;if((P&240)==224?P=(P&15)<<12|S<<6|L:P=(P&7)<<18|S<<12|L<<6|a[o++]&63,P<65536)C+=String.fromCharCode(P);else{var $=P-65536;C+=String.fromCharCode(55296|$>>10,56320|$&1023)}}return C},Qn=(a,o)=>a?cr(y,a,o):"",Jn=(a,o)=>{o=Pt(o);var u=o==="std::string";Vt(a,{name:o,fromWireType(m){var T=k[m>>2],C=m+4,P;if(u)for(var S=C,L=0;L<=T;++L){var $=C+L;if(L==T||y[$]==0){var B=$-S,F=Qn(S,B);P===void 0?P=F:(P+="\0",P+=F),S=$+1}}else{for(var q=new Array(T),L=0;L<T;++L)q[L]=String.fromCharCode(y[C+L]);P=q.join("")}return jt(m),P},toWireType(m,T){T instanceof ArrayBuffer&&(T=new Uint8Array(T));var C,P=typeof T=="string";P||T instanceof Uint8Array||T instanceof Uint8ClampedArray||T instanceof Int8Array||W("Cannot pass non-string to std::string"),u&&P?C=qn(T):C=T.length;var S=ks(4+C+1),L=S+4;if(k[S>>2]=C,u&&P)Xn(T,L,C+1);else if(P)for(var $=0;$<C;++$){var B=T.charCodeAt($);B>255&&(jt(L),W("String has UTF-16 code units that do not fit in 8 bits")),y[L+$]=B}else for(var $=0;$<C;++$)y[L+$]=T[$];return m!==null&&m.push(jt,S),S},argPackAdvance:ee,readValueFromPointer:ss,destructorFunction(m){jt(m)}})},hr=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0,Zn=(a,o)=>{for(var u=a,m=u>>1,T=m+o/2;!(m>=T)&&A[m];)++m;if(u=m<<1,u-a>32&&hr)return hr.decode(y.subarray(a,u));for(var C="",P=0;!(P>=o/2);++P){var S=I[a+P*2>>1];if(S==0)break;C+=String.fromCharCode(S)}return C},ti=(a,o,u)=>{if(u??(u=2147483647),u<2)return 0;u-=2;for(var m=o,T=u<a.length*2?u/2:a.length,C=0;C<T;++C){var P=a.charCodeAt(C);I[o>>1]=P,o+=2}return I[o>>1]=0,o-m},ei=a=>a.length*2,si=(a,o)=>{for(var u=0,m="";!(u>=o/4);){var T=E[a+u*4>>2];if(T==0)break;if(++u,T>=65536){var C=T-65536;m+=String.fromCharCode(55296|C>>10,56320|C&1023)}else m+=String.fromCharCode(T)}return m},ri=(a,o,u)=>{if(u??(u=2147483647),u<4)return 0;for(var m=o,T=m+u-4,C=0;C<a.length;++C){var P=a.charCodeAt(C);if(P>=55296&&P<=57343){var S=a.charCodeAt(++C);P=65536+((P&1023)<<10)|S&1023}if(E[o>>2]=P,o+=4,o+4>T)break}return E[o>>2]=0,o-m},ni=a=>{for(var o=0,u=0;u<a.length;++u){var m=a.charCodeAt(u);m>=55296&&m<=57343&&++u,o+=4}return o},ii=(a,o,u)=>{u=Pt(u);var m,T,C,P;o===2?(m=Zn,T=ti,P=ei,C=S=>A[S>>1]):o===4&&(m=si,T=ri,P=ni,C=S=>k[S>>2]),Vt(a,{name:u,fromWireType:S=>{for(var L=k[S>>2],$,B=S+4,F=0;F<=L;++F){var q=S+4+F*o;if(F==L||C(q)==0){var ut=q-B,kt=m(B,ut);$===void 0?$=kt:($+="\0",$+=kt),B=q+o}}return jt(S),$},toWireType:(S,L)=>{typeof L!="string"&&W(`Cannot pass non-string to C++ string type ${u}`);var $=P(L),B=ks(4+$+o);return k[B>>2]=$/o,T(L,B+4,$+o),S!==null&&S.push(jt,B),B},argPackAdvance:ee,readValueFromPointer:ss,destructorFunction(S){jt(S)}})},oi=(a,o)=>{o=Pt(o),Vt(a,{isVoid:!0,name:o,argPackAdvance:0,fromWireType:()=>{},toWireType:(u,m)=>{}})},ai=1,li=()=>ai,ci=(a,o,u)=>y.copyWithin(a,o,o+u),hi=()=>Date.now(),dr;dr=()=>performance.now();var di=()=>2147483648,ui=a=>{var o=v.buffer,u=(a-o.byteLength+65535)/65536;try{return v.grow(u),D(),1}catch{}},_i=a=>{var o=y.length;a>>>=0;var u=di();if(a>u)return!1;for(var m=(L,$)=>L+($-L%$)%$,T=1;T<=4;T*=2){var C=o*(1+.2/T);C=Math.min(C,a+100663296);var P=Math.min(u,m(Math.max(a,C),65536)),S=ui(P);if(S)return!0}return!1},fi=[null,[],[]],pi=(a,o)=>{var u=fi[a];o===0||o===10?((a===1?p:b)(cr(u,0)),u.length=0):u.push(o)},mi=(a,o,u,m)=>{for(var T=0,C=0;C<u;C++){var P=k[o>>2],S=k[o+4>>2];o+=8;for(var L=0;L<S;L++)pi(a,y[P+L]);T+=S}return k[m>>2]=T,0};sn(),xe=s.BindingError=class extends Error{constructor(o){super(o),this.name="BindingError"}},Ys=s.InternalError=class extends Error{constructor(o){super(o),this.name="InternalError"}},pn(),dn(),En(),sr=s.UnboundTypeError=An(Error,"UnboundTypeError"),Fn();var ur={__cxa_throw:Xe,_abort_js:tn,_embind_register_bigint:en,_embind_register_bool:nn,_embind_register_class:Ln,_embind_register_class_constructor:Dn,_embind_register_class_function:$n,_embind_register_class_property:Bn,_embind_register_emval:Wn,_embind_register_float:Vn,_embind_register_integer:Kn,_embind_register_memory_view:zn,_embind_register_std_string:Jn,_embind_register_std_wstring:ii,_embind_register_void:oi,_emscripten_get_now_is_monotonic:li,_emscripten_memcpy_js:ci,emscripten_date_now:hi,emscripten_get_now:dr,emscripten_resize_heap:_i,fd_write:mi},Ut=De(),_r=a=>(_r=Ut.__getTypeName)(a),ks=a=>(ks=Ut.malloc)(a),jt=a=>(jt=Ut.free)(a),fr=a=>(fr=Ut.__cxa_is_pointer_type)(a);s.dynCall_jiji=(a,o,u,m,T)=>(s.dynCall_jiji=Ut.dynCall_jiji)(a,o,u,m,T);var is;lt=function a(){is||pr(),is||(lt=a)};function pr(){if(tt>0||(ot(),tt>0))return;function a(){var o;is||(is=!0,s.calledRun=!0,!g&&(pt(),r(s),(o=s.onRuntimeInitialized)==null||o.call(s),Wt()))}s.setStatus?(s.setStatus("Running..."),setTimeout(function(){setTimeout(function(){s.setStatus("")},1),a()},1)):a()}if(s.preInit)for(typeof s.preInit=="function"&&(s.preInit=[s.preInit]);s.preInit.length>0;)s.preInit.pop()();return pr(),e=i,e}})();class lo{constructor(){this.module=null,this.server=null,this.isReady=ao().then(t=>{this.module=t,this.server=new t.GameServer})}send_templates(t,e){const s=this.server;for(const[r,n]of t){const i=r+"";{const{name:c,desc:h,width:d,height:f,placeW:p,placeH:b}=n;s.new_template(i,c,h,d,f,p,b)}for(const c of n.cells){const{x:h,y:d,w:f,h:p,r:b}=c.dimensions;s.add_cell(i,c.id+"",c.type,c.value,h,d,f,p,b)}for(const c of n.links){const{id:h,bid_src:d,cid_src:f,tgt_src:p,bid_dst:b,cid_dst:_,tgt_dst:v,clr:g}=c,w=new Uint32Array([g]);s.add_link(i,h+"",d+"",f+"",p,b+"",_+"",v,w[0])}for(const c of n.blocks){const{x:h,y:d,w:f,h:p,r:b}=c.dimensions;s.add_block(i,c.id+"",c.templateId+"",h,d,f,p,b)}}for(const[r,n]of t)s.print_template_counts(r+"")}simulation_rebuild(t,e){this.server.simulation_rebuild(t+"",e)}simulation_update(t){this.server.simulation_update(t)}simulation_get_cell_value(t,e,s){return this.server.simulation_get_cell_value(t+"",e,s)}simulation_get_child_simblock(t,e){return this.server.simulation_get_child_simblock(t+"",e)}simulation_set_cell_value(t,e,s){return this.server.simulation_set_cell_value(t+"",e+"",s)}}class Yt{static memcopy(t,e,s,r,n){if(n>1024&&t.set&s.subarray)t.set(s.subarray(r,r+n),e);else for(let i=0;i<n;i++)t[e+i]=s[r+i]}static memmove(t,e,s,r){if(t.copyWithin)t.copyWithin(e,s,s+r);else{const n=new Array(r);for(let i=0;i<r;i++)n[i]=t[s+i];for(let i=0;i<r;i++)t[e+i]=n[i]}}static memswap(t,e,s,r,n){const i=new t.constructor(n);Yt.memcopy(i,0,t,e,n),Yt.memcopy(t,e,s,r,n),Yt.memcopy(s,r,i,0,n)}static memreverse(t,e,s,r,n){const i=r+n-1;for(let c=0;c<n;c++)t[e+c]=s[i-c]}static resize(t,e,s=!1){const r=t.constructor,n=t.length,i=new r(e);return s&&Yt.memcopy(i,0,t,0,Math.min(n,e)),i}}class cs{constructor(t,e,s){this.type=t,this.data=new t(e*s),this.w=e,this.h=s}get cols(){return this.w}get rows(){return this.h}index(t,e){return this.w*e+t}get(t,e){return this.data[this.w*e+t]}set(t,e,s){this.data[this.w*e+t]=s}setRow(t,e){this.data.set(e,this.index(0,t))}copy(t){Yt.memcopy(this.data,0,t.data,0,t.data.length)}clone(){const t=new cs(this.type,this.w,this.h);return t.copy(this),t}toString(t=8,e=-1){const s=new Array(t).fill(" ").join("");let r="";for(let n=0;n<this.h;n++){for(let i=0;i<this.w;i++){const c=this.get(i,n),h=e>=0?c.toFixed(e):c.toString(),d=(s+h).slice(-t);r+=`${d},`}r+=`
`}return r}swapRows(t,e){const s=this.index(0,t),r=this.index(0,e);Yt.memswap(this.data,s,this.data,r,this.w)}scaleRow(t,e){const s=this.index(0,t);for(let r=0;r<this.w;r++)this.data[s+r]*=e}addRow(t,e,s){const r=this.index(0,t),n=this.index(0,e);for(let i=0;i<this.w;i++)this.data[r+i]+=this.data[n+i]*s}}class be{static normalizeTermInMatrix(t,e,s){const r=t.get(e,s);return r==0?!1:(t.scaleRow(s,1/r),!0)}static eliminateTermInMatrix(t,e,s,r){const n=t.get(e,r);n!=0&&t.addRow(r,s,-n)}static trySolveSystemOfEquations_NxN(t,e,s){const r=t.clone(),n=r.rows;for(let i=0;i<n;i++){const c=i;let h=4294967295;for(let d=i;d<n;d++)if(r.get(c,d)!=0){h=d;break}if(h==4294967295||(h!=i&&r.swapRows(i,h),!be.normalizeTermInMatrix(r,c,i)))return!1;for(let d=i+1;d<n;d++)be.eliminateTermInMatrix(r,c,i,d)}for(let i=n-1;i>0;i--){const c=i;if(!be.normalizeTermInMatrix(r,c,i))return!1;for(let h=0;h<i;h++)be.eliminateTermInMatrix(r,c,i,h)}for(let i=0;i<n;i++)e[i]=r.get(s,i);return!0}}class hs extends Float32Array{constructor(t,e,s,r){super(4),this[0]=t,this[1]=e,this[2]=s,this[3]=r}clone(){return new hs(this.x,this.y,this.w,this.h)}get x(){return this[0]}get y(){return this[1]}get w(){return this[2]}get h(){return this[3]}set x(t){return this[0]=t}set y(t){return this[1]=t}set w(t){return this[2]=t}set h(t){return this[3]=t}get xywh(){return this.slice()}set xywh(t){this.set(t)}get x1(){return this[0]}get y1(){return this[1]}get x2(){return this[0]+this[2]}get y2(){return this[1]+this[3]}get xyxy(){return new Float32Array([this[0],this[1],this[0]+this[2],this[1]+this[3]])}set xyxy(t){this.set([t[0],t[1],t[2]-t[0],t[3]-t[1]],0)}}class we extends Array{constructor(...t){if(t.length===1&&super(...t[0]),t.length===0&&super(0,0,1,0,0,1),t.length===5){super(6);const[e,s,r,n,i]=t,c=Math.sin(i*2*Math.PI),h=Math.cos(i*2*Math.PI);this[0]=e,this[1]=s,this[2]=h*r,this[3]=c*r,this[4]=-c*n,this[5]=h*n}}compose(t){const e=this,s=t,r=new we(s);return e.applyBasis(r,0,6,2),r[0]+=e[0],r[1]+=e[1],r}apply(t,e,s,r){for(let n=e;n<s;n+=r){const i=t[n+0],c=t[n+1];t[n+0]=this[0]+i*this[2]+c*this[4],t[n+1]=this[1]+i*this[3]+c*this[5]}return t}applyOffset(t,e,s,r){for(let n=e;n<s;n+=r)t[n+0]+=this[0],t[n+1]+=this[1];return t}applyBasis(t,e,s,r){for(let n=e;n<s;n+=r){const i=t[n+0],c=t[n+1];t[n+0]=i*this[2]+c*this[4],t[n+1]=i*this[3]+c*this[5]}return t}}class he extends Float32Array{constructor(...t){t.length>0?super(...t):super([0,0])}add(t,e=1){return new he([this[0]+t[0]*e,this[1]+t[1]*e])}scale(t){return new he([this[0]*t,this[1]*t])}hypot(){return Math.hypot(...this)}hypotSquared(){return this[0]*this[0]+this[1]*this[1]}normalize(){return this.scale(1/this.hypot())}round(t){const e=1/t;return new he([Math.round(this[0]*e)*t,Math.round(this[1]*e)*t])}}class vt extends Float32Array{constructor(...t){t.length>0?super(...t):super([0,0,0])}add(t,e=1){return new vt([this[0]+t[0]*e,this[1]+t[1]*e,this[2]+t[2]*e])}scale(t){return new vt([this[0]*t,this[1]*t,this[2]*t])}hypot(){return Math.hypot(...this)}hypotSquared(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]}normalize(){return this.scale(1/this.hypot())}round(t){const e=1/t;return new vt([Math.round(this[0]*e)*t,Math.round(this[1]*e)*t,Math.round(this[2]*e)*t])}}class Ft{static bivector_rotation_inplace(t,e,s,r){for(let n=0;n<3;n++){const i=t[n],c=e[n];t[n]=i*r+c*s,e[n]=c*r-i*s}}static get_AABB_from_points_2d(t,e,s,r){if(s<=e)return new Float32Array([0,0,0,0]);const n=new Float32Array([t[e+0],t[e+1],t[e+0],t[e+1]]);for(let i=e;i<s;i+=r){const c=t[i+0],h=t[i+1];n[0]=Math.min(n[0],c),n[1]=Math.min(n[1],h),n[2]=Math.max(n[2],c),n[3]=Math.max(n[3],h)}return n}static collision_aabb_aabb_2d(t,e){return!(t[0]>e[2]|t[1]>e[3]|t[2]<e[0]|t[3]<e[1])}static collision_aabb_point_2d(t,e){return t[0]<=e[0]&e[0]<=t[2]&t[1]<=e[1]&e[1]<=t[3]}static collision_line_plane_3d(t,e,s,r,n){const c=new cs(Float32Array,4,3),h=new Float32Array(3);for(let v=0;v<3;v++){const g=e[v],w=-r[v],y=-n[v],I=s[v]-t[v];c.setRow(v,[g,w,y,I])}const d=be.trySolveSystemOfEquations_NxN(c,h,3),[f,p,b]=h,_=t.add(e,f);return[d,_]}static collision_line_line_2d(t,e,s,r){const i=new cs(Float32Array,3,2),c=new Float32Array(2);for(let b=0;b<2;b++){const _=e[b],v=-r[b],g=s[b]-t[b];i.setRow(b,[_,v,g])}const h=be.trySolveSystemOfEquations_NxN(i,c,2),[d,f]=c,p=t.add(e,d);return[h,p]}static nearestPoint_point_line_2d(t,e,s){const r=s.add(e,-1),n=new he([-r[1],r[0]]);return Ft.collision_line_line_2d(t,n,e,r)}static nearestPoint_point_line_segment_2d(t,e,s){const[r,n]=Ft.nearestPoint_point_line_2d(t,e,s);t.add(n,-1).hypot();const i=t.add(e,-1).hypot(),c=t.add(s,-1).hypot(),h=new Float32Array(4);h.set(e,0),h.set(s,2);const d=Ft.get_AABB_from_points_2d(h,0,4,2),f=!(n[0]<d[0]|n[0]>d[2]|n[1]<d[1]|n[1]>d[3]);return r&f?n:i<=c?e:s}}let ht=class ve{static verifyObjectEntriesDefined(t){for(const[e,s]of Object.entries(t))if(s===void 0|s===null)throw`property ${e} is ${s}.`}static verifyType_boolean(t,e){return(t==null?void 0:t.constructor)===e}static verifyType_message(t,e){return`object has constructor <${t.constructor.name}>, expected <${e.name}>.`}static verifyType_throw(t,e){if(!ve.verifyType_boolean(t,e))throw ve.verifyType_message(t,e)}static verifyTypes_boolean(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;s++)if(!ve.verifyType_boolean(t[s],e[s]))return!1;return!0}static verifyTypes_throw(t,e){if(t.length!==e.length)throw`number of objects (${t.length}) and number of types (${e.length}) do not match`;const s=[];for(let r=0;r<t.length;r++)ve.verifyType_boolean(t[r],e[r])||s.push(r);if(s.length>0)throw s.map(r=>ve.verifyType_message(t[r],e[r])).join(`
`)}static getConstructorOverloadIndex_throw(t,e){for(let r=0;r<e.length;r++)if(ve.verifyTypes_boolean(t,e[r]))return r;const s=[];for(const r of t)s.push(r==null?void 0:r.constructor.name);throw`no constructor overload found for arguments: ${JSON.stringify({args:t,constructors:s})}`}};class Is{static tryUntilTruthy(t,e,s,r){return new Promise((n,i)=>{let c=0;const h=setInterval(()=>{const d=t(e);d?(n(d),clearInterval(h)):(c++,c>=r&&(i(null),clearInterval(h)))},s)})}}const Se=class Se{static next(){return Se._next++}};R(Se,"NONE",0),R(Se,"THIS_BLOCK",1),R(Se,"_next",Date.now());let j=Se;class $t{constructor(t=0,e=0,s=1,r=1,n=0){this.x=t,this.y=e,this.w=s,this.h=r,this.r=n}save(){const{x:t,y:e,w:s,h:r,r:n}=this;return[t,e,s,r,n]}static load(t){const[e,s,r,n,i]=t;return new $t(e,s,r,n,i)}clone(){return this.load(this.save())}}class ct{static str_to_u32(t){let e=0;for(let s=0;s<t.length;s++)e=e<<8|t.charCodeAt(s)&255;return e}static u32_to_str(t){let e=[];for(let r=0;r<4;r++)e.push(t&255),t>>=8;let s="";for(let r=0;r<4;r++)s+=String.fromCharCode(e.pop());return s}constructor(t,e,s){this.type=ct.str_to_u32(t),this.tstr=t,this.clr=e,this.name=s}}const Ae={CONSTANT:new ct("CNST",1333755903,"constant value"),COPY:new ct("COPY",1869574143,"copy value from input"),OR:new ct("OR",2732892927,"OR"),XOR:new ct("XOR",4294967295,"XOR"),NOT:new ct("NOT",3864848127,"NOT"),AND:new ct("AND",2106097151,"AND"),LSHIFT:new ct("LSH",4294967295,"L-SHIFT"),RSHIFT:new ct("RSH",4294967295,"R-SHIFT"),ADD:new ct("+",4008242943,"+ ADD"),SUB:new ct("-",4294967295,"- SUB"),MULT:new ct("x",4294967295,"x MUL"),DIV:new ct("รท",4294967295,"รท DIV"),GTH:new ct(">",4294967295,"> GTH"),LTH:new ct("<",4294967295,"< LTH"),EQUALS:new ct("==",4294967295,"== EQUALS"),GEQ:new ct(">=",4294967295,">= GEQ"),LEQ:new ct("<=",4294967295,"<= LEQ")},Os=new Map;for(const[l,t]of Object.entries(Ae))Os.set(t.type,t);const Ie=class Ie{constructor(...t){if(this.dimensions=null,this.id=j.NONE,this.type=0,this.value=0,ht.getConstructorOverloadIndex_throw(t,[[],[Number,Number]])===1){const[s,r]=t;this.dimensions=new $t(0,0,1,1,0),this.id=j.next(),this.type=s,this.value=r}}get clr(){return Os.get(this.type).clr}get typeString(){return Os.get(this.type).tstr}get numTargets(){return this.type===Ae.CONSTANT.type?1:this.type===Ae.COPY.type||this.type===Ae.NOT.type?2:3}save(){const{dimensions:t,id:e,type:s,value:r}=this;return{dim:t.save(),id:e,type:s,value:r}}static load(t){const e=new Ie;return Object.assign(e,t),e.dimensions=$t.load(t.dim),e}clone(){return Ie.load(this.save())}get LINK_TARGET(){return Ie.LINK_TARGET}static canLinkTargets(t,e){const s=1<<t|1<<e;return s===3|s===5}};R(Ie,"LINK_TARGET",{OUTPUT:0,INPUT_A:1,INPUT_B:2,NONE:7});let rt=Ie;const us=class us{static onChange(){this.counter++}constructor(t){this.valueFunc=t,this._state=null,this._value=null}get value(){const t=us.counter;return this._state!==t&&(this._state=t,this._value=this.valueFunc()),this._value}};R(us,"counter",0);let Tt=us;class Lt{constructor(...t){if(this.dimensions=null,this.id=j.NONE,this.templateId=j.NONE,ht.getConstructorOverloadIndex_throw(t,[[],[$t,Number]])===1){const[s,r]=t;this.dimensions=s,this.id=j.next(),this.templateId=r}}save(){const{dimensions:t,id:e,templateId:s}=this;return{dim:t.save(),id:e,templateId:s}}static load(t){const e=new Lt;return Object.assign(e,t),e.dimensions=$t.load(t.dim),e}clone(){return Lt.load(this.save())}get template(){return x.blockLibrary.templates.get(this.templateId)}get templateWidth(){return this.template.width}get templateHeight(){return this.template.height}set templateWidth(t){this.template.width=t}set templateHeight(t){this.template.height=t}get cells(){return this.template.cells}get links(){return this.template.links}get texts(){return this.template.texts}get blocks(){return this.template.blocks}insertCell(t){return ht.verifyType_throw(t,rt),this.template.insertCell(t),Tt.onChange(),x.onRootContentChanged_addCell(t),t}insertLink(t){return ht.verifyType_throw(t,de),this.cleanupBeforeInsertLink(t),this.template.insertLink(t),Tt.onChange(),x.onRootContentChanged_addLink(t),t}insertText(t){return ht.verifyType_throw(t,Ne),this.template.insertText(t),Tt.onChange(),t}insertBlock(t){return ht.verifyType_throw(t,Lt),this.template.insertBlock(t),Tt.onChange(),x.onRootContentChanged_addBlock(t),t}deleteCell(t){ht.verifyType_throw(t,rt),this.cleanupBeforeDeleteCell(t).then(e=>{console.debug("<>deleteCell() confirmed",e),e&&(this.template.removeCell(t),Tt.onChange(),x.onRootContentChanged_remCell(t))})}deleteLink(t){ht.verifyType_throw(t,de),this.template.removeLink(t),Tt.onChange(),x.onRootContentChanged_remLink(t)}deleteText(t){ht.verifyType_throw(t,Ne),this.template.removeText(t),Tt.onChange()}deleteBlock(t){ht.verifyType_throw(t,Lt),this.cleanupBeforeDeleteBlock(t),this.template.removeBlock(t),Tt.onChange(),x.onRootContentChanged_remBlock(t)}cleanupBeforeInsertLink(t){t.bid_src===this.id&&(t.bid_src=j.THIS_BLOCK),t.bid_dst===this.id&&(t.bid_dst=j.THIS_BLOCK);for(const e of this.links)if(de.hasSameDstTarget(t,e)){this.deleteLink(e),x.onRootContentChanged_remLink(e);break}}cleanupBeforeDeleteBlock(t){for(const e of this.links.slice())e.isConnectedToBlock(t.id)&&this.deleteLink(e)}cleanupBeforeDeleteCell(t){const e=this.templateId,s=t.id,n=x.blockLibrary.getLinksThatPointToCellInTemplate(e,s,!1);return console.debug("deletionList",n),new Promise((c,h)=>{if(console.debug("<>cleanupBeforeDeleteCell promise",n),n.length===0)c(!0);else{const d=()=>{console.debug("<>cleanupBeforeDeleteCell submit"),x.blockLibrary.deleteLinksInTemplateLinkList(n),x.gameUI.hideLinkDeletionPopup(),c(!0)},f=()=>{console.debug("<>cleanupBeforeDeleteCell cancel"),x.gameUI.hideLinkDeletionPopup(),c(!1)};x.gameUI.showLinkDeletionPopup(n,"WARNING - links in the following templates will also be deleted:",d,f)}}).then(c=>{if(c)for(const h of this.links.slice())h.isConnectedToCell(t.id)&&this.deleteLink(h);return c})}}class de{constructor(...t){this.id=j.NONE,this.bid_src=j.NONE,this.cid_src=j.NONE,this.tgt_src=rt.LINK_TARGET.OUTPUT,this.bid_dst=j.NONE,this.cid_dst=j.NONE,this.tgt_dst=0,this.clr=4291620607;const e=ht.getConstructorOverloadIndex_throw(t,[[],[Lt,Lt,rt,rt,Number,Number],[Number,Number,Number,Number,Number,Number]]);if(e===1){const[s,r,n,i,c,h]=t;this.id=j.next(),this.bid_src=s.id,this.cid_src=n.id,this.bid_dst=r.id,this.cid_dst=i.id,this.tgt_dst=c,this.clr=h}if(e===2){const[s,r,n,i,c,h]=t;this.id=j.next(),this.bid_src=s,this.cid_src=n,this.bid_dst=r,this.cid_dst=i,this.tgt_dst=c,this.clr=h}}save(){const{id:t,bid_src:e,bid_dst:s,cid_src:r,cid_dst:n,tgt_dst:i,clr:c}=this;return{id:t,src_addr:[e,r],dst_addr:[s,n,i],clr:c}}static load(t){const{id:e,src_addr:s,dst_addr:r,clr:n}=t,[i,c]=s,[h,d,f]=r,p={id:e,bid_src:i,bid_dst:h,cid_src:c,cid_dst:d,tgt_dst:f,clr:n},b=new de;return Object.assign(b,p),b}clone(){return de.load(this.save())}isConnectedToCell(t){return this.cid_src===t|this.cid_dst===t}isConnectedToBlock(t){return this.bid_src===t|this.bid_dst===t}static hasSameDstTarget(t,e){return t.bid_dst===e.bid_dst&t.cid_dst===e.cid_dst&t.tgt_dst===e.tgt_dst}}class Ne{constructor(...t){if(this.id=j.NONE,this.dimensions=null,this.str=null,this.fhgt=1,this.fclr=255,this.bclr=4294967295,this.oclr=255,ht.getConstructorOverloadIndex_throw(t,[[],[$t,Number,Number,Number,Number,String]])===1){const[s,r,n,i,c,h]=t;this.id=j.next(),this.dimensions=s,this.str=h,this.fhgt=r,this.fclr=n,this.bclr=i,this.oclr=c}}save(){const{dimensions:t,id:e,str:s,fhgt:r,fclr:n,bclr:i,oclr:c}=this;return{dim:t.save(),id:e,str:s,fhgt:r,fclr:n,bclr:i,oclr:c}}static load(t){const e=new Ne;return Object.assign(e,t),e.dimensions=$t.load(t.dim),e}clone(){return Ne.load(this.save())}}class Ke{constructor(...t){if(this.cells=null,this.links=null,this.texts=null,this.blocks=null,this.templateId=j.NONE,this.width=0,this.height=0,this.placeW=0,this.placeH=0,this.name=null,this.desc=null,ht.getConstructorOverloadIndex_throw(t,[[Number,Number]])===0){const[s,r]=t;this.cells=[],this.links=[],this.texts=[],this.blocks=[],this.templateId=j.next(),this.width=s,this.height=r,this.placeW=s/4,this.placeH=r/4,this.name="NAME_"+this.templateId,this.desc="DESCRIPTION"}}save(){const{cells:t,links:e,texts:s,blocks:r,templateId:n,width:i,height:c,placeW:h,placeH:d,name:f,desc:p}=this,b=[];for(const w of t)b.push(w.save());const _=[];for(const w of e)_.push(w.save());const v=[];for(const w of s)v.push(w.save());const g=[];for(const w of r)g.push(w.save());return{templateId:n,width:i,height:c,placeW:h,placeH:d,name:f,desc:p,cells:b,links:_,texts:v,blocks:g}}static load(t){const{templateId:e,width:s,height:r,placeW:n,placeH:i,name:c,desc:h,cells:d,links:f,texts:p,blocks:b}=t,_=new Ke(s,r);_.templateId=e,_.name=c,_.desc=h,_.placeW=n,_.placeH=i;for(const v of d)_.cells.push(rt.load(v));for(const v of f)_.links.push(de.load(v));for(const v of p)_.texts.push(Ne.load(v));for(const v of b)_.blocks.push(Lt.load(v));return _}insertItem(t,e){t.push(e)}removeItem(t,e){for(let s=0;s<t.length;s++)t[s].id===e.id&&(t[s]=t[t.length-1],t.pop())}insertCell(t){this.insertItem(this.cells,t)}insertLink(t){this.insertItem(this.links,t)}insertText(t){this.insertItem(this.texts,t)}insertBlock(t){this.insertItem(this.blocks,t)}removeCell(t){this.removeItem(this.cells,t)}removeLink(t){this.removeItem(this.links,t)}removeText(t){this.removeItem(this.texts,t)}removeBlock(t){this.removeItem(this.blocks,t)}getValidCellTargets(t){const e=new Set,s=new Set,r=new Set,n=new Map;for(const d of this.cells)e.add(d),s.add(d),r.add(d),n.set(d.id,d);for(const d of this.cells){const f=d.numTargets;f<2&&s.delete(d),f<3&&r.delete(d)}const i=rt.LINK_TARGET.OUTPUT,c=rt.LINK_TARGET.INPUT_A,h=rt.LINK_TARGET.INPUT_B;if(!t)for(const d of this.links){const{bid_src:f,bid_dst:p,cid_src:b,cid_dst:_,tgt_src:v,tgt_dst:g}=d;g===i&&e.delete(n.get(_)),g===c&&s.delete(n.get(_)),g===h&&r.delete(n.get(_))}return{out:e,ina:s,inb:r}}}class co{constructor(){R(this,"_countUsedTemplatesInTree_cache",new Map);this.templates=new Map,this.rootBlock=null}_countUsedTemplatesInTree(t){console.log("<>templateId",t);const e=this._countUsedTemplatesInTree_cache;if(e.has(t))return e.get(t);const s=new Map;s.set(t,1),console.log("<>this.templates",this.templates);const r=this.templates.get(t);for(const n of r.blocks){const i=this._countUsedTemplatesInTree(n.templateId);for(const[c,h]of i.entries())s.set(c,(s.get(c)??0)+h)}return e.set(t,s),s}countUsedTemplatesInTree(t){if(!t)throw"missing templateId";return this._countUsedTemplatesInTree_cache.clear(),this._countUsedTemplatesInTree(t)}containsTemplateInTree(t,e){return this.countUsedTemplatesInTree(t).has(e)}containsRootTemplateInTree(t){return this.countUsedTemplatesInTree(t).has(this.rootBlock.templateId)}set_root_block_template(t){const e=this.templates.get(t);this.rootBlock=new Lt(new $t(0,0,e.width,e.height,0),t)}refresh_root_block_template(){const t=this.rootBlock.templateId,e=this.templates.get(t);this.rootBlock=new Lt(new $t(0,0,e.width,e.height,0),t)}createNewBlockTemplate(t,e,s,r){const n=new Ke(t,e);n.name=s,n.desc=r,this.templates.set(n.templateId,n),x.gameUI.on_major_blocklib_change(),x.set_root_block_template(n.templateId)}getTemplateDependents(t){const e=[];for(const[s,r]of this.templates.entries())if(s!==t){const n=new Map;for(const i of r.blocks){const c=i.templateId;n.set(c,(n.get(c)??0)+1)}n.has(t)&&e.push([r,n.get(t)])}return e}canDeleteBlockTemplate(t){return!(t===this.rootBlock.templateId||this.getTemplateDependents(t).length>0)}deleteBlockTemplate(t){if(t===this.rootBlock.templateId){alert("cannot delete template while it is being edited");return}const e=this.getTemplateDependents(t);if(e.length>0){let s=[];for(const[r,n]of e)s.push(`[${r.templateId}] "${r.name}" contains ${n} instance(s)`);alert(`cannot delete template as other templates depend on it:

${s.join(`
`)}`);return}console.log("deleting template",t),this.templates.delete(t),x.gameUI.on_major_blocklib_change()}get_template_dependency_chain(t,e){const s=this.templates.get(t);for(const n of s.blocks)if(n.templateId===e){const i=this.templates.get(n.templateId);return[s,i]}const r=new Set;for(const n of s.blocks)r.add(n.templateId);for(const n of r.keys()){const i=this.get_template_dependency_chain(n,e);if(i)return[s,...i]}return null}get_root_template_dependency_chain(t){return this.get_template_dependency_chain(t,this.rootBlock.templateId)}exportTemplates(){let t=[];for(const[e,s]of this.templates.entries())t.push(s.save());return JSON.stringify(t)}importTemplates(t){const e=t.trim();if(e.length>0)try{const s=[],r=JSON.parse(e);console.log("<>arr",r);for(const n of r){const i=Ke.load(n);this.templates.set(i.templateId,i),x.simulationShouldRebuild=!0}}catch(s){alert(`failed to parse import text-area:

`+s.stack)}this.templates.size===0&&(x.createNewBlockTemplate(12,12,"New template",""),x.simulationShouldRebuild=!0),x.gameUI.on_major_blocklib_change()}get_link_point(t,e,s){ht.verifyType_throw(e,rt);let r=x.gameRenderer.renderBlock;t!==j.THIS_BLOCK&&t!==this.rootBlock.id&&(r=r.children.get(t));const n=r.c_points.get(e.id);return ht.verifyType_throw(n,Float32Array),n.slice(s*3,s*3+3)}get_all_cell_targets(){const t=[],e=rt.LINK_TARGET.OUTPUT,s=rt.LINK_TARGET.INPUT_A,r=rt.LINK_TARGET.INPUT_B;{const n=this.rootBlock,{out:i,ina:c,inb:h}=n.template.getValidCellTargets(!0),d=n.id;let f;f=e;for(const p of i.keys())t.push([this.get_link_point(d,p,f),d,p.id,f]);f=s;for(const p of c.keys())t.push([this.get_link_point(d,p,f),d,p.id,f]);f=r;for(const p of h.keys())t.push([this.get_link_point(d,p,f),d,p.id,f])}for(const n of this.templates.get(this.rootBlock.templateId).blocks){const{out:i,ina:c,inb:h}=n.template.getValidCellTargets(!1),d=n.id;let f;f=e;for(const p of i.keys())t.push([this.get_link_point(d,p,f),d,p.id,f]);f=s;for(const p of c.keys())t.push([this.get_link_point(d,p,f),d,p.id,f]);f=r;for(const p of h.keys())t.push([this.get_link_point(d,p,f),d,p.id,f])}return t}get_nearst_cell_target(t,e,s){if(t.length<=0)return null;let r=0,n=-1,i=!1;for(let c=0;c<t.length;c++){const[h,d,f,p]=t[c];if(s===rt.LINK_TARGET.NONE||rt.canLinkTargets(s,p)){const b=e.add(h,-1).hypotSquared();b<n|!i&&(r=c,n=b,i=!0)}}return t[r]}getLinksThatPointToCellInTemplate(t,e,s){const r=[];for(const[n,i]of this.templates.entries()){if(n===t&&!s)continue;const c=new Map;for(const d of i.blocks)c.set(d.id,d.templateId);const h=[];for(const d of i.links){const{bid_src:f,bid_dst:p,cid_src:b,cid_dst:_,tgt_src:v,tgt_dst:g}=d,w=f===j.THIS_BLOCK?n:c.get(f),y=p===j.THIS_BLOCK?n:c.get(p);w===t&b===e|y===t&_===e&&h.push(d)}h.length>0&&r.push([i,h])}return console.debug("<>getLinksThatPointToCellInTemplate(templateId, cid, includeSelf)",t,e,s,r),r}getLinksThatCantFindTargets(){const t=new Map;for(const[s,r]of this.templates.entries()){const n=new Set;for(const i of r.cells)n.add(i.id);t.set(s,n)}const e=[];for(const[s,r]of this.templates.entries()){const n=new Map;for(const c of r.blocks)n.set(c.id,c.templateId);const i=[];for(const c of r.links){const{bid_src:h,bid_dst:d,cid_src:f,cid_dst:p,tgt_src:b,tgt_dst:_}=c,v=h===j.THIS_BLOCK?s:n.get(h),g=d===j.THIS_BLOCK?s:n.get(d),w=t.get(v).has(f),y=t.get(g).has(p);!w|!y&&i.push(c)}i.length>0&&e.push([r,i])}return e}deleteLinksInTemplateLinkList(t){for(const[e,s]of t)for(const r of s)e.removeLink(r),x.onRootContentChanged_remLink(r)}verifyLinksCanFindTargets(){const t=this.getLinksThatCantFindTargets();return new Promise((s,r)=>{if(t.length===0)s(!0);else{const n=()=>{console.debug("<>verifyLinksCanFindTargets submit"),this.deleteLinksInTemplateLinkList(t),x.gameUI.hideLinkDeletionPopup(),s(!0)},i=()=>{console.debug("<>verifyLinksCanFindTargets cancel"),x.gameUI.hideLinkDeletionPopup(),s(!1)};x.gameUI.showLinkDeletionPopup(t,"WARNING - links in the following templates failed to find targets (delete links?):",n,i)}})}}const et=class et{constructor(t,e,s,r,n){this.parent=t,this.block=e,this.depth=r,this.externalTran=s,this.contentTran=null,this.itemTran=null,this.item_trans=new Map,this.c_points=new Map,this.l_points=new Map,this.children=new Map,this.render_data_cells=[],this.render_data_links=[],this.render_data_texts=[],this.render_data_blocks=[],this.is_hovered=!1,this.is_selected=!1,this.itemTran=et.get_item_transformation(e,this.externalTran),this.contentTran=et.get_content_transformation(e,this.externalTran);const i=this.contentTran,c=e.template;for(const h of c.cells)this.item_trans.set(h.id,et.get_item_transformation(h,i));for(const h of c.texts)this.item_trans.set(h.id,et.get_item_transformation(h,i));for(const h of c.blocks)this.item_trans.set(h.id,et.get_item_transformation(h,i));for(const h of c.cells){const d=et.LINK_POINTS_F32.slice();this.item_trans.get(h.id).apply(d,0,d.length,3),this.c_points.set(h.id,d)}if(r<n)for(const h of c.blocks){const d=new et(this,h,i,r+1,n);this.children.set(h.id,d)}for(const h of c.links){let d=new Float32Array(6);const{bid_src:f,bid_dst:p,cid_src:b,cid_dst:_,tgt_src:v,tgt_dst:g}=h;d.set(this.get_cell_link_point(f,b,v),0),d.set(this.get_cell_link_point(p,_,g),3),this.l_points.set(h.id,d)}for(const h of c.cells)this.render_data_cells.push(this.get_render_data_cell(h));for(const h of c.links)this.render_data_links.push(this.get_render_data_link(h));for(const h of c.texts)this.render_data_texts.push(this.get_render_data_text(h));for(const h of c.blocks)this.render_data_blocks.push(this.get_render_data_block(h))}static get_item_transformation(t,e){const s=et.UNIT_SQUARE_TRANSFORMATION,r=t.dimensions,n=new we(r.x,r.y,r.w,r.h,r.r);return e.compose(n).compose(s)}static get_content_transformation(t,e){ht.verifyTypes_throw([t,e],[Lt,we]);const s=t.template;ht.verifyTypes_throw([s],[Ke]);const r=new we(0,0,1/s.width,1/s.height,0);return this.get_item_transformation(t,e).compose(r)}get_cell_link_point(t,e,s){const r=s*3;if(t===j.THIS_BLOCK)return this.c_points.get(e).slice(r,r+3);if(this.children.has(t))return this.children.get(t).c_points.get(e).slice(r,r+3);const n=new Float32Array([.5,.5,0]);return this.item_trans.get(t).apply(n,0,n.length,3),n}get_axis_aligned_bounding_box(t){const e=[0,0,0,1,0,0,1,1,0,0,1,0];return this.item_trans.get(t.id).apply(e,0,e.length,3),Ft.get_AABB_from_points_2d(e,0,e.length,3)}get_render_data_cell(t){const e=t,s=et.get_item_transformation(t,this.contentTran),r=e.numTargets;return{cell:e,tran:s,numTargets:r}}get_render_data_link(t){const e=t,s=this.l_points.get(e.id),r=[s[0],s[1]],n=[s[3],s[4]];return{link:e,p0:r,p1:n}}get_render_data_text(t){const e=t,s=et.get_item_transformation(t,this.contentTran);return{text:e,tran:s}}get_render_data_block(t){const e=t,s=et.get_item_transformation(t,this.contentTran);return{block:e,tran:s}}};R(et,"LINK_POINTS_F32",new Float32Array([1,.5,0,0,.75,0,0,.25,0])),R(et,"LINK_POINTS_ARR",[[1,.5,0],[0,.75,0],[0,.25,0]]),R(et,"LINK_RECTS_ARR",et.LINK_POINTS_ARR.map(([t,e,s])=>[t-.1,e-.1,.1*2,.1*2])),R(et,"CELL_AREA_RECTS",[[.5,0,.5,1],[0,.5,.5,.5],[0,0,.5,.5]]),R(et,"CELL_RECTS",[...et.CELL_AREA_RECTS,...et.LINK_RECTS_ARR]),R(et,"UNIT_SQUARE_TRANSFORMATION",new we(-.5,-.5,1,1,0));let ae=et;const U=WebGL2RenderingContext,jr={ARRAY_BUFFER:U.ARRAY_BUFFER,INDEX_BUFFER:U.ELEMENT_ARRAY_BUFFER},Cs={STATIC_DRAW:U.STATIC_DRAW,DYNAMIC_DRAW:U.DYNAMIC_DRAW,STREAM_DRAW:U.STREAM_DRAW},Ir={BUFFER_SIZE:U.BUFFER_SIZE,BUFFER_USAGE:U.BUFFER_USAGE};class Cr{static getBufferParam(t,e,s,r){return t.bindBuffer(e,s),t.getBufferParameter(e,r)}static getBufferSize(t,e,s){return ds.getBufferParam(t,e,s,Ir.BUFFER_SIZE)}static getBufferUsage(t,e,s){return ds.getBufferParam(t,e,s,Ir.BUFFER_USAGE)}static createBuffer(t,e,s,r){const n=t.createBuffer();return t.bindBuffer(s,n),t.bufferData(s,e,r),n}}class ds{constructor(t,e,s,r,n){this.glContext=t,this.target=r,this.usage=n,this.arrayType=e,this.data=new e(s),this.buffer=Cr.createBuffer(t,this.data.byteLength,r,n),this.writePos=0,this.bufferPos=0}get BYTES_PER_ELEMENT(){return this.arrayType.BYTES_PER_ELEMENT}get GL_ENUM_TYPE(){return To(this.arrayType)}resize(t,e){const s=this.data.length;return this.data=Yt.resize(this.data,Math.ceil(t),e),this.buffer=Cr.createBuffer(this.glContext,this.data.byteLength,this.target,this.usage),this.writePos=e?Math.min(this.writePos,s):0,this.bufferPos=0,!0}clear(){this.writePos=0,this.bufferPos=0}reserve(t){const e=this.writePos+t;e>this.data.length&&this.resize(e*3/2+32,!0)}pushData(t,e,s){return Yt.memcopy(this.data,this.writePos,t,e,s),this.writePos+=s,this.writePos}reserveAndPushData(t,e,s){this.reserve(s),this.pushData(t,e,s)}commitNewDataToBuffer(){const t=this.bufferPos,e=this.writePos-this.bufferPos,s=this.data,r=t*this.BYTES_PER_ELEMENT,n=t,i=this.glContext;i.bindBuffer(this.target,this.buffer),i.bufferSubData(this.target,r,s,n,e),this.bufferPos=this.writePos}}class me extends ds{constructor(t,e,s,r,n,i){super(t,e,s,jr.ARRAY_BUFFER,r),this.attributeNames=i,this.vertexSize=n.getAttributeLayoutStride(i),this.vertexLength=this.vertexSize/this.BYTES_PER_ELEMENT}get vertexCount(){return this.writePos/this.vertexLength}}class As extends ds{constructor(t,e,s,r){super(t,e,s,jr.INDEX_BUFFER,r)}get indexCount(){return this.writePos}pushData(t,e,s,r=0){const n=this.writePos;super.pushData(t,e,s);const i=this.writePos;if(r!==0)for(let c=n;c<i;c++)this.data[c]+=r}reserveAndPushData(t,e,s,r=0){this.reserve(s),this.pushData(t,e,s,r)}}var Ps=1e-6,ze=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var l=0,t=arguments.length;t--;)l+=arguments[t]*arguments[t];return Math.sqrt(l)});function $s(){var l=new ze(16);return ze!=Float32Array&&(l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[11]=0,l[12]=0,l[13]=0,l[14]=0),l[0]=1,l[5]=1,l[10]=1,l[15]=1,l}function Kr(l){return l[0]=1,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=1,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=1,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l}function Ar(l,t,e){var s=t[0],r=t[1],n=t[2],i=t[3],c=t[4],h=t[5],d=t[6],f=t[7],p=t[8],b=t[9],_=t[10],v=t[11],g=t[12],w=t[13],y=t[14],I=t[15],A=e[0],E=e[1],k=e[2],N=e[3];return l[0]=A*s+E*c+k*p+N*g,l[1]=A*r+E*h+k*b+N*w,l[2]=A*n+E*d+k*_+N*y,l[3]=A*i+E*f+k*v+N*I,A=e[4],E=e[5],k=e[6],N=e[7],l[4]=A*s+E*c+k*p+N*g,l[5]=A*r+E*h+k*b+N*w,l[6]=A*n+E*d+k*_+N*y,l[7]=A*i+E*f+k*v+N*I,A=e[8],E=e[9],k=e[10],N=e[11],l[8]=A*s+E*c+k*p+N*g,l[9]=A*r+E*h+k*b+N*w,l[10]=A*n+E*d+k*_+N*y,l[11]=A*i+E*f+k*v+N*I,A=e[12],E=e[13],k=e[14],N=e[15],l[12]=A*s+E*c+k*p+N*g,l[13]=A*r+E*h+k*b+N*w,l[14]=A*n+E*d+k*_+N*y,l[15]=A*i+E*f+k*v+N*I,l}function ho(l,t,e){var s=e[0],r=e[1],n=e[2];return l[0]=t[0]*s,l[1]=t[1]*s,l[2]=t[2]*s,l[3]=t[3]*s,l[4]=t[4]*r,l[5]=t[5]*r,l[6]=t[6]*r,l[7]=t[7]*r,l[8]=t[8]*n,l[9]=t[9]*n,l[10]=t[10]*n,l[11]=t[11]*n,l[12]=t[12],l[13]=t[13],l[14]=t[14],l[15]=t[15],l}function uo(l,t,e,s,r){var n=1/Math.tan(t/2);if(l[0]=n/e,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=n,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[11]=-1,l[12]=0,l[13]=0,l[15]=0,r!=null&&r!==1/0){var i=1/(s-r);l[10]=(r+s)*i,l[14]=2*r*s*i}else l[10]=-1,l[14]=-2*s;return l}var _o=uo;function fo(l,t,e,s){var r,n,i,c,h,d,f,p,b,_,v=t[0],g=t[1],w=t[2],y=s[0],I=s[1],A=s[2],E=e[0],k=e[1],N=e[2];return Math.abs(v-E)<Ps&&Math.abs(g-k)<Ps&&Math.abs(w-N)<Ps?Kr(l):(f=v-E,p=g-k,b=w-N,_=1/Math.hypot(f,p,b),f*=_,p*=_,b*=_,r=I*b-A*p,n=A*f-y*b,i=y*p-I*f,_=Math.hypot(r,n,i),_?(_=1/_,r*=_,n*=_,i*=_):(r=0,n=0,i=0),c=p*i-b*n,h=b*r-f*i,d=f*n-p*r,_=Math.hypot(c,h,d),_?(_=1/_,c*=_,h*=_,d*=_):(c=0,h=0,d=0),l[0]=r,l[1]=c,l[2]=f,l[3]=0,l[4]=n,l[5]=h,l[6]=p,l[7]=0,l[8]=i,l[9]=d,l[10]=b,l[11]=0,l[12]=-(r*v+n*g+i*w),l[13]=-(c*v+h*g+d*w),l[14]=-(f*v+p*g+b*w),l[15]=1,l)}function po(){var l=new ze(3);return ze!=Float32Array&&(l[0]=0,l[1]=0,l[2]=0),l}function Ls(l,t,e){var s=new ze(3);return s[0]=l,s[1]=t,s[2]=e,s}(function(){var l=po();return function(t,e,s,r,n,i){var c,h;for(e||(e=3),s||(s=0),r?h=Math.min(r*e+s,t.length):h=t.length,c=s;c<h;c+=e)l[0]=t[c],l[1]=t[c+1],l[2]=t[c+2],n(l,l,i),t[c]=l[0],t[c+1]=l[1],t[c+2]=l[2];return t}})();const Bs={RGB:U.RGB,RGBA:U.RGBA,ALPHA:U.ALPHA,LUMINANCE:U.LUMINANCE,LUM_ALPHA:U.LUMINANCE_ALPHA},Ms={UNSIGNED_BYTE:U.UNSIGNED_BYTE,U_SHORT_4444:U.UNSIGNED_SHORT_4_4_4_4,U_SHORT_5551:U.UNSIGNED_SHORT_5_5_5_1,U_SHORT_565:U.UNSIGNED_SHORT_5_6_5};class mo{constructor(t){this.glContext=t,this.texture=t.createTexture()}configureTexture(t,e){const s=this.glContext,r=(t&t-1)===0,n=(e&e-1)===0;r&&n?(s.generateMipmap(s.TEXTURE_2D),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.REPEAT),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.REPEAT)):(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR))}setTextureData(t,e,s,r=Bs.RGBA,n=Ms.UNSIGNED_BYTE){const i=this.glContext,c=0,h=0,d=r;i.bindTexture(i.TEXTURE_2D,this.texture),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),i.texImage2D(i.TEXTURE_2D,c,d,t,e,h,r,n,s),this.configureTexture(t,e)}async setTextureUrl(t,e=Bs.RGBA,s=Ms.UNSIGNED_BYTE){return new Promise((r,n)=>{const i=new Image;i.onload=()=>{try{const c=this.glContext,h=0,d=e;c.bindTexture(c.TEXTURE_2D,this.texture),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0),c.texImage2D(c.TEXTURE_2D,h,d,e,s,i),this.configureTexture(i.width,i.height),r(i)}catch(c){n(c)}},i.onerror=c=>{n(c)},i.src=t})}}class vo{constructor(){this.aspectRatio=1,this.FOV=7/360,this.zNear=.1,this.zFar=1e3,this.pos=new Float32Array([0,0,-100]),this.dirX=new Float32Array([1,0,0]),this.dirY=new Float32Array([0,1,0]),this.dirZ=new Float32Array([0,0,1]),this.matrixProj=$s(),this.matrixView=$s(),this.updateProjection(),this.updateView()}setAspectRatio(t,e){this.aspectRatio=t/e,this.updateProjection()}updateProjection(){const t=this.FOV*(2*Math.PI);_o(this.matrixProj,t,this.aspectRatio,this.zNear,this.zFar),ho(this.matrixProj,this.matrixProj,[-1,1,1])}updateView(){const t=Ls(...this.pos),e=Ls(...this.pos.map((r,n)=>r+this.dirZ[n])),s=Ls(...this.dirY);fo(this.matrixView,t,e,s)}applyCameraMatrix(t){Ar(t,this.matrixView,t),Ar(t,this.matrixProj,t)}translate(t,e,s){this.pos[0]+=t,this.pos[1]+=e,this.pos[2]+=s,this.updateView()}move(t,e,s){for(let r=0;r<3;r++)this.pos[r]+=this.dirX[r]*t+this.dirY[r]*e+this.dirZ[r]*s;this.updateView()}zoom(t){const e=(t-1)*Math.cos(this.FOV*2*(2*Math.PI/4));this.FOV=Math.min(this.FOV*(e+1),.49),this.updateProjection()}rotate(t,e,s){[[e,this.dirZ,this.dirY],[t,this.dirZ,this.dirX],[s,this.dirY,this.dirX]].forEach(n=>{const[i,c,h]=n,d=i*2*Math.PI,f=Math.sin(d),p=Math.cos(d);for(let b=0;b<3;b++){const _=c[b],v=h[b];c[b]=_*p+v*f,h[b]=v*p-_*f}}),this.updateView()}getRayDirection(t){const[e,s]=t,r=new Float32Array([...this.dirX]),n=new Float32Array([...this.dirY]),i=new Float32Array([...this.dirZ]),c=e*(this.FOV/2)*(2*Math.PI),h=s*(this.FOV/2)*(2*Math.PI);return this.bivector_rotation_inplace(i,r,Math.sin(c),Math.cos(c)),this.bivector_rotation_inplace(i,n,Math.sin(h),Math.cos(h)),i}bivector_rotation_inplace(t,e,s,r){for(let n=0;n<3;n++){const i=t[n],c=e[n];t[n]=i*r+c*s,e[n]=c*r-i*s}}}function We(l){for(const t of Object.keys(l))if(l[t]===void 0)throw`missing attribute: ${t} is undefined`}class zr{constructor(t){const{attribs:e,uniforms:s,vertSource:r,fragSource:n}=t;this.attribs=new Map,this.uniforms=new Map,this.vertSource=r,this.fragSource=n;for(const{name:i,type:c,numComponents:h,normalize:d}of e){const f={name:i,type:c,numComponents:h,normalize:d};We(f),this.attribs.set(i,f)}for(const{name:i}of s){const c={name:i};We(c),this.uniforms.set(i,c)}}getAttributeLayoutStride(t){let e=0;for(const s of t){const{name:r,type:n,numComponents:i,normalize:c}=this.attribs.get(s);e+=i*Lr(n)}return e}createAttributeLayout(t){let e=[],s=this.getAttributeLayoutStride(t),r=0;for(const n of t){const{name:i,type:c,numComponents:h,normalize:d}=this.attribs.get(n),f={name:i,type:c,numComponents:h,normalize:d,stride:s,offset:r};e.push(f),r+=h*Lr(c)}return e}}const zt=class zt{constructor(t,e,s,r,n){const{vertSource:i,fragSource:c,attribs:h,uniforms:d}=e;this.glContext=t,this.config=e,this.program=zt.initShaderProgram(t,i,c),this.locations=zt.getProgramBindingLocations(t,this.program,h,d),this.attributeBuffers=s,this.indexBuffer=r,this.drawMode=n}static loadShader(t,e,s){const r=t.createShader(e);return t.shaderSource(r,s),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?r:(alert(`An error occurred compiling the shaders: ${t.getShaderInfoLog(r)}`),t.deleteShader(r),null)}static initShaderProgram(t,e,s){const r=zt.loadShader(t,U.VERTEX_SHADER,e),n=zt.loadShader(t,U.FRAGMENT_SHADER,s),i=t.createProgram();return t.attachShader(i,r),t.attachShader(i,n),t.linkProgram(i),t.getProgramParameter(i,t.LINK_STATUS)?i:(alert(`Unable to initialize the shader program: ${t.getProgramInfoLog(i)}`),null)}static getProgramBindingLocations(t,e,s,r){const n=new Map;for(const i of s.keys())n.set(i,t.getAttribLocation(e,i));for(const i of r.keys())n.set(i,t.getUniformLocation(e,i));return n}useProgram(){zt.currentProgram!==this.program&&(this.glContext.useProgram(this.program),zt.currentProgram=this.program)}bindAttributes(t,e,s){this.useProgram();const r=this.glContext;r.bindBuffer(t,e);for(const n of s){const{name:i,type:c,numComponents:h,normalize:d,stride:f,offset:p}=n;We({name:i,type:c,numComponents:h,normalize:d,stride:f,offset:p});const _=this.locations.get(i);Eo(c)?r.vertexAttribIPointer(_,h,c,d,f,p):r.vertexAttribPointer(_,h,c,d,f,p),r.enableVertexAttribArray(_)}}setUniform_mat4fv(t,e,s){const r=this.config.uniforms.get(e),n=this.locations.get(e),{name:i}=r;We({name:i}),this.useProgram(),this.useProgram(),t.uniformMatrix4fv(n,!1,s)}setUniform_texbuf(t,e,s,r=U.TEXTURE0){const n=this.config.uniforms.get(e),i=this.locations.get(e),{name:c}=n;We({name:c}),this.useProgram(),t.activeTexture(r),t.bindTexture(t.TEXTURE_2D,s.texture),t.uniform1i(i,0)}bindAttributeBuffers(){for(const t of this.attributeBuffers){const e=this.config.createAttributeLayout(t.attributeNames);this.bindAttributes(t.target,t.buffer,e)}}drawElements(){this.bindAttributeBuffers(),this.useProgram();const t=this.glContext,e=this.indexBuffer,s=e.GL_ENUM_TYPE,r=So,n=0,i=e.indexCount;t.bindBuffer(U.ELEMENT_ARRAY_BUFFER,e.buffer);for(let c=n;c<i;c+=r){const h=Math.min(i-c,r),d=c*e.BYTES_PER_ELEMENT;t.drawElements(this.drawMode,h,s,d)}}};R(zt,"currentProgram",null);let Ge=zt;class js{static packed_rgba_8bit(t,e,s,r){return t<<24|e<<16|s<<8|r<<0}static unpack_rgba_8bit(t,e){return`
			const float cmult = 1.0 / float(0xff);
			const uint  cmask = uint(0xff);
			${t}.r = float((${e} >> 24) & cmask) * cmult;
			${t}.g = float((${e} >> 16) & cmask) * cmult;
			${t}.b = float((${e} >>  8) & cmask) * cmult;
			${t}.a = float((${e} >>  0) & cmask) * cmult;
		`}static packed_normal_10bit(t,e,s){return Math.round(t*511+511)<<0|Math.round(e*511+511)<<10|Math.round(s*511+511)<<20}static unpack_normal_10bit(t,e){return`
			const float nmult = 1.0 / float(0x1ff);
			const uint  noffs = uint(0x1ff);
			const uint  nmask = uint(0x3ff);
			${t}.x = float(((${e} >>  0) & nmask) - noffs) * nmult;
			${t}.y = float(((${e} >> 10) & nmask) - noffs) * nmult;
			${t}.z = float(((${e} >> 20) & nmask) - noffs) * nmult;
		`}}const Pr=new zr({attribs:[{name:"pos",type:U.FLOAT,numComponents:3,normalize:!1},{name:"clr",type:U.UNSIGNED_INT,numComponents:1,normalize:!1}],uniforms:[{name:"mvp"}],vertSource:`#version 300 es
		in			vec4		pos;
		in			uint		clr;
		uniform		mat4		mvp;
		out			lowp vec4	fragclr;
		void main() {
			gl_Position = mvp * pos;
			${js.unpack_rgba_8bit("fragclr","clr")}
		}
	`,fragSource:`#version 300 es
		in			lowp vec4	fragclr;
		out			lowp vec4	outclr;
		void main() {
			outclr = fragclr;
		}
	`}),go=new zr({attribs:[{name:"pos",type:U.FLOAT,numComponents:3,normalize:!1},{name:"clr",type:U.UNSIGNED_INT,numComponents:1,normalize:!1},{name:"tex",type:U.FLOAT,numComponents:2,normalize:!1}],uniforms:[{name:"mvp"},{name:"texsampler"}],vertSource:`#version 300 es
		uniform			mat4	mvp;
		in				vec4	pos;
		in				uint	clr;
		in				vec2	tex;
		out		lowp	vec4	fragclr;
		out		highp	vec2	fragtex;
		void main() {
			gl_Position = mvp * pos;
			${js.unpack_rgba_8bit("fragclr","clr")}
			fragtex = tex;
		}
	`,fragSource:`#version 300 es
		uniform			sampler2D	texsampler;
		in		lowp	vec4		fragclr;
		in		highp	vec2		fragtex;
		out		lowp	vec4		outclr;
		void main() {
			outclr = fragclr * texture(texsampler, fragtex);
		}
	`}),bo={CURSIVE:"cursive",COURIER:"courier",FANTASY:"fantasy",MATH:"math",MONO:"mono",MONOSPACE:"monospace",SANS:"sans",SERIF:"serif",SYSTEM_UI:"system-ui"},Yr={NONE:"",BOLD:"bold",ITALIC:"italic",CAPS:"small-caps"},Us={ALPHABETIC:"alphabetic",IDEAGRAPHIC:"ideagraphic",HANGING:"hanging",BOTTOM:"bottom",MIDDLE:"middle",TOP:"top"};class wo{constructor(t,e,s){const r=document.createElement("canvas"),n=r.getContext("2d");r.width=t,r.height=e,r.id=s,this.canvas=r,this.ctx=n}fillStyle(t){this.ctx.fillStyle=t}fillStyle_rgba(t,e,s,r){this.fillStyle(`rgba(${t*255},${e*255},${s*255},${r})`)}fillStyle_hex(t,e,s,r){this.fillStyle(`rgba(${t},${e},${s},${r/255})`)}lineWidth(t){this.ctx.lineWidth=t}lineStyle(t){this.ctx.strokeStyle=t}lineStyle_rgba(t,e,s,r){this.lineStyle(`rgba(${t*255},${e*255},${s*255},${r})`)}lineStyle_hex(t,e,s,r){this.lineStyle(`rgba(${t},${e},${s},${r/255})`)}fillRect(t,e,s,r){this.ctx.fillRect(t,e,s,r)}lineRect(t,e,s,r){this.ctx.strokeRect(t,e,s,r)}clearRect(t,e,s,r){this.ctx.clearRect(t,e,s,r)}path(t,e=!0){if(this.ctx.beginPath(),!(t.length<2)){this.ctx.moveTo(t[0],t[1]);for(let s=1;s<t.length;s++)this.ctx.lineTo(t[s*2+0],t[s*2+1]);e&&this.ctx.closePath()}}fillPath(t){this.path(t),this.ctx.fill()}linePath(t){this.path(t),this.ctx.stroke()}arc(t,e,s,r,n,i,c=!0){this.ctx.beginPath(),r*=2*Math.PI,n*=2*Math.PI,i&&(n=-n,r=-r),this.ctx.arc(t,e,s,r,n,i),this.ctx.closePath()}arcTo(t,e,s,r,n){this.ctx.arcTo(t,e,s,r,n)}fillArc(t,e,s,r,n,i,c=!0){this.arc(t,e,s,r,n,i,c),this.ctx.fill()}lineArc(t,e,s,r,n,i,c=!1){this.arc(t,e,s,r,n,i,c),this.ctx.stroke()}setFont(t,e,s=Yr.NONE,r=Us.TOP){this.ctx.font=`${t}px ${s} ${e}`,this.ctx.textBaseline=r}getTextWidth(t){return this.ctx.measureText(t).width}fillText(t,e,s){this.ctx.fillText(t,e,s)}lineText(t,e,s){this.ctx.strokeText(t,e,s)}getImageData(t,e,s,r){return this.ctx.getImageData(t,e,s,r)}putImageData(t,e=0,s=0){this.ctx.putImageData(t,e,s)}static getImageDataValue(t,e,s,r,n,i){return t[n*e*4+r*4+i]}toDataURL(){return this.canvas.toDataURL("image/png")}}class yo{constructor(){this.texCoords=new Float32Array(6)}get widthRatio(){return this.texCoords[2]/this.texCoords[3]*this.texCoords[5]}setTexCoords(t,e,s,r,n,i){this.texCoords.set([t,e,s,r,i,n/i],0)}}class ko{constructor(t,e,s,r,n){this.glContext=t,this.glyphmap=new Map,this.texBuffer=new mo(t),this.height=s,this.family=r,this.style=n,this.initialize(e)}initialize(t){const e=[...t.keys()];this.glyphmap.clear();for(const p of e)this.glyphmap.set(p,new yo);const s=new wo(0,0,"FontEngine_initialize_canvas");s.setFont(this.height,this.family,this.style,Us.BOTTOM);const r=Math.ceil(this.height*.1);let n=64,i=64,c=!1;for(;!c;){const p=this.height;let b=0,_=0,v=!1;for(const g of e){const w=s.getTextWidth(g);b+w>n&&(b=0,_+=p);const y=1/n,I=1/i;if(this.glyphmap.get(g).setTexCoords(b*y,_*I,w*y,p*I,n,i),w>n){v=!0;break}if(_+p>i){v=!0;break}b+=w+r}v?n<=i?n*=2:i*=2:c=!0}s.canvas.width=n,s.canvas.height=i,s.setFont(this.height,this.family,this.style,Us.BOTTOM),s.fillStyle_hex(255,255,255,255),s.lineStyle_hex(255,255,255,127);for(const p of e){const b=this.glyphmap.get(p),_=b.texCoords[0]*n,v=b.texCoords[1]*i;s.fillText(p,_,i-v)}const h=s.getImageData(0,0,n,i),d=n*i,f=new Uint8Array(d*2);for(let p=0;p<d;p++)f[p*2+0]=h.data[p*4+0],f[p*2+1]=h.data[p*4+3];this.texBuffer.setTextureData(h.width,h.height,f,Bs.LUM_ALPHA,Ms.UNSIGNED_BYTE)}getRequiredGlyphs(t,e){for(let s=0;s<e.length;s++)this.glyphmap.has(e[s])||t.add(e[s])}addRequiredGlyphs(t){if(t.size<=0)return!1;const e=new Set(this.glyphmap.keys());for(const s of t.keys())e.add(s);return e.size>this.glyphmap.size?(console.debug("addRequiredGlyphs(charset)",t),this.initialize(e),!0):!1}getTotalWidth(t,e,s){let r=0;for(let n=0;n<t.length;n++){const i=t[n],c=this.glyphmap.get(i),h=e*c.widthRatio*s;r+=h}return r}generateVertexData3d(t,e,s,r,n,i,c,h,d,f){h=new Float32Array(h),h[0]+=r.x,h[1]+=r.y;const p=0,b=0,_=r.w,v=r.h,g=3,w=2,y=t.length*4*g,I=t.length*4*w,A=t.length*6;let E=new Float32Array(y),k=new Float32Array(I),N=new Uint32Array(A);const J=new Uint32Array([0,1,2,2,3,0]);let D=0,H=0,ft=0,X=p,ot=v-e,pt=[];for(let at=0;at<t.length;at++){const tt=t[at],lt=this.glyphmap.get(tt),xt=e*lt.widthRatio*s,_e=e;if(X+xt>_&c&&(pt.push(D,X,ot),X=p,ot-=e),tt===`
`){pt.push(D,X,ot),X=p,ot-=e;continue}const[At,Nt,Gt,Dt]=lt.texCoords,Zt=D*g,Bt=H*w,fe=ft;E.set([X+0,ot+0,0,X+xt,ot+0,0,X+xt,ot+_e,0,X+0,ot+_e,0],Zt),k.set([At+0,Nt+0,At+Gt,Nt+0,At+Gt,Nt+Dt,At+0,Nt+Dt],Bt);for(let Ot=0;Ot<6;Ot++)N[fe+Ot]=J[Ot]+D;D+=4,H+=4,ft+=6,X+=xt}pt.push(D,X,ot);let Wt=0,yt=0;for(;yt<pt.length;){const at=pt[yt*3+0],tt=pt[yt*3+1];pt[yt*3+2],yt++;const lt=_-p,xt=v-b,_e=_-tt,At=ot,Nt=+n[0]*_e-i[0]*lt,Gt=-n[1]*At-i[1]*xt;for(;Wt<at;){const Dt=Wt*g;E[Dt+0]+=Nt,E[Dt+1]+=Gt,Wt++}}const Rt=3;for(let at=0;at<D;at++){const tt=E[at*Rt+0],lt=E[at*Rt+1],xt=at*Rt;E[xt+0]=h[0]+d[0]*tt+f[0]*lt,E[xt+1]=h[1]+d[1]*tt+f[1]*lt,E[xt+2]=h[2]+d[2]*tt+f[2]*lt}return{vdata:E,vcount:D,tdata:k,tcount:H,idata:N,icount:ft}}}const Lr=l=>l===U.FLOAT?Float32Array.BYTES_PER_ELEMENT:l===U.UNSIGNED_INT?Uint32Array.BYTES_PER_ELEMENT:l===U.UNSIGNED_SHORT?Uint16Array.BYTES_PER_ELEMENT:l===U.UNSIGNED_BYTE?Uint8Array.BYTES_PER_ELEMENT:l===U.INT?Int32Array.BYTES_PER_ELEMENT:l===U.SHORT?Int16Array.BYTES_PER_ELEMENT:l===U.BYTE?Int8Array.BYTES_PER_ELEMENT:0,To=l=>l===Float32Array?U.FLOAT:l===Uint32Array?U.UNSIGNED_INT:l===Uint16Array?U.UNSIGNED_SHORT:l===Uint8Array?U.UNSIGNED_BYTE:l===Int32Array?U.INT:l===Int16Array?U.SHORT:l===Int8Array?U.BYTE:U.NONE,Eo=l=>[U.UNSIGNED_INT,U.UNSIGNED_SHORT,U.UNSIGNED_BYTE,U.INT,U.SHORT,U.BYTE].includes(l),Rs={TRIANGLES:U.TRIANGLES,TRIANGLE_STRIP:U.TRIANGLE_STRIP,TRIANGLE_FAN:U.TRIANGLE_FAN,LINES:U.LINES,LINE_STRIP:U.LINE_STRIP,LINE_LOOP:U.LINE_LOOP,POINTS:U.POINTS},xo=1,So=3e7;class St{static reset(){for(const[t,e]of this.timings.entries())this.timings.set(t,this.timings.get(t)*.98);for(const[t,e]of this.counts.entries())this.counts.set(t,0)}static increment_time(t,e){const s=this.timings.has(t)?this.timings.get(t):0;this.timings.set(t,s+e*.02)}static increment_count(t,e){const s=this.counts.has(t)?this.counts.get(t):0;this.counts.set(t,s+e)}static log(t){const e=this.timings.get(t);console.log(`${t}`,e)}static log_all(){let t="";for(const[e,s]of this.timings.entries())t+=`time : ${e}	${s.toFixed(3)}
`;for(const[e,s]of this.counts.entries())t+=`count: ${e}	${s}
`;console.log(t)}}R(St,"timings",new Map),R(St,"counts",new Map);const Ns=4294967295,Io=0;class Xr{constructor(t){R(this,"_renderBlock_cache",new Tt(()=>this._renderBlock()));R(this,"DEPTH_ON_TOP",33);const e=t.getContext("webgl2",{alpha:!0,antialias:!0});if(e===null){alert("Unable to initialize WebGL2. Your browser or machine may not support it.");return}this.canvas=t,this.gl=e,e.viewport(0,0,t.width,t.height),e.clearColor(0,0,0,1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.clearDepth(1),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),t.style.background="unset";const s=this.camera=new vo,{width:r,height:n}=t.getClientRects()[0];s.setAspectRatio(r,n),this.matrixMVP=$s();{const i=this.triangles_config=Pr,c=Cs.DYNAMIC_DRAW,h=new As(e,Uint32Array,0,c),d=new me(e,Float32Array,0,c,i,["pos"]),f=new me(e,Uint32Array,0,c,i,["clr"]);this.triangles_shader=new Ge(e,i,[d,f],h,Rs.TRIANGLES),this.triangles_buffer_ind=h,this.triangles_buffer_pos=d,this.triangles_buffer_clr=f}{const i=this.lines_config=Pr,c=Cs.DYNAMIC_DRAW,h=new As(e,Uint32Array,0,c),d=new me(e,Float32Array,0,c,i,["pos"]),f=new me(e,Uint32Array,0,c,i,["clr"]);this.lines_shader=new Ge(e,i,[d,f],h,Rs.LINES),this.lines_buffer_ind=h,this.lines_buffer_pos=d,this.lines_buffer_clr=f}{const i=this.font_config=go,c=Cs.DYNAMIC_DRAW,h=new As(e,Uint32Array,0,c),d=new me(e,Float32Array,0,c,i,["pos"]),f=new me(e,Uint32Array,0,c,i,["clr"]),p=new me(e,Float32Array,0,c,i,["tex"]);this.font_shader=new Ge(e,i,[d,f,p],h,Rs.TRIANGLES),this.font_buffer_ind=h,this.font_buffer_pos=d,this.font_buffer_clr=f,this.font_buffer_tex=p;const b="",_=new Set(b);this.fontRenderer_0=new ko(e,_,60,bo.SERIF,Yr.NONE)}}render(){this.clear_buffers();const t=Date.now(),e=this.renderBlock;if(!e)throw"!renblock";const s=Date.now();this.drawBlock(e,e.get_render_data_block(x.blockLibrary.rootBlock),Io),this.drawCursor(),x.gameUI.cursor_isSelecting&&this.drawDragArea(),this.drawSelection(),this.drawPreviewCell(),this.drawPreviewLink(),this.drawPreviewBlock(),this.drawHovered();const r=Date.now();this.commit_buffers();const n=this.triangles_shader.glContext;n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);const i=this.matrixMVP;Kr(i),this.camera.applyCameraMatrix(i),this.triangles_shader.setUniform_mat4fv(n,"mvp",i),this.lines_shader.setUniform_mat4fv(n,"mvp",i),this.font_shader.setUniform_mat4fv(n,"mvp",i),this.font_shader.setUniform_texbuf(n,"texsampler",this.fontRenderer_0.texBuffer),this.triangles_shader.drawElements(),this.lines_shader.drawElements(),this.font_shader.drawElements();const c=Date.now();St.increment_time("render.update",s-t),St.increment_time("render.gather",r-s),St.increment_time("render.draw",c-r)}clear_buffers(){this.triangles_buffer_ind.clear(),this.triangles_buffer_pos.clear(),this.triangles_buffer_clr.clear(),this.lines_buffer_ind.clear(),this.lines_buffer_pos.clear(),this.lines_buffer_clr.clear(),this.font_buffer_ind.clear(),this.font_buffer_pos.clear(),this.font_buffer_clr.clear(),this.font_buffer_tex.clear();const t=xo;let e,s;e=this.triangles_buffer_clr,s=t*e.vertexLength,e.reserveAndPushData(new Uint32Array(s),0,s),e=this.lines_buffer_clr,s=t*e.vertexLength,e.reserveAndPushData(new Uint32Array(s),0,s),e=this.font_buffer_clr,s=t*e.vertexLength,e.reserveAndPushData(new Uint32Array(s),0,s)}commit_buffers(){this.triangles_buffer_ind.commitNewDataToBuffer(),this.triangles_buffer_pos.commitNewDataToBuffer(),this.triangles_buffer_clr.commitNewDataToBuffer(),this.lines_buffer_ind.commitNewDataToBuffer(),this.lines_buffer_pos.commitNewDataToBuffer(),this.lines_buffer_clr.commitNewDataToBuffer(),this.font_buffer_ind.commitNewDataToBuffer(),this.font_buffer_pos.commitNewDataToBuffer(),this.font_buffer_clr.commitNewDataToBuffer(),this.font_buffer_tex.commitNewDataToBuffer()}transform_vdata(t,e,s,r,n){t&&t.apply(s,r,n,3);const i=e*-.01;for(let c=r+2;c<n;c+=3)s[c]+=i}triangles_reserve(t,e,s){this.triangles_buffer_ind.reserve(t),this.triangles_buffer_pos.reserve(e),this.triangles_buffer_clr.reserve(s)}triangles_push(t,e,s){this.triangles_buffer_ind.pushData(t,0,t.length,this.triangles_buffer_pos.vertexCount),this.triangles_buffer_pos.pushData(e,0,e.length),this.triangles_buffer_clr.pushData(s,0,s.length)}triangles_transform(t,e,s){const r=this.triangles_buffer_pos,n=r.writePos-s,i=r.writePos;this.transform_vdata(t,e,r.data,n,i)}lines_reserve(t,e,s){this.lines_buffer_ind.reserve(t),this.lines_buffer_pos.reserve(e),this.lines_buffer_clr.reserve(s)}lines_push(t,e,s){this.lines_buffer_ind.pushData(t,0,t.length,this.lines_buffer_pos.vertexCount),this.lines_buffer_pos.pushData(e,0,e.length),this.lines_buffer_clr.pushData(s,0,s.length)}lines_transform(t,e,s){const r=this.lines_buffer_pos,n=r.writePos-s,i=r.writePos;this.transform_vdata(t,e,r.data,n,i)}_renderBlock(){const t=x.blockLibrary.rootBlock,e=new we;ae.get_content_transformation(t,e);const s=0;return new ae(null,t,e,s,x.maxDrawDepth)}get renderBlock(){return this._renderBlock_cache.value}tri_rects_reserve(t){const e=t*6,s=t*4*3,r=t*4;this.triangles_reserve(e,s,r)}tri_rects_write(t,e){const[s,r,n,i]=t,c=[0,1,2,2,3,0],h=[s+0,r+0,0,s+n,r+0,0,s+n,r+i,0,s+0,r+i,0],d=[e,e,e,e];this.triangles_push(c,h,d)}tri_rects_transform(t,e,s){this.triangles_transform(e,s,t*4*3)}tri_rects_push(t,e,s,r){this.tri_rects_reserve(1),this.tri_rects_write(s,r),this.tri_rects_transform(1,t,e)}line_rects_reserve(t){const e=t*8,s=t*4*3,r=t*4;this.lines_reserve(e,s,r)}line_rects_write(t,e){const[s,r,n,i]=t,c=[0,1,1,2,2,3,3,0],h=[s+0,r+0,0,s+n,r+0,0,s+n,r+i,0,s+0,r+i,0],d=[e,e,e,e];this.lines_push(c,h,d)}line_rects_transform(t,e,s){this.lines_transform(e,s,t*4*3)}line_rects_push(t,e,s,r){this.line_rects_reserve(1),this.line_rects_write(s,r),this.line_rects_transform(1,t,e)}transform_and_push_lines(t,e,s,r,n){this.transform_vdata(t,e,r,0,r.length);const i=this.lines_buffer_pos.vertexCount;this.lines_buffer_ind.reserveAndPushData(s,0,s.length,i),this.lines_buffer_pos.reserveAndPushData(r,0,r.length),this.lines_buffer_clr.reserveAndPushData(n,0,n.length)}transform_and_push_font(t,e,s,r,n,i){this.transform_vdata(t,e,r,0,r.length);const c=this.font_buffer_pos.vertexCount;this.font_buffer_ind.reserveAndPushData(s,0,s.length,c),this.font_buffer_pos.reserveAndPushData(r,0,r.length),this.font_buffer_clr.reserveAndPushData(n,0,n.length),this.font_buffer_tex.reserveAndPushData(i,0,i.length)}push_content_line(t,e,s,r,n){const i=[0,1],c=[s[0],s[1],0,r[0],r[1],0],h=[n,n];this.transform_and_push_lines(t,e,i,c,h)}push_content_line_grid(t,e,s,r,n,i){n=Math.floor(n),i=Math.floor(i);const[c,h,d,f]=s,p=2*(n+1)+2*(i+1),b=new Array(p),_=new Array(p*3),v=new Array(p).fill(r);for(let E=0;E<p;E++)b[E]=E;let g=0,w=c;const y=d/n;for(let E=0;E<=n;E++)_[g+0]=w,_[g+1]=h+0,_[g+2]=0,_[g+3]=w,_[g+4]=h+f,_[g+5]=0,w+=y,g+=6;let I=h;const A=f/i;for(let E=0;E<=i;E++)_[g+0]=c+0,_[g+1]=I,_[g+2]=0,_[g+3]=c+d,_[g+4]=I,_[g+5]=0,I+=A,g+=6;this.transform_and_push_lines(t,e,b,_,v)}push_content_line_circle(t,e,s,r,n,i,c){const h=new Array(i*2),d=new Array(i*3),f=new Array(i).fill(c);for(let _=0;_<i;_++)h[_*2+0]=_,h[_*2+1]=_+1;h[i*2-1]=0;let p=0,b=Math.PI*2/(i-1);for(let _=0;_<i;_++)d[_*3+0]=Math.cos(p)*n+s,d[_*3+1]=Math.sin(p)*n+r,d[_*3+2]=0,p+=b;this.transform_and_push_lines(t,e,h,d,f)}push_content_text_box(t,e,s,r,n,i,c,h,d){const f=this.fontRenderer_0,p=new Set;f.getRequiredGlyphs(p,s),f.addRequiredGlyphs(p);const b=1,_=[0,0,0],v=[1,0,0],g=[0,1,0];let{vdata:w,vcount:y,idata:I,icount:A,tdata:E}=f.generateVertexData3d(s,r,b,i,c,h,d,_,v,g);const k=new Array(y).fill(n);this.transform_and_push_font(t,e,I,w,k,E)}push_content_text_box_against_circle(t,e,s,r,n,i,c){const h=this.fontRenderer_0,d=new Set;h.getRequiredGlyphs(d,s),h.addRequiredGlyphs(d);const f=1,p=r,b=h.getTotalWidth(s,r,f),_=!1,[v,g]=i,w=[1-((v-.5)*c+.5),1-((g-.5)*c+.5)],y=[.5,.5],I=new hs(v,g,b,p),A=[0,0,0],E=[1,0,0],k=[0,1,0];let{vdata:N,vcount:J,idata:D,icount:H,tdata:ft}=h.generateVertexData3d(s,r,f,I,y,w,_,A,E,k);const X=new Array(J).fill(n);this.transform_and_push_font(t,e,D,N,X,ft)}valueToHex_u32(t,e){const s=t.toString(16).toUpperCase();let r="0x";for(let n=s.length;n<e;n++)r+="0";return r+s}hexColour_scale(t,e){return(t>>24&255)*e<<24|(t>>16&255)*e<<16|(t>>8&255)*e<<8|(t>>0&255)*1<<0}drawCell(t,e,s=Ns){const{cell:r,tran:n,numTargets:i}=e,c=t.depth,h=[r.value,0,0];s!==Ns&&(h[0]=x.gameServer.simulation_get_cell_value(r.id,s,0),h[1]=x.gameServer.simulation_get_cell_value(r.id,s,1),h[2]=x.gameServer.simulation_get_cell_value(r.id,s,2));const d=[0,0,0,4293840127,4293840127,4293840127],f=r.clr,p=this.hexColour_scale(f,.5);for(let g=0;g<3;g++)d[g]=h[g]?f:p;const b=3+i;this.tri_rects_reserve(b);for(let g=0;g<b;g++)this.tri_rects_write(ae.CELL_RECTS[g],d[g]);if(this.tri_rects_transform(b,n,c),c>=2)return;const _=x.gameUI.collectionSelected.cells.has(r)|t.is_selected,v=x.gameUI.collectionHovered.cells.has(r)|t.is_hovered;if(_|v|t.is_selected|t.is_hovered){const g=c+1,w=.3,y=4294967295,I=1.2;{const E=r.typeString,k=y,N=[.5,1];this.push_content_text_box_against_circle(n,g,E,w,255,N,I),this.push_content_text_box_against_circle(n,g,E,w,k,N,I)}const A=["OUT:","A:","B:"];for(let E=0;E<i;E++){const k=A[E]+this.valueToHex_u32(h[E],8),N=y&(h[E]===0?2004318207:4294967295),J=[ae.LINK_POINTS_F32[E*3+0],ae.LINK_POINTS_F32[E*3+1]];this.push_content_text_box_against_circle(n,g,k,w,255,J,I),this.push_content_text_box_against_circle(n,g,k,w,N,J,I)}}}drawLink(t,e){const{link:s,p0:r,p1:n}=e,i=t.depth;this.push_content_line(null,i+1,r,n,s.clr)}drawLink_alt(t,e,s,r=0){this.push_content_line(null,r+1,t,e,s)}drawText(t,e){const{text:s,tran:r}=e,n=t.depth;{const i=s.str,c=s.dimensions,h=s.fclr,d=s.fhgt;VerificationUtil.verifyObjectEntriesDefined({str:i,dim:c,fontColour:h,fontHeight:d});const f=new hs(c.x,c.y,c.w,c.h),p=[0,0],b=[0,0];this.push_content_text_box(r,n,i,d,h,f,p,b,!0)}}drawBlockPlaceholder(t,e){const{block:s,tran:r}=e,n=t.depth;this.tri_rects_push(r,n,[0,0,1,1],51),this.line_rects_push(r,n,[0,0,1,1],2007695257)}drawBlock(t,e,s=Ns){const r=Date.now();t.is_hovered=x.gameUI.collectionHovered.blocks.has(t.block),t.is_selected=x.gameUI.collectionSelected.blocks.has(t.block);{const{block:d,tran:f}=e,p=t.depth-.5,b=t.itemTran;if(this.tri_rects_push(b,p,[0,0,1,1],51),t.depth===0){const _=d.templateWidth,v=d.templateHeight;this.push_content_line_grid(b,p,[0,0,1,1],2007695257,_,v)}else this.line_rects_push(b,p,[0,0,1,1],2007695257)}const n=Date.now();for(const d of t.render_data_texts)this.drawText(t,d);const i=Date.now();for(const d of t.render_data_cells)this.drawCell(t,d,s);const c=Date.now();for(const d of t.render_data_links)this.drawLink(t,d);const h=Date.now();for(const d of t.render_data_blocks){const f=t.children.get(d.block.id),p=x.gameServer.simulation_get_child_simblock(d.block.id,s);f?this.drawBlock(f,d,p):this.drawBlockPlaceholder(t,d)}St.increment_time("render.gather.block",n-r),St.increment_time("render.gather.texts",i-n),St.increment_time("render.gather.cells",c-i),St.increment_time("render.gather.links",h-c)}drawPreviewCell(){const t=x.gameUI.get_render_preview_cell();if(!t)return;const e=this.renderBlock;this.drawCell(e,e.get_render_data_cell(t))}drawPreviewBlock(){const t=x.gameUI.get_render_preview_block();if(!t)return;const e=this.renderBlock,s=e.contentTran,r=e.depth+1,n=e.depth+2,i=new ae(e,t,s,r,n);this.drawBlock(i,i.get_render_data_block(t))}drawPreviewLink(){const t=x.gameUI.get_link_draw_points(),e=x.gameUI.get_wire_colour();for(const s of t){const n=this.DEPTH_ON_TOP;this.push_content_line_circle(null,n,s[0],s[1],.2,20,e)}t.length>=2&&this.drawLink_alt(t[0],t[1],e,0)}drawCursor(){const e=this.DEPTH_ON_TOP,s=js.packed_rgba_8bit(255,255,111,255),r=x.gameUI.cursor_pos,n=x.gameUI.cursor_radius;this.push_content_line_circle(null,e,r[0],r[1],n,30,s)}drawDragArea(){const[t,e,s,r]=x.gameUI.cursor_dragAABB,n=null,i=this.DEPTH_ON_TOP,c=[t,e,s-t,r-e];this.tri_rects_push(n,i,c,4294967125)}pushSelectionRectangles(t,e,s){const r=this.renderBlock,n=this.DEPTH_ON_TOP;for(const i of t.cells){const c=r.item_trans.get(i.id);this.line_rects_push(c,n,e,s)}for(const i of t.texts){const c=r.item_trans.get(i.id);this.line_rects_push(c,n,e,s)}for(const i of t.blocks){const c=r.item_trans.get(i.id);this.line_rects_push(c,n,e,s)}}drawSelection(){const e=[-.03,-.03,1.06,1.06];this.pushSelectionRectangles(x.gameUI.collectionSelected,e,4294923775)}drawHovered(){const e=[0,0,1,1];this.pushSelectionRectangles(x.gameUI.collectionHovered,e,2865561599)}}R(Xr,"DEPTH_ON_TOP",33);class Co{constructor(){this.handlers=new Map,this.keydown_curr=new Map,this.keydown_prev=new Map,this.keydown_delta=new Map,this.keydown_event=null,this.button_curr=new Map,this.button_prev=new Map,this.button_delta=new Map,this.button_event=null,this.cursor_curr=[0,0],this.cursor_prev=[0,0],this.cursor_delta=[0,0],this.cursor_event=null,this.wheel_curr=[0,0],this.wheel_prev=[0,0],this.wheel_delta=[0,0],this.wheel_event=null,this.dragbeg_pos=[0,0],this.dragend_pos=[0,0],this.dragbeg_event=null,this.dragend_event=null,this.dragbeg_event_prev=null,this.dragend_event_prev=null,this.dragbeg_event_delta=0,this.dragend_event_delta=0,this.addInputHandler("mousemove","default",t=>this.defaultHandler_mousemove.call(this,t)),this.addInputHandler("mousedown","default",t=>this.defaultHandler_mousedown.call(this,t)),this.addInputHandler("mouseup","default",t=>this.defaultHandler_mouseup.call(this,t)),this.addInputHandler("wheel","default",t=>this.defaultHandler_wheel.call(this,t)),this.addInputHandler("keydown","default",t=>this.defaultHandler_keydown.call(this,t)),this.addInputHandler("keyup","default",t=>this.defaultHandler_keyup.call(this,t))}updateInputDeltas(){for(const t of this.keydown_curr.keys()){const e=this.keydown_curr.get(t)?1:0,s=this.keydown_prev.get(t)?1:0,r=e-s;this.keydown_delta.set(t,r),this.keydown_prev.set(t,e)}for(const t of this.button_curr.keys()){const e=this.button_curr.get(t)?1:0,s=this.button_prev.get(t)?1:0,r=e-s;this.button_delta.set(t,r),this.button_prev.set(t,e)}for(let t=0;t<this.cursor_curr.length;t++)this.cursor_delta[t]=this.cursor_curr[t]-this.cursor_prev[t],this.cursor_prev[t]=this.cursor_curr[t];for(let t=0;t<this.wheel_curr.length;t++)this.wheel_delta[t]=this.wheel_curr[t]-this.wheel_prev[t],this.wheel_prev[t]=this.wheel_curr[t];this.dragbeg_event_delta=(this.dragbeg_event&!this.dragbeg_event_prev?1:0)-(!this.dragbeg_event&this.dragbeg_event_prev?1:0),this.dragend_event_delta=(this.dragend_event&!this.dragend_event_prev?1:0)-(!this.dragend_event&this.dragend_event_prev?1:0),this.dragbeg_event_prev=this.dragbeg_event,this.dragend_event_prev=this.dragend_event}clearInputEvents(){this.keydown_event=null,this.button_event=null,this.cursor_event=null,this.wheel_event=null,this.dragbeg_event=null,this.dragend_event=null}getKeydown(t){const e=this.keydown_curr;return e.get(t)||e.get(t.toLowerCase())||e.get(t.toUpperCase())}getKeydownDelta(t){const e=this.keydown_delta;return e.get(t)||e.get(t.toLowerCase())||e.get(t.toUpperCase())}addInputHandler(t,e,s){this.handlers.has(t)||this.handlers.set(t,new Map);const r=this.handlers.get(t);return r.has(e)&&this.removeInputHandler(t,e),window.addEventListener(t,s),r.set(e,s),!0}removeInputHandler(t,e){const s=this.handlers.get(t);if(!s)return!1;const r=s.get(e);return r?(window.removeEventListener(t,r),s.delete(e),!0):!1}defaultHandler_mousemove(t){const{clientX:e,clientY:s}=t;this.cursor_curr[0]=e,this.cursor_curr[1]=s}defaultHandler_mousedown(t){const{button:e}=t;this.button_event=t,this.button_curr.set(e,!0),this.dragbeg_pos[0]=this.cursor_curr[0],this.dragbeg_pos[1]=this.cursor_curr[1],this.dragbeg_event=t}defaultHandler_mouseup(t){const{button:e}=t;this.button_event=t,this.button_curr.set(e,!1),this.dragbeg_pos[0]!==this.cursor_curr[0]|this.dragbeg_pos[1]!==this.cursor_curr[1]&&(this.dragend_event=t),this.dragend_pos[0]=this.cursor_curr[0],this.dragend_pos[1]=this.cursor_curr[1]}defaultHandler_wheel(t){const{wheelDeltaX:e,wheelDeltaY:s}=t;this.wheel_event=t,this.wheel_curr[0]=-e,this.wheel_curr[1]=-s}defaultHandler_keydown(t){const{key:e}=t;this.keydown_event=t,this.keydown_curr.set(e.toLowerCase(),!0)}defaultHandler_keyup(t){const{key:e}=t;this.keydown_event=t,this.keydown_curr.set(e.toLowerCase(),!1)}}class Ve{constructor(){this.cells=new Set,this.texts=new Set,this.blocks=new Set}count(){return this.cells.size+this.texts.size+this.blocks.size}clear(){this.cells.clear(),this.texts.clear(),this.blocks.clear()}addFromCollection(t){for(const e of t.cells)this.cells.add(e);for(const e of t.texts)this.texts.add(e);for(const e of t.blocks)this.blocks.add(e)}addFirstComponentFromCollection(t){for(const e of t.texts){this.texts.add(e);return}for(const e of t.blocks){this.blocks.add(e);return}for(const e of t.cells){this.cells.add(e);return}}getFirstComponentFromCollection(){for(const t of this.texts)return t;for(const t of this.blocks)return t;for(const t of this.cells)return t}intersection(t){const e=new Ve;for(const s of this.cells)t.cells.has(s)&&e.cells.add(s);for(const s of this.texts)t.texts.has(s)&&e.texts.add(s);for(const s of this.blocks)t.blocks.has(s)&&e.blocks.add(s);return e}}class Q{constructor(t,e,s,r,n){this.id=t,this.label=e,this.type=s,this.initial=r,this.oninput=n}get_parsed_input(){const t=document.getElementById(this.id);return Ks(t.value,this.type)}}const V={u32:1,u8:2,f32:3,dim:4,str:5,name:6};function Ks(l,t){if(t===V.u32)return Ao(l);if(t===V.u8)return Po(l);if(t===V.f32)return Lo(l);if(t===V.dim)return Fs(l);if(t===V.str)return qr(l);if(t===V.name)return Qr(l)}function Ao(l){let t=Number(l),e=!0;return!Number.isInteger(t)|t<0|4294967295<t&&(e=!1),[t,e]}function Po(l){let t=Number(l),e=!0;return!Number.isInteger(t)|t<0|255<t&&(e=!1),[t,e]}function Lo(l){let t=Number(l),e=!0;return Number.isNaN(t)&&(e=!1),[t,e]}function Fs(l){let t=Number(l),e=!0;return Number.isNaN(t)|t<=0&&(e=!1),[t,e]}function qr(l){return[l,!0]}function Qr(l){let t=l,e=l.length>0;return[t,e]}class Ro{constructor(){R(this,"MODES",{HELP:"Help",FILE:"File",SELECT:"Select",SET_VALUES:"Outputs",PLACE_CELLS:"Cells",PLACE_LINKS:"Links",PLACE_BLOCKS:"Blocks",ROOT_BLOCK:"Template"});R(this,"currentMode",this.MODES.SELECT);R(this,"setCurrentMode_callback",null);R(this,"setCurrentPanel_callback",null);R(this,"elementMap",new Map);R(this,"isCanvasHovered",!0);R(this,"listener_window_onresize",null);R(this,"listener_canvas_onmouseenter",null);R(this,"listener_canvas_onmouseleave",null);R(this,"listener_canvas_contextmenu",null);R(this,"canvas",null);R(this,"show_tooltip_callback",null);R(this,"hide_tooltip_callback",null);R(this,"show_popup_callback",null);R(this,"hide_popup_callback",null);R(this,"header_btn_play",null);R(this,"place_dim_cell",[1,1,0]);R(this,"place_dim_block",[1,1,0]);R(this,"place_preview_cell",null);R(this,"place_preview_block",null);R(this,"cursor_isSelecting",!1);R(this,"cursor_isTranslating",!1);R(this,"cursor_radius",.5);R(this,"cursor_snap",.5);R(this,"cursor_pos",new vt);R(this,"cursor_dragBeg",new vt);R(this,"cursor_dragEnd",new vt);R(this,"cursor_dragAABB",new Float32Array(4));R(this,"translate_start",new vt);R(this,"translate_prev",new vt);R(this,"translate_curr",new vt);R(this,"collectionSelected",new Ve);R(this,"collectionHovered",new Ve);R(this,"collectionTranslating",new Ve);R(this,"info_select",["(Hotkey: x)","- Select items by clicking them, or by dragging to select all items in drag-area.","- Delete selected items by pressing 'DELETE' key.","- Move selected items by hovering over any selected item, then clicking and dragging cursor."].join(`
`));R(this,"table_select_cells",{title:"Cells",style:"width: 120px;",inputs:[new Q("tselcv","initial value",V.u32,0,this.oninput_select_c_v),new Q("tselcw","width",V.dim,1,this.oninput_select_c_w),new Q("tselch","height",V.dim,1,this.oninput_select_c_h),new Q("tselcr","rotation (deg)",V.f32,0,this.oninput_select_c_r)]});R(this,"table_select_blocks",{title:"Blocks",style:"width: 120px;",inputs:[new Q("tselbw","width",V.dim,1,this.oninput_select_b_w),new Q("tselbh","height",V.dim,1,this.oninput_select_b_h),new Q("tselbr","rotation (deg)",V.f32,0,this.oninput_select_b_r)]});R(this,"setval_value_lmb",4294967295);R(this,"setval_value_rmb",0);R(this,"info_setval",["(Hotkey: v)","- Set the output value of cells by hovering over them while the left or right mouse-button is down."].join(`
`));R(this,"table_setval",{title:"Set cell values",style:"width: 120px;",inputs:[new Q("tsetvl","value (LMB)",V.u32,"0xFFFFFFFF",this.oninput_setval_lmb),new Q("tsetvr","value (RMB)",V.u32,"0x00000000",this.oninput_setval_rmb)]});R(this,"info_place_cells",["(Hotkey: c)","- To place cells, click one of the cell types (ex: XOR), then clicking on canvas."].join(`
`));R(this,"table_place_cells",{title:"Cell properties",style:"width: 120px;",inputs:[new Q("tpcw","width",V.dim,"1",this.oninput_cell_w),new Q("tpch","height",V.dim,"1",this.oninput_cell_h),new Q("tpcr","rotation (deg)",V.f32,"0",this.oninput_cell_r)]});R(this,"wire_buttonStep",0);R(this,"wire_cell_targets",[]);R(this,"wire_cell_target_nearest",null);R(this,"wire_target1",null);R(this,"wire_target2",null);R(this,"wire_colour_r",255);R(this,"wire_colour_g",255);R(this,"wire_colour_b",200);R(this,"info_place_links",["(Hotkey: l)","- To place links, click near desired input/output of first cell,","then click again near desired output/input of second cell.","- To remove links, hold down the right mouse button and drag across them."].join(`
`));R(this,"table_place_links",{title:"Link properties",style:"width: 120px;",inputs:[new Q("tplr","red",V.u8,this.wire_colour_r,this.oninput_link_colour_r),new Q("tplg","green",V.u8,this.wire_colour_g,this.oninput_link_colour_g),new Q("tplb","blue",V.u8,this.wire_colour_b,this.oninput_link_colour_b)]});R(this,"info_place_blocks",["(Hotkey: b)","- To place blocks, click the block's name in the list of available block-templates.","- To edit a block, click the 'Edit' button beside the desired block's name.","- To remove a block-template, click the 'X' button beside the desired block's name."].join(`
`));R(this,"table_place_blocks",{title:"Block properties",style:"width: 120px;",inputs:[new Q("tpbw","width",V.dim,"1",this.oninput_block_w),new Q("tpbh","height",V.dim,"1",this.oninput_block_h),new Q("tpbr","rotation (deg)",V.f32,"0",this.oninput_block_r)]});R(this,"update_template_list_callback",null);R(this,"info_root_template",["- To modify properties of the current block-template, edit the desired fields, then press 'Submit'.","- To reset fields, press 'Cancel'."].join(`
`));R(this,"input_root_template_name",{style:"width: 150px;",input:new Q("trnm","Name",V.name,"_",this.empty_handler)});R(this,"input_root_template_desc",{style:"width: 150px; height: 80px;",input:new Q("trds","Description",V.str,"_",this.empty_handler)});R(this,"table_root_template",{title:"Properties",style:"width: 150px;",inputs:[new Q("triw","internal width",V.dim,"8",this.empty_handler),new Q("trih","internal height",V.dim,"8",this.empty_handler),new Q("trew","default block width",V.dim,"2",this.empty_handler),new Q("treh","default block height",V.dim,"2",this.empty_handler)]});R(this,"info_file_export",["- To create a new block, click 'New Block', then fill in block details.","- To import block-templates, paste text into text-area below 'Import' button, then press 'Import' button.","- To export block-templates, press 'Export' button. This will put a text representation of all loaded block-templates into the text-area below."].join(`
`));R(this,"input_file_export_exp",{style:"width: 150px; height: 80px; margin-top: 5px;",input:new Q("fexp","",V.str,"",this.empty_handler)});R(this,"input_file_export_imp",{style:"width: 150px; height: 80px; margin-top: 5px;",input:new Q("fimp","",V.str,"",this.empty_handler)})}init(){this.input=new Co}setCurrentMode(t){console.log("GameUI_v2.setCurrentMode(mode)",t),t===this.MODES.ROOT_BLOCK&&(t=this.MODES.SELECT),t===this.MODES.FILE&&(t=this.MODES.SELECT),t===this.MODES.HELP&&(t=this.MODES.SELECT),this.currentMode=t,Is.tryUntilTruthy(()=>this.setCurrentMode_callback,[],100,20).then(e=>e(t)).catch(()=>console.error("failed to call setCurrentMode_callback"))}get buttonDownL(){return this.input.button_prev.get(0)}get buttonDownR(){return this.input.button_prev.get(2)}get clickDeltaL(){return this.input.button_delta.get(0)}get clickDeltaR(){return this.input.button_delta.get(2)}get dragBegan(){return this.clickDeltaL===1&&this.isCanvasHovered&&this.isCanvasActive}get dragEnded(){return this.clickDeltaL===-1&&this.isCanvasHovered&&this.isCanvasActive}update(){const t=x.gameRenderer.camera,e=this.input;e.updateInputDeltas();const[s,r]=e.cursor_curr,{x:n,y:i,width:c,height:h}=this.getCanvas().getClientRects()[0];let d=Math.min(Math.max((s-n)/c,0),1),f=Math.min(Math.max((r-i)/h,0),1);d=(d*2-1)*1*t.aspectRatio,f=(f*2-1)*-1;const p=[d,f],b=new vt(t.pos.slice()),_=new vt(t.getRayDirection(p)),v=new vt([0,0,0]),g=new vt([1,0,0]),w=new vt([0,1,0]),[y,I]=Ft.collision_line_plane_3d(b,_,v,g,w);if(this.cursor_pos.set(I,0),this.dragBegan&&this.cursor_dragBeg.set(this.cursor_pos,0),this.buttonDownL){this.cursor_dragEnd.set(this.cursor_pos,0);const A=new Float32Array([...this.cursor_dragBeg,...this.cursor_dragEnd]);this.cursor_dragAABB.set(Ft.get_AABB_from_points_2d(A,0,6,3),0)}this.updateHoveredItems(),this.currentMode===this.MODES.SELECT?this.update_mode_select():(this.collectionSelected.clear(),this.collectionTranslating.clear(),this.cursor_isSelecting=!1,this.cursor_isTranslating=!1),this.currentMode===this.MODES.SET_VALUES&&this.update_mode_setval(),this.currentMode===this.MODES.PLACE_CELLS&&this.update_mode_place_cells(),this.currentMode===this.MODES.PLACE_LINKS?this.update_mode_place_links():this.wire_buttonStep=0,this.currentMode===this.MODES.PLACE_BLOCKS?this.update_mode_place_blocks():this.place_preview_block=null,this.update_hotkeys(),this.input.clearInputEvents()}update_hotkeys(){const t=!this.isInputElementActive,e=this.input,s=x.gameRenderer.camera;if(t&e.getKeydownDelta("p")===1&&this.onclick_toggle_play(this.header_btn_play,!0),t&e.getKeydownDelta("x")===1&&this.setCurrentMode(this.MODES.SELECT),t&e.getKeydownDelta("v")===1&&this.setCurrentMode(this.MODES.SET_VALUES),t&e.getKeydownDelta("c")===1&&this.setCurrentMode(this.MODES.PLACE_CELLS),t&e.getKeydownDelta("l")===1&&this.setCurrentMode(this.MODES.PLACE_LINKS),t&e.getKeydownDelta("b")===1&&this.setCurrentMode(this.MODES.PLACE_BLOCKS),t){const r=e.getKeydown("w")|e.getKeydown("ArrowUp"),n=e.getKeydown("a")|e.getKeydown("ArrowLeft"),i=e.getKeydown("s")|e.getKeydown("ArrowDown"),c=e.getKeydown("d")|e.getKeydown("ArrowRight"),h=(e.getKeydown("shift")?.5:5)*s.FOV;r&&s.move(0,+h,0),i&&s.move(0,-h,0),n&&s.move(-h,0,0),c&&s.move(+h,0,0);const d=.025;e.getKeydown("e")&&s.zoom(1-d),e.getKeydown("q")&&s.zoom(1+d)}this.isCanvasHovered&&e.wheel_event&&s.zoom(1+e.wheel_curr[1]*.001)}get isInputElementActive(){const e=document.activeElement.tagName.toLowerCase();return!!(e=="input"|e=="textarea")}unfocus(t){t.blur()}clickButton(t){t.toggled||(t.focus(),t.click(),t.blur())}empty_handler(t){}getElement(t){return this.elementMap.get(t)}setElement(t,e){return this.elementMap.set(t,e)}getElementValue(t){const e=this.elementMap.get(t);if(e)return e.value;console.error(`getElementValue(): elem with id ${t} not found`)}setElementValue(t,e){const s=this.elementMap.get(t);s?s.value=e:console.error(`setElementValue(): elem with id ${t} not found`)}setElementEnabled(t,e){const s=this.elementMap.get(t);s?s.disabled=!e:console.error(`setElementEnabled(): elem with id ${t} not found`)}getElementInputValid(t){const e=this.elementMap.get(t);if(e)return e.classList.contains("valid");console.error(`getElementInputValid(): elem with id ${t} not found`)}get isCanvasActive(){return!this.isInputElementActive}canvas_onmouseenter(){this.isCanvasHovered=!0}canvas_onmouseleave(){this.isCanvasHovered=!1}window_onresize(){console.log("resizing canvas");const t=this.getCanvas(),e=t.width,s=t.height,r=t.parentElement.getBoundingClientRect();Math.min(r.width/e,r.height/s);const n=window.devicePixelRatio;t.width=Math.floor(r.width*n),t.height=Math.floor(r.height*n),x.recreateRenderer(t)}getCanvas(){return this.canvas}setCanvas(t){if(this.canvas){const s=this.canvas;s.removeEventListener("mouseenter",this.listener_canvas_onmouseenter),s.removeEventListener("mouseleave",this.listener_canvas_onmouseleave),s.removeEventListener("contextmenu",this.listener_canvas_contextmenu),window.removeEventListener("resize",this.listener_window_onresize)}const e=this.canvas=t;this.listener_canvas_onmouseenter=s=>this.canvas_onmouseenter.call(this),this.listener_canvas_onmouseleave=s=>this.canvas_onmouseleave.call(this),this.listener_canvas_contextmenu=s=>s.preventDefault(),this.listener_window_onresize=s=>this.window_onresize.call(this),e.addEventListener("mouseenter",this.listener_canvas_onmouseenter),e.addEventListener("mouseleave",this.listener_canvas_onmouseleave),e.addEventListener("contextmenu",this.listener_canvas_contextmenu),window.addEventListener("resize",this.listener_window_onresize),this.window_onresize()}show_tooltip(t,e){this.show_tooltip_callback({target:t,innerHTML:e})}hide_tooltip(){this.hide_tooltip_callback()}show_tooltip_block_place(t,e){const s=x.blockLibrary.get_root_template_dependency_chain(e);let r="";if(s){r+='<div style="color:pink;">(Recursion safety) Block is not safe to place because it contains this template in its tree:</div>';for(let i=0;i<s.length;i++)r+=`<div>${i>0?"+":""}${new Array(i).fill("-").join("")}${s[i].name}</div>`}else e===x.blockLibrary.rootBlock.templateId?r+='<div style="color:pink;">(Recursion safety) Cannot place block inside of itself.</div>':r+='<div style="color:#afa;">Block is safe to place.</div>';const n=x.blockLibrary.templates.get(e);r+="<hr>",r+=`<div>${n.name}</div>`,r+="<br>",r+=`<div>${n.desc}</div>`,this.show_tooltip(t,r)}show_tooltip_block_remove(t,e){const s=x.blockLibrary.getTemplateDependents(e);if(s.length===0)this.show_tooltip(t,'<div style="color:#afa;">Block is safe to remove.</div>');else{let r="";r+='<div style="color:pink;">Block is not safe to remove because other templates are using it:</div>';for(const[n,i]of s)r+=`<div>${n.name} (${i}x)</div>`;this.show_tooltip(t,r)}}show_popup(t,e,s){this.show_popup_callback({innerHTML:t,onsubmit:e,oncancel:s})}hide_popup(){this.hide_popup_callback()}showLinkDeletionPopup(t,e,s,r){let n="";n+=`<div style="color:pink;">${e}</div>`;for(const[i,c]of t)i.templateId,n+=`<div>${i.name} (${c.length}x)</div>`;this.show_popup(n,s,r)}hideLinkDeletionPopup(){this.hide_popup()}showCrashPopup(t,e){alert(e+`

`+t)}onclick_toggle_play(t,e){e&&(x.simulationIsRunning=!x.simulationIsRunning),console.log("<>main.simulationIsRunning",x.simulationIsRunning);const s=x.simulationIsRunning;t.innerText=s?"Pause":"Play",t.title=s?"(Hotkey: p) Pause simulation":"(Hotkey: p) Run simulation"}onclick_reset_simulation(){x.simulationShouldReset=!0}init_play_header(t,e,s,r){console.log("<>",t,s,r),this.header_btn_play=t,t.onclick=()=>this.onclick_toggle_play(t,!0),this.onclick_toggle_play(t,!1),e.onclick=this.onclick_reset_simulation,e.title="Reset simulation";const n=.5,i=Math.round(1/n),c=20,h=(c-i)*6,d=v=>n*(v%(c-i)+i)*Math.pow(10,Math.floor(v/(c-i))),p=(v=>{let g=0,w=h,y=h/2;for(;g<y&&y<w;){const I=d(y);I<=v&&(g=y,y=(g+w)/2),I>=v&&(w=y,y=(g+w)/2)}return y})(x.simulationSpeed),b=v=>{const g=d(Number(v.target.value));x.simulationSpeed=g,r.innerText=`Speed: ${Number(g).toFixed(1)} steps/sec.`},_=s;_.min=0,_.max=h,_.step=1,_.value=p,_.oninput=b,_.oninput({target:{value:p}})}changedContent(){Tt.onChange()}changedRendering(){Tt.onChange()}add_cell(t){x.blockLibrary.rootBlock.insertCell(t)}add_link(t){x.blockLibrary.rootBlock.insertLink(t)}add_block(t){x.blockLibrary.rootBlock.insertBlock(t),this.on_minor_blocklib_change()}add_text(t){x.blockLibrary.rootBlock.insertText(t)}rem_cell(t){x.blockLibrary.rootBlock.deleteCell(t)}rem_link(t){x.blockLibrary.rootBlock.deleteLink(t)}rem_block(t){x.blockLibrary.rootBlock.deleteBlock(t),this.on_minor_blocklib_change()}rem_text(t){x.blockLibrary.rootBlock.deleteText(t)}move_item(t,e,s,r,n,i){const c=t.dimensions;c.x===e&c.y===s&c.w===r&c.h===n&c.r===i||(c.x=e,c.y=s,c.w=r,c.h=n,c.r=i,this.changedRendering())}translate_item(t,e,s){e===0&s===0||(t.dimensions.x+=e,t.dimensions.y+=s,this.changedRendering())}get_render_preview_cell(){return this.currentMode===this.MODES.PLACE_CELLS?this.place_preview_cell:null}get_render_preview_block(){return this.currentMode===this.MODES.PLACE_BLOCKS?this.place_preview_block:null}place_cursor_xy(){const t=this.cursor_snap,e=1/t,s=this.cursor_pos.slice(),r=[0,0];x.gameRenderer.renderBlock.contentTran.applyOffset(r,0,2,2);const n=Math.round((s[0]-r[0])*e)*t,i=Math.round((s[1]-r[1])*e)*t;return[n,i]}place_placementUpdate_cell(){const[t,e]=this.place_cursor_xy(),[s,r,n]=this.place_dim_cell;this.move_item(this.place_preview_cell,t,e,s,r,n)}place_placementUpdate_block(){if(!this.place_preview_block)return;const[e,s]=this.place_cursor_xy(),[r,n,i]=this.place_dim_block;this.move_item(this.place_preview_block,e,s,r,n,i)}place_placementPlace_cell(){const t=this.place_preview_cell.clone();t.id=j.next(),this.add_cell(t)}place_placementPlace_block(){const t=this.place_preview_block.clone();t.id=j.next(),this.add_block(t)}update_mode_place_cells(){this.place_preview_cell&&(this.place_placementUpdate_cell(),this.isCanvasHovered&&this.clickDeltaL==1&&this.place_placementPlace_cell())}update_mode_place_blocks(){this.place_preview_block&&(this.place_placementUpdate_block(),this.isCanvasHovered&&this.clickDeltaL==1&&this.place_placementPlace_block())}update_mode_select(){if(this.buttonDownL||this.collectionTranslating.clear(),this.dragBegan&&this.isCanvasHovered){let t=!1,e=this.input.getKeydown("Shift");if(!e){const s=this.collectionHovered.intersection(this.collectionSelected);console.log("hoveredAndSelected.count()",s.count()),s.count()>0?this.collectionTranslating.addFromCollection(this.collectionSelected):(this.collectionSelected.clear(),this.collectionSelected.addFirstComponentFromCollection(this.collectionHovered),this.collectionTranslating.clear(),this.collectionTranslating.addFromCollection(this.collectionSelected),this.on_selection_update()),t=this.collectionTranslating.count()>0,t&&(this.translate_start.set(this.cursor_pos),this.translate_prev.set(this.cursor_pos),this.translate_curr.set(this.cursor_pos))}this.cursor_isTranslating=t,this.cursor_isSelecting=!t,!e&&!t&&this.collectionSelected.clear()}this.dragEnded&&this.isCanvasHovered&&this.cursor_isSelecting&&(this.selectAllItemsInDragArea(),this.on_selection_update()),this.buttonDownL||(this.cursor_isSelecting=!1,this.cursor_isTranslating=!1),this.cursor_isTranslating&&this.translateAllSelectedItems(),this.input.getKeydownDelta("Delete")===1&&this.deleteSelectedItems()}clearCollections(){this.collectionSelected.clear(),this.collectionHovered.clear(),this.collectionTranslating.clear()}isItemInDragArea(t){const e=x.gameRenderer.renderBlock.get_axis_aligned_bounding_box(t);return ht.verifyType_throw(e,Float32Array),Ft.collision_aabb_aabb_2d(e,this.cursor_dragAABB)}isItemHovered(t){const e=x.gameRenderer.renderBlock.get_axis_aligned_bounding_box(t);return ht.verifyType_throw(e,Float32Array),Ft.collision_aabb_point_2d(e,this.cursor_pos)}selectAllItemsInDragArea(){const t=x.blockLibrary.rootBlock;for(const e of t.cells)this.isItemInDragArea(e)&&this.collectionSelected.cells.add(e);for(const e of t.texts)this.isItemInDragArea(e)&&this.collectionSelected.texts.add(e);for(const e of t.blocks)this.isItemInDragArea(e)&&this.collectionSelected.blocks.add(e)}updateHoveredItems(){this.collectionHovered.clear();const t=x.blockLibrary.rootBlock;for(const e of t.cells)this.isItemHovered(e)&&this.collectionHovered.cells.add(e);for(const e of t.texts)this.isItemHovered(e)&&this.collectionHovered.texts.add(e);for(const e of t.blocks)this.isItemHovered(e)&&this.collectionHovered.blocks.add(e)}translateAllSelectedItems(){this.translate_prev.set(this.translate_curr),this.translate_curr.set(this.cursor_pos);const t=this.cursor_snap,e=this.translate_prev.add(this.translate_start,-1).round(t),r=this.translate_curr.add(this.translate_start,-1).round(t).add(e,-1),n=r[0],i=r[1];for(const c of this.collectionTranslating.cells)this.translate_item(c,n,i);for(const c of this.collectionTranslating.texts)this.translate_item(c,n,i);for(const c of this.collectionTranslating.blocks)this.translate_item(c,n,i)}deleteSelectedItems(){x.blockLibrary.rootBlock;for(const t of this.collectionSelected.cells)this.rem_cell(t);for(const t of this.collectionSelected.texts)this.rem_text(t);for(const t of this.collectionSelected.blocks)this.rem_block(t);this.clearCollections()}get_selected_cells(){return[...this.collectionSelected.cells.values()]}get_selected_blocks(){return[...this.collectionSelected.blocks.values()]}items_set_v(t,e){if(t.length>0){this.changedContent();for(const s of t)s.value=e}}items_set_w(t,e){if(t.length>0){this.changedRendering();for(const s of t)s.dimensions.w=e}}items_set_h(t,e){if(t.length>0){this.changedRendering();for(const s of t)s.dimensions.h=e}}items_set_r(t,e){if(t.length>0){this.changedRendering();for(const s of t)s.dimensions.r=e/360}}oninput_select_c_v(t){const e=this.get_selected_cells();this.items_set_v(e,t),console.log("X",t)}oninput_select_c_w(t){const e=this.get_selected_cells();this.items_set_w(e,t)}oninput_select_c_h(t){const e=this.get_selected_cells();this.items_set_h(e,t)}oninput_select_c_r(t){const e=this.get_selected_cells();this.items_set_r(e,t)}oninput_select_b_w(t){const e=this.get_selected_blocks();this.items_set_w(e,t)}oninput_select_b_h(t){const e=this.get_selected_blocks();this.items_set_h(e,t)}oninput_select_b_r(t){const e=this.get_selected_blocks();this.items_set_r(e,t)}on_selection_update(){{const t=this.table_select_cells.inputs,e=this.get_selected_cells(),s=e.length>0;for(let r=0;r<t.length;r++)this.setElementEnabled(t[r].id,s);if(e.length>0){const r=e[0],n=[r.value,r.dimensions.w,r.dimensions.h,r.dimensions.r*360];for(let i=0;i<t.length;i++)this.setElementValue(t[i].id,n[i])}}{const t=this.table_select_blocks.inputs,e=this.get_selected_blocks(),s=e.length>0;for(let r=0;r<t.length;r++)this.setElementEnabled(t[r].id,s);if(e.length>0){const r=e[0],n=[r.dimensions.w,r.dimensions.h,r.dimensions.r*360];for(let i=0;i<t.length;i++)this.setElementValue(t[i].id,n[i])}}}update_mode_setval(){this.isCanvasHovered&&this.buttonDownL&&this.setval_hovered(this.setval_value_lmb),this.isCanvasHovered&&this.buttonDownR&&this.setval_hovered(this.setval_value_rmb)}setval_hovered(t){for(const e of this.collectionHovered.cells)x.gameServer.simulation_set_cell_value(j.THIS_BLOCK,e.id,t),e.type===Ae.CONSTANT.type&&(e.value=t)}oninput_setval_lmb(t){this.setval_value_lmb=t}oninput_setval_rmb(t){this.setval_value_rmb=t}onclick_cell_type(t,e){e&&(this.place_preview_cell=new rt(e,0)),this.place_preview_cell?this.setCurrentMode(this.MODES.PLACE_CELLS):this.setCurrentMode(null);const s="panel_cell_btn_toggled";let r=this.getElement(s);r==null||r.setAttribute("toggled",!1),r=t.target,r==null||r.setAttribute("toggled",!0),this.setElement(s,r)}oninput_cell_w(t){this.place_dim_cell[0]=t}oninput_cell_h(t){this.place_dim_cell[1]=t}oninput_cell_r(t){this.place_dim_cell[2]=t/360}get_wire_colour(){return this.wire_colour_r<<24|this.wire_colour_g<<16|this.wire_colour_b<<8|255}update_mode_place_links(){const t=x.blockLibrary,e=t.get_all_cell_targets();this.wire_cell_targets=e;const s=this.wire_buttonStep>0?this.wire_target1[3]:rt.LINK_TARGET.NONE;if(this.wire_cell_target_nearest=t.get_nearst_cell_target(e,this.cursor_pos,s),this.wire_buttonStep===0&&this.dragBegan&&(this.wire_target1=this.wire_cell_target_nearest,this.wire_target1!==null&&(this.wire_buttonStep=1)),this.wire_buttonStep===1&&this.dragBegan){this.wire_target2=this.wire_cell_target_nearest;const r=this.wire_target1[3],n=this.wire_target2[3],i=rt.LINK_TARGET.OUTPUT;r!=n&(r==i|n==i)&&(this.wire_buttonStep=2)}if(this.wire_buttonStep===2){const r=rt.LINK_TARGET.OUTPUT,n=this.wire_target1,i=this.wire_target2;let c=n[3]===r?n:i,h=n[3]!==r?n:i;const[d,f,p,b]=c,[_,v,g,w]=h,y=this.get_wire_colour(),I=new de(f,v,p,g,w,y);this.add_link(I),console.log("NEW LINK",I),this.wire_buttonStep=0}this.buttonDownR&&(this.wire_buttonStep=0,this.deleteHoveredLinks())}isLinkHovered(t){const e=x.gameRenderer.renderBlock.l_points.get(t.id),s=new he(this.cursor_pos.slice(0,2)),r=new he(e.slice(0,2)),n=new he(e.slice(3,5)),i=Ft.nearestPoint_point_line_segment_2d(s,r,n);return new vt([i[0],i[1],0]).add(this.cursor_pos,-1).hypot()<=this.cursor_radius}deleteHoveredLinks(){const t=x.blockLibrary.rootBlock,e=new Set;for(const s of t.links)this.isLinkHovered(s)&&e.add(s);for(const s of e.keys())this.rem_link(s)}get_link_draw_points(){if(this.currentMode!==this.MODES.PLACE_LINKS)return[];if(!this.wire_cell_target_nearest)return[];const t=[];return this.wire_cell_target_nearest,t.push(this.wire_cell_target_nearest[0]),this.wire_buttonStep>=1&&t.push(this.wire_target1[0]),this.wire_buttonStep>=2&&t.push(this.wire_target2[0]),t}oninput_link_colour_r(t){this.wire_colour_r=t}oninput_link_colour_g(t){this.wire_colour_g=t}oninput_link_colour_b(t){this.wire_colour_b=t}onclick_block_type(t,e){if(e){const c=new $t(0,0,1,1,0);this.place_preview_block=new Lt(c,e)}const s=x.blockLibrary,r=e&&s.templates.has(e)&&!s.containsRootTemplateInTree(e);this.place_preview_block&&r?this.setCurrentMode(this.MODES.PLACE_BLOCKS):this.setCurrentMode(null);const n="panel_block_btn_toggled";let i=this.getElement(n);i==null||i.setAttribute("toggled",!1),i=t==null?void 0:t.target,i==null||i.setAttribute("toggled",!0),this.setElement(n,i)}onclick_block_edit(t,e){x.set_root_block_template(e)}onclick_block_place(t,e){this.onclick_block_type(t,e);const s=this.table_place_blocks.inputs,r=x.blockLibrary.templates.get(e);this.setElementValue(s[0].id,r.placeW),this.setElementValue(s[1].id,r.placeH),this.oninput_block_w(r.placeW),this.oninput_block_h(r.placeH)}onclick_block_remove(t,e){this.onclick_block_type(null,j.NONE),x.blockLibrary.deleteBlockTemplate(e),this.changedRendering()}oninput_block_w(t){this.place_dim_block[0]=t}oninput_block_h(t){this.place_dim_block[1]=t}oninput_block_r(t){this.place_dim_block[2]=t/360}update_template_list(){const t=x.blockLibrary;if(!t.rootBlock)return;const e=[];for(const[s,r]of t.templates.entries()){const i=t.rootBlock.templateId===s,c=!t.containsRootTemplateInTree(s),h=t.canDeleteBlockTemplate(s),d={templateId:s,name:r.name,isEditing:i,canPlace:c,canRemove:h};e.push(d)}Is.tryUntilTruthy(()=>this.update_template_list_callback,[],100,20).then(s=>s(e)).catch(()=>console.error("failed to call update_template_list_callback"))}onmouseenter_block_place(t,e){this.show_tooltip_block_place(t.target,e)}onmouseleave_block_place(t,e){this.hide_tooltip()}onmouseenter_block_remove(t,e){this.show_tooltip_block_remove(t.target,e)}onmouseleave_block_remove(t,e){this.hide_tooltip()}on_major_blocklib_change(){this.clearCollections(),this.update_template_list(),this.rootbt_panel&&this.refresh_rootbt_inputs()}on_minor_blocklib_change(){this.update_template_list(),this.rootbt_panel&&this.refresh_rootbt_inputs()}root_template_reset_inputs(){Is.tryUntilTruthy(t=>this.getElement.call(this,t),this.input_root_template_name.input.id,100,20).then(()=>{const t=x.blockLibrary.rootBlock.template;this.setElementValue(this.input_root_template_name.input.id,t.name),this.setElementValue(this.input_root_template_desc.input.id,t.desc),this.setElementValue(this.table_root_template.inputs[0].id,t.width),this.setElementValue(this.table_root_template.inputs[1].id,t.height),this.setElementValue(this.table_root_template.inputs[2].id,t.placeW),this.setElementValue(this.table_root_template.inputs[3].id,t.placeH)})}root_template_onsubmit(){const t=x.blockLibrary.rootBlock.template,e=[];let s="",r="",n=[0,0,0,0];{const i=this.input_root_template_name.input.id,c=this.getElementValue(i);this.getElementInputValid(i)?s=c:e.push(`name [${c}] is not valid.`)}{const i=this.input_root_template_desc.input.id;r=this.getElementValue(i)}for(let i=0;i<this.table_root_template.inputs.length;i++){const c=this.table_root_template.inputs[i],[h,d]=c.get_parsed_input();d?n[i]=h:e.push(`${c.label} [${h}] is not valid.`)}e.length>0?alert(`failed to submit some or all of given inputs:
`+e.join(`
`)):(t.name=s,t.desc=r,t.width=n[0],t.height=n[1],t.placeW=n[2],t.placeH=n[3],x.refresh_root_block_template(),this.root_template_reset_inputs())}root_template_oncancel(){this.root_template_reset_inputs()}onclick_file_export(){const t=this.getElement(this.input_file_export_exp.input.id);t.value=x.blockLibrary.exportTemplates()}onclick_file_import(){const e=this.getElement(this.input_file_export_imp.input.id).value;x.blockLibrary.importTemplates(e),x.refresh_root_block_template()}show_new_template_popup(){const t="ntpw",e="ntph",s="ntpn",r="ntpd";let n="";n+=`
			<div>Width</div>
			<input type="text" id=${t}></input>
			<div>Height</div>
			<input type="text" id=${e}></input>
			<div>Name</div>
			<input type="text" id=${s}></input>
			<div>Description (optional)</div>
			<textarea id=${r} style:"width:500px;height:300px;"></textarea>
		`;const i=()=>{const[h,d]=Fs(document.getElementById(t).value),[f,p]=Fs(document.getElementById(e).value),[b,_]=Qr(document.getElementById(s).value),[v,g]=qr(document.getElementById(r).value),w=[];d||w.push(`width [${h}] is not valid.`),p||w.push(`height [${f}] is not valid.`),_||w.push(`name [${b}] is not valid.`),g||w.push(`description [${v}] is not valid.`),w.length>0?alert(`One or more inputs were invalid:
`+w.join(`
`)):(x.blockLibrary.createNewBlockTemplate(Math.ceil(h),Math.ceil(f),b,v),this.hide_new_template_popup())},c=()=>{this.hide_new_template_popup()};this.show_popup(n,i,c)}hide_new_template_popup(){this.hide_popup()}}class No{constructor(){this.gameServer=null,this.gameUI=null,this.gameRenderer=null,this.blockLibrary=null,this.frameCounter=0,this.simulationShouldRebuild=!0,this.simulationShouldReset=!0,this.simulationSpeed=60,this.simulationDatePrev=0,this.simulationIsRunning=!0,this.maxDrawDepth=2}async init(){this.gameUI=new Ro,this.gameUI.init(),this.gameServer=new lo,await this.gameServer.isReady,console.log("gameServer is ready"),this.blockLibrary=new co,this.blockLibrary.importTemplates(JSON.stringify(oo)),console.log("loaded templates",this.blockLibrary.templates);let t=null;for(const e of this.blockLibrary.templates.keys()){t=e;break}this.set_root_block_template(t),requestAnimationFrame(e=>this.update.call(this,e))}recreateRenderer(t){this.gameRenderer=new Xr(t)}async update(t){try{if(!this.gameRenderer){console.log("game renderer is not ready yet!"),requestAnimationFrame(b=>this.update.call(this,b));return}St.reset();const e=Date.now();this.frameCounter++;const s=this.blockLibrary;await s.verifyLinksCanFindTargets(),this.gameUI.update(),await s.verifyLinksCanFindTargets();const r=s.rootBlock.templateId,n=Date.now();if(this.simulationShouldRebuild|this.simulationShouldReset){console.log("REBUILDING SIMULATION");const b=!this.simulationShouldReset;this.gameServer.send_templates(s.templates,r),this.gameServer.simulation_rebuild(r,b),this.simulationShouldRebuild=!1,this.simulationShouldReset=!1}const i=Date.now();this.simulationDatePrev===0&&(this.simulationDatePrev=Date.now());const c=Math.floor(this.simulationSpeed*.001*this.simulationDatePrev),d=Math.floor(this.simulationSpeed*.001*Date.now())-c;this.simulationIsRunning&&this.gameServer.simulation_update(d),this.simulationDatePrev=Date.now();const f=Date.now();this.gameRenderer.render();const p=Date.now();St.increment_time("sim.rebuild",i-n),St.increment_time("sim.update ",f-i),St.increment_time("main.update",p-e),St.log_all(),requestAnimationFrame(b=>this.update.call(this,b))}catch(e){throw this.gameUI.showCrashPopup(e,"application crashed during Main.update()"),e}}onRootContentChanged_addCell(t){this.simulationShouldRebuild=!0}onRootContentChanged_remCell(t){this.simulationShouldRebuild=!0}onRootContentChanged_addLink(t){this.simulationShouldRebuild=!0}onRootContentChanged_remLink(t){this.simulationShouldRebuild=!0}onRootContentChanged_addBlock(t){this.simulationShouldRebuild=!0}onRootContentChanged_remBlock(t){this.simulationShouldRebuild=!0}set_root_block_template(t){this.blockLibrary.set_root_block_template(t),Tt.onChange(),this.simulationShouldRebuild=!0,this.gameUI.on_major_blocklib_change(),this.gameUI.root_template_reset_inputs(),this.gameUI.onclick_block_type(null,j.NONE)}refresh_root_block_template(){this.blockLibrary.refresh_root_block_template(),Tt.onChange(),this.gameUI.on_minor_blocklib_change()}}const x=new No;var Do=G("<button><!></button>");function wt(l,t){nt(t,!0);const e=Qt(t,["$$slots","$$events","$$legacy"]);let s=null;ke(()=>{x.gameUI.elementMap.set(t.id,s)});var r=Do();let n;var i=z(r);qt(i,()=>(t==null?void 0:t.children)??ue),Y(r),mt(()=>n=Jt(r,n,{...e},"svelte-1ao9cra")),M(l,r),it()}var Oo=G("<canvas></canvas>");function $o(l,t){nt(t,!0);const e=Qt(t,["$$slots","$$events","$$legacy"]);let s=st(null);ke(()=>{x.gameUI.setCanvas(O(s))});function r(c){console.log("resize",c)}var n=Oo();let i;Pe(n,c=>Z(s,c),()=>O(s)),mt(()=>i=Jt(n,i,{onresize:r,...e},"svelte-eeadlf")),M(l,n),it()}var Bo=G("<div><!></div>");function Mo(l,t){nt(t,!0);const e=Qt(t,["$$slots","$$events","$$legacy"]);var s=Bo();let r;var n=z(s);qt(n,()=>(t==null?void 0:t.children)??ue),Y(s),mt(()=>r=Jt(s,r,{...e},"svelte-15xi3mk")),M(l,s),it()}var Uo=G("<div><!></div>");function Fo(l,t){nt(t,!0);const e=Qt(t,["$$slots","$$events","$$legacy"]);var s=Uo();let r;var n=z(s);qt(n,()=>(t==null?void 0:t.children)??ue),Y(s),mt(()=>r=Jt(s,r,{...e},"svelte-189klgo")),M(l,s),it()}var Ho=G("<div><!></div>");function je(l,t){nt(t,!0);const e=Qt(t,["$$slots","$$events","$$legacy"]);var s=Ho();let r;var n=z(s);qt(n,()=>(t==null?void 0:t.children)??ue),Y(s),mt(()=>r=Jt(s,r,{...e},"svelte-y9e8ss")),M(l,s),it()}var Wo=G("<div><!></div>");function Go(l,t){nt(t,!0);const e=Qt(t,["$$slots","$$events","$$legacy"]);var s=Wo();let r;var n=z(s);qt(n,()=>(t==null?void 0:t.children)??ue),Y(s),mt(()=>r=Jt(s,r,{...e},"svelte-1o4do4g")),M(l,s),it()}var Vo=G("<div><!></div>");function Ht(l,t){nt(t,!0);const e=ce(()=>t.rows?`grid-template-rows: ${t.rows};`:""),s=ce(()=>t.cols?`grid-template-columns: ${t.cols};`:"");var r=Vo(),n=z(r);qt(n,()=>(t==null?void 0:t.children)??ue),Y(r),mt(()=>{Xt(r,"id",t==null?void 0:t.id),Gr(r,Hr(t==null?void 0:t.class),"svelte-xca7rc"),Xt(r,"style",`${O(s)??""} ${O(e)??""} ${(t==null?void 0:t.style)??""}`)}),M(l,r),it()}var jo=G("<div></div>"),Ko=G("<div><!> <input></div>");function Jr(l,t){nt(t,!0);const e=Qt(t,["$$slots","$$events","$$legacy"]),{type:s,label:r,initial:n,oninput:i}=e;let c=st(null);ke(()=>{x.gameUI.elementMap.set(t.id,O(c))});let h=st(_t(n)),d=st(!0);function f(){const[w,y]=Ks(O(h),s);Z(d,_t(y)),y&&i.call(x.gameUI,w)}var p=Ko(),b=z(p);{var _=w=>{var y=jo();y.textContent=r,M(w,y)};Ce(b,w=>{r&&w(_)})}var v=K(b,2);ro(v);let g;Pe(v,w=>Z(c,w),()=>O(c)),Y(p),mt(()=>g=Jt(v,g,{...e,class:O(d)?"valid":"error",oninput:f},"svelte-1p5jytf")),Vr(v,()=>O(h),w=>Z(h,w)),M(l,p),it()}var zo=G("<div></div>"),Yo=G("<div><!> <textarea></textarea></div>");function Hs(l,t){nt(t,!0);const e=Qt(t,["$$slots","$$events","$$legacy"]),{type:s,label:r,initial:n,oninput:i}=e;let c=st(null);ke(()=>{x.gameUI.elementMap.set(t.id,O(c))});let h=st(_t(n)),d=st(!0);function f(){const[w,y]=Ks(O(h),s);Z(d,_t(y)),y&&i.call(x.gameUI,w)}var p=Yo(),b=z(p);{var _=w=>{var y=zo();y.textContent=r,M(w,y)};Ce(b,w=>{r&&w(_)})}var v=K(b,2);Ji(v);let g;Pe(v,w=>Z(c,w),()=>O(c)),Y(p),mt(()=>g=Jt(v,g,{...e,class:O(d)?"valid":"error",oninput:f},"svelte-bezk3n")),Vr(v,()=>O(h),w=>Z(h,w)),M(l,p),it()}var Xo=G('<div><div class="title svelte-1ou3wvw"></div> <!></div>');function ye(l,t){const e=Qt(t,["$$slots","$$events","$$legacy"]),{title:s,inputs:r}=e;var n=Xo();let i;var c=z(n);c.textContent=s;var h=K(c,2);Re(h,17,()=>r,Le,(d,f)=>{Jr(d,It(()=>O(f)))}),Y(n),mt(()=>i=Jt(n,i,{class:"wrapper outline",...e},"svelte-1ou3wvw")),M(l,n)}var qo=G("<!> <!>",1),Qo=G("<!> <div><!> <!></div> <!>",1),Jo=G('<div><div class="outline inner svelte-n6pyet"><!></div></div>');function Zr(l,t){nt(t,!0);var e=Jo(),s=z(e),r=z(s);Ht(r,{rows:"auto auto",children:(n,i)=>{var c=Qo(),h=dt(c);Ht(h,{cols:"1fr",children:(_,v)=>{var g=le(),w=dt(g);{var y=I=>{wt(I,{onclick:()=>t.onclose(),style:"background:#033; right:0px;",children:(A,E)=>{bt();var k=gt("Close");M(A,k)},$$slots:{default:!0}})};Ce(w,I=>{t!=null&&t.onclose&&I(y)})}M(_,g)},$$slots:{default:!0}});var d=K(h,2),f=z(d);ls(f,()=>t==null?void 0:t.innerHTML);var p=K(f,2);qt(p,()=>(t==null?void 0:t.children)??ue),Y(d);var b=K(d,2);Ht(b,{cols:"1fr 1fr",children:(_,v)=>{var g=qo(),w=dt(g);{var y=E=>{wt(E,{onclick:()=>t.oncancel(),style:"background:#300; left:0px;",children:(k,N)=>{bt();var J=gt("Cancel");M(k,J)},$$slots:{default:!0}})};Ce(w,E=>{t!=null&&t.oncancel&&E(y)})}var I=K(w,2);{var A=E=>{wt(E,{onclick:()=>t.onsubmit(),style:"background:#033; right:0px;",children:(k,N)=>{bt();var J=gt("Submit");M(k,J)},$$slots:{default:!0}})};Ce(I,E=>{t!=null&&t.onsubmit&&E(A)})}M(_,g)},$$slots:{default:!0}}),M(n,c)},$$slots:{default:!0}}),Y(s),Y(e),mt(()=>{Gr(e,`${`underlay ${(t==null?void 0:t.class)??""}`??""} svelte-n6pyet`),Xt(e,"style",t==null?void 0:t.style)}),M(l,e),it()}var Zo=G('<div class="tooltip outline svelte-i3efh6"><!></div>');function ta(l,t){nt(t,!0);let e=st(null);ke(()=>{{const n=t.target;if(!n)return;const{x:i,y:c,width:h,height:d}=n.getClientRects()[0];O(e).style.top=`${c}px`,O(e).style.left=`${i+h+5}px`}{const n=O(e).parentElement.getClientRects()[0],{x:i,y:c,width:h,height:d}=O(e).getClientRects()[0],f=n.right-(i+h),p=n.bottom-(c+d);f<0&&(O(e).style.left=`${f+i+h}px`),p<0&&(O(e).style.top=`${p+c}px`)}});var s=Zo(),r=z(s);ls(r,()=>t.innerHTML),Y(s),Pe(s,n=>Z(e,n),()=>O(e)),M(l,s),it()}var ea=G("<div><!></div>");function sa(l,t){nt(t,!1),Ye();var e=ea(),s=z(e);ye(s,It(()=>x.gameUI.table_setval)),Y(e),M(l,e),it()}var ra=G("<div><!> <!></div>");function na(l,t){nt(t,!0),ke(()=>{x.gameUI.on_selection_update()});var e=ra(),s=z(e);ye(s,It(()=>x.gameUI.table_select_cells));var r=K(s,2);ye(r,It(()=>x.gameUI.table_select_blocks)),Y(e),M(l,e),it()}var ia=G('<div><!> <div style="margin:5px;"><!></div></div>');function oa(l,t){nt(t,!1);const e=[...Object.values(Ae)];function s(d,f){x.gameUI.onclick_cell_type.call(x.gameUI,d,f)}function r(d){const f=(d>>24&255)/2,p=(d>>16&255)/2,b=(d>>8&255)/2,_=d>>0&255;return f<<24|p<<16|b<<8|_}Ye();var n=ia(),i=z(n);ye(i,It(()=>x.gameUI.table_place_cells));var c=K(i,2),h=z(c);Ht(h,{cols:"1fr 1fr",children:(d,f)=>{var p=le(),b=dt(p);Re(b,1,()=>e,Le,(_,v)=>{var g=Gi(()=>`
					height:24px; border-radius:2px; margin:1px;
					background:#${r(O(v).clr).toString(16)};
				`);wt(_,{onclick:w=>s(w,O(v).type),class:"outline",get style(){return O(g)},children:(w,y)=>{bt();var I=gt();mt(()=>_s(I,O(v).tstr)),M(w,I)},$$slots:{default:!0}})}),M(d,p)},$$slots:{default:!0}}),Y(c),Y(n),M(l,n),it()}var aa=G("<div><!></div>");function la(l,t){nt(t,!1),Ye();var e=aa(),s=z(e);ye(s,It(()=>x.gameUI.table_place_links)),Y(e),M(l,e),it()}var ca=G("<!> <!> <!>",1),ha=G("<div><!> <!></div>");function da(l,t){nt(t,!0);let e=st(_t([]));function s(h){Z(e,_t(h))}const r=x.gameUI;r.update_template_list_callback=s;var n=ha(),i=z(n);ye(i,It(()=>r.table_place_blocks));var c=K(i,2);Ht(c,{cols:"auto 1fr auto",children:(h,d)=>{var f=le(),p=dt(f);Re(p,17,()=>O(e),Le,(b,_)=>{let v=()=>O(_).templateId,g=()=>O(_).name,w=()=>O(_).isEditing,y=()=>O(_).canPlace,I=()=>O(_).canRemove;var A=ca(),E=dt(A);wt(E,{get disabled(){return w()},onclick:H=>r.onclick_block_edit(H,v()),get toggled(){return w()},children:(H,ft)=>{bt();var X=gt("Edit");M(H,X)},$$slots:{default:!0}});var k=K(E,2),N=ce(()=>!y());wt(k,{get disabled(){return O(N)},onclick:H=>r.onclick_block_place(H,v()),onmouseenter:H=>r.onmouseenter_block_place(H,v()),onmouseleave:H=>r.onmouseleave_block_place(H,v()),children:(H,ft)=>{bt();var X=gt();mt(()=>_s(X,g())),M(H,X)},$$slots:{default:!0}});var J=K(k,2),D=ce(()=>!I());wt(J,{get disabled(){return O(D)},onclick:H=>r.onclick_block_remove(H,v()),onmouseenter:H=>r.onmouseenter_block_remove(H,v()),onmouseleave:H=>r.onmouseleave_block_remove(H,v()),style:"min-width:20px; background:#703;",children:(H,ft)=>{bt();var X=gt("X");M(H,X)},$$slots:{default:!0}}),M(b,A)}),M(h,f)},$$slots:{default:!0}}),Y(n),M(l,n),it()}var ua=G("<!> <!>",1),_a=G('<div><div class="outline" style="margin:5px; padding:5px;"><!> <!></div> <!> <!></div>');function fa(l,t){nt(t,!1);const e=x.gameUI,s=e.input_root_template_name,r=e.input_root_template_desc,n={...s.input,style:s.style},i={...r.input,style:r.style},c=()=>e.root_template_oncancel.call(e),h=()=>e.root_template_onsubmit.call(e);Ye();var d=_a(),f=z(d),p=z(f);Jr(p,It(n));var b=K(p,2);Hs(b,It(i)),Y(f);var _=K(f,2);ye(_,It(()=>e.table_root_template));var v=K(_,2);Ht(v,{cols:"1fr 1fr",style:"margin:5px; width:unset;",children:(g,w)=>{var y=ua(),I=dt(y);wt(I,{onclick:c,class:"outline",style:"width:unset;",children:(E,k)=>{bt();var N=gt("Cancel");M(E,N)},$$slots:{default:!0}});var A=K(I,2);wt(A,{onclick:h,class:"outline",style:"width:unset;",children:(E,k)=>{bt();var N=gt("Submit");M(E,N)},$$slots:{default:!0}}),M(g,y)},$$slots:{default:!0}}),Y(d),M(l,d),it()}var pa=G('<div><div class="outline" style="margin:5px; padding:2px;"><!></div> <div class="outline" style="margin:5px; padding:2px;"><!> <!></div> <div class="outline" style="margin:5px; padding:2px;"><!> <!></div></div>');function ma(l,t){nt(t,!1);const e=x.gameUI,s=e.input_file_export_exp,r=e.input_file_export_imp,n={...s.input,style:s.style},i={...r.input,style:r.style},c=()=>e.show_new_template_popup.call(e),h=()=>e.onclick_file_export.call(e),d=()=>e.onclick_file_import.call(e);Ye();var f=pa(),p=z(f),b=z(p);wt(b,{onclick:c,style:"width:100%;",children:(A,E)=>{bt();var k=gt("New Block");M(A,k)},$$slots:{default:!0}}),Y(p);var _=K(p,2),v=z(_);wt(v,{onclick:d,style:"width:100%;",children:(A,E)=>{bt();var k=gt("Import");M(A,k)},$$slots:{default:!0}});var g=K(v,2);Hs(g,It(i)),Y(_);var w=K(_,2),y=z(w);wt(y,{onclick:h,style:"width:100%;",children:(A,E)=>{bt();var k=gt("Export");M(A,k)},$$slots:{default:!0}});var I=K(y,2);Hs(I,It(n)),Y(w),Y(f),M(l,f),it()}const va="Introduction",ga=`
First, a couple basic notes about how this app works:

1. You can place cells, which perform logical (or arithmetic) operations on their inputs, for example NAND, or MULTIPLY.

2. You can link cell outputs to cell inputs.

3. You can place "blocks", which are instances of "block-templates". The one you are currently editing is called the "root block-template" or "current template". You can also import and export collections of block-templates as JSON text.

4. When you place an item, the simulation will automatically rebuild (this is why cells sometimes flicker after placing an item).
`,ba="New Blocks + Import/Export",wa=`
To create a new block template, open the "File" panel, and press "New Block". Then, fill in the "width", "height", and "name" fields in the dialog that opens, then press "submit" (the "description" field is optional).

To export all loaded block templates as JSON text, open the "File" panel and press the "Export" button, this will populate the text-area underneath.

To import block templates, paste valid JSON text in the text-area below the "Import" button, then press "Import".

Notes & Warnings:
- placing invalid JSON in the import text-area may do nothing, spawn an error dialog or alert, or cause the app to crash.
- to change the order that blocks are shown in the list, you can re-arrange the order they appear in the exported JSON then re-import. (the app doesnt yet have list management functionality, but it is on the to-do list.)
<span style='color:pink;'>- WARNING: Editing the exported JSON may break the block templates, or cause cells to go missing (which some links expect to be there). All components have an ID, which is used for linking, simulating, and drawing components, but modifying this manually can break things. At best the app will detect this and try to delete disconnected links (to prevent a crash), but it may also just crash.</span>
`,ya="Selecting, modifying, and deleting components.",ka=`
To select cells and/or blocks, open the "Select" panel, then click, drag, and release to select all the cells/blocks in the highlighted area.

To move items, click on one of the items that are currently selected, then drag them to their new destination (this will move all other selected items as well).

To delete selected items, press the "delete" key.

To change properties of selected items (ex. width), change values in the "Cell properties" table or "Block properties" table.
`,Ta="Cells",Ea=`
To place cells, open the "Cells" panel and select one of the available cell types then place them somewhere in the current template. To Change the size or rotation of placed cells, change the values in the "Properties" table.

Notes:
- All cells have 3 values: INPUT-A, INPUT-B, and OUTPUT. The two exceptions to this rule are the CONSTANT cell, which just outputs some constant value, the COPY cell, which copies the value from INPUT-A, and the NOT cell, which negates (bitwise) the value of INPUT-A.
- All cell values are 32-bit integers. This includes the output of logical operators such as '>' and '==', which output bitmasks where all bits are active. These can still be used to build single-bit circuits though, by treating "0xFFFFFFFF" as "1", and "0x00000000" as "0".
`,xa="Links",Sa=`
To place links, open the "Links" panel, then click on (or near) one the the cells inputs/outputs, then click on a another cell's input/output.

To remove links, hold down the right mouse button and sweep across all links you want to delete (any link in the current template that touches the ring around the cursor will be deleted).

<span style='color:#cfe'>Dev-note: link placement was implemented this way for simplicity, but I intent on making substantial improvements to Links in the future.
(for example allowing placement of wire paths/traces).</span>
`,Ia="Blocks",Ca=`
To place blocks, open the "Blocks" panel and press the middle button with the name of the block you want to place, then place it somewhere in the current template.

To switch to editing a different block-template, pres the "edit" button beside the name of the block you want to edit.

To delete a block-template, press the "X" button beside the name of the block you want to remove.

Notes:
- you cannot delete a block template that is currently being used by another template.
- you cannot place a block template inside of itself (or any blocks it contains), as this would cause infinite recursion.
`,Aa="Modifying cell values",Pa=`
To change the current output value of cells, open the "Values" panel, then while left or right mouse button is held down, hover over cells.

Modify the left (LMB) and right (RMB) values in the "Set cell values" table to pick what these values will be.

Notes:
- these values can be written as integers (ex. "1", "5", "2147483647"), but they can also be specified in hexidecimal by appending the "0x" prefix to the number, for example "0x5a" or "0xFFE3" or "0x0000ffe3".
`,La="Editing the root block-template properties",Ra=`
To modify properties of the current template, open the "Root" panel, then input new values into the fields. To submit these changes, press "Submit". To reset the fields, press "Cancel".

Notes:
- the "internal width/height" fields determine how large the block is "on the inside" i.e. when you are editing it.
- the "default placement width/height" fields determine the initial dimensions of blocks that you are placing, i.e. how large they are "on the outside".
`;var Na=G('<b style="background:#234; padding:5px;"><!></b> <p><!></p>',1),Da=G("<!> <!>",1);function Oa(l,t){nt(t,!0);function e(){x.gameUI.setCurrentPanel_callback(null)}const r=[...Object.entries({INTRO:{head:va,text:ga,name:"Introduction"},FILE:{head:ba,text:wa,name:"File"},SELECT:{head:ya,text:ka,name:"Select"},VALUES:{head:Aa,text:Pa,name:"Outputs"},CELLS:{head:Ta,text:Ea,name:"Cells"},LINKS:{head:xa,text:Sa,name:"Links"},BLOCKS:{head:Ia,text:Ca,name:"Blocks"},ROOT:{head:La,text:Ra,name:"Template"}})];let n=st(null);function i(c){return c.replace(`
`,"").replaceAll(`
`,"<br/>").replaceAll(">- ","><span style='display:inline-block; margin-top:10px; margin-right:5px;'>-</span>").replaceAll("(","<span style='color:#cce'>(").replaceAll(")",")</span>").replaceAll("	","<span style='margin-right:20px'></span>")}Zr(l,{onclose:e,id:"panel_help",children:(c,h)=>{Ht(c,{cols:"auto 1fr",style:"width:90vw; height:85vh;",children:(d,f)=>{var p=Da(),b=dt(p);je(b,{children:(v,g)=>{var w=le(),y=dt(w);Re(y,17,()=>r,Le,(I,A)=>{let E=()=>O(A)[1];var k=ce(()=>O(n)===E());wt(I,{onclick:()=>{Z(n,_t(E())),console.log("<>onclick")},get toggled(){return O(k)},children:(N,J)=>{bt();var D=gt();mt(()=>_s(D,E().name)),M(N,D)},$$slots:{default:!0}})}),M(v,w)},$$slots:{default:!0}});var _=K(b,2);je(_,{style:"padding-right:10px; margin-left:10px; padding-top:5px;",children:(v,g)=>{var w=le(),y=dt(w);{var I=A=>{var E=Na(),k=dt(E),N=z(k);ls(N,()=>i(O(n).head)),Y(k);var J=K(k,2),D=z(J);ls(D,()=>i(O(n).text)),Y(J),M(A,E)};Ce(y,A=>{O(n)&&A(I)})}M(v,w)},$$slots:{default:!0}}),M(d,p)},$$slots:{default:!0}})},$$slots:{default:!0}}),it()}var $a=G('<input type="range"> <div style="align-content:center;"></div>',1),Ba=G("<div></div> <!> <!> <!>",1);function Ma(l,t){nt(t,!0);const e=x.gameUI;let s=st(null),r=st(null);ke(()=>{const n=document.getElementById("btn_reset"),i=document.getElementById("btn_play");e.init_play_header.call(e,i,n,O(s),O(r))}),Ht(l,{cols:"1fr auto auto auto 1fr",children:(n,i)=>{var c=Ba(),h=K(dt(c),2);wt(h,{class:"outline",id:"btn_play",children:(p,b)=>{bt();var _=gt("Play");M(p,_)},$$slots:{default:!0}});var d=K(h,2);Ht(d,{class:"outline",cols:"auto 200px",children:(p,b)=>{var _=$a(),v=dt(_);Pe(v,w=>Z(s,w),()=>O(s));var g=K(v,2);Pe(g,w=>Z(r,w),()=>O(r)),M(p,_)},$$slots:{default:!0}});var f=K(d,2);wt(f,{class:"outline",id:"btn_reset",children:(p,b)=>{bt();var _=gt("Reset");M(p,_)},$$slots:{default:!0}}),M(n,c)},$$slots:{default:!0}}),it()}var Ua=G("<div><!></div>"),Fa=G("<!> <!>",1),Ha=G("<!> <!>",1),Wa=G("<!> <!>",1),Ga=G('<div id="page" class="svelte-vd6q55"><!> <div><!></div> <div><!></div></div>');function tl(l,t){nt(t,!0);let e=st(_t([])),s=st(_t(new Map)),r=st(_t(new Map)),n=st(null),i=st(null);function c(D){Z(i,_t(D))}function h(D){Z(n,_t(O(n)===D?null:D))}function d(D){Z(n,_t(O(n)===D?null:D)),x.gameUI.setCurrentMode(D)}let f=st(null),p=st(!1);function b(D){Z(f,_t(D)),Z(p,!0)}function _(){Z(p,!1)}let v=st(null),g=st(!1);function w(D){Z(v,_t(D)),Z(g,!0)}function y(){Z(g,!1)}x.init().then(()=>{const D=x.gameUI;Z(e,_t([...Object.values(D.MODES)])),D.setCurrentMode_callback=c,D.setCurrentPanel_callback=h,D.setCurrentMode(D.MODES.SELECT),Z(n,null),D.show_popup_callback=b,D.hide_popup_callback=_,D.show_tooltip_callback=w,D.hide_tooltip_callback=y,Z(s,_t(new Map([[D.MODES.HELP,"View user guide."],[D.MODES.FILE,D.info_file_export],[D.MODES.SELECT,D.info_select],[D.MODES.SET_VALUES,D.info_setval],[D.MODES.PLACE_CELLS,D.info_place_cells],[D.MODES.PLACE_LINKS,D.info_place_links],[D.MODES.PLACE_BLOCKS,D.info_place_blocks],[D.MODES.ROOT_BLOCK,D.info_root_template]]))),Z(r,_t(new Map([[D.MODES.HELP,Oa],[D.MODES.FILE,ma],[D.MODES.SELECT,na],[D.MODES.SET_VALUES,sa],[D.MODES.PLACE_CELLS,oa],[D.MODES.PLACE_LINKS,la],[D.MODES.PLACE_BLOCKS,da],[D.MODES.ROOT_BLOCK,fa]]))),D.update_template_list(),D.root_template_reset_inputs()});var I=Ga(),A=z(I);je(A,{children:(D,H)=>{var ft=Wa(),X=dt(ft);Mo(X,{id:"header",children:(pt,Wt)=>{var yt=le(),Rt=dt(yt);qt(Rt,()=>Ma),M(pt,yt)},$$slots:{default:!0}});var ot=K(X,2);Fo(ot,{id:"middle",children:(pt,Wt)=>{Ht(pt,{cols:"1fr",children:(yt,Rt)=>{var at=Ha(),tt=dt(at);$o(tt,{class:"first_cell",id:"canvas"});var lt=K(tt,2);Go(lt,{class:"first_cell clickthrough",style:"width: fit-content; height: 100%;",children:(xt,_e)=>{var At=Fa(),Nt=dt(At);je(Nt,{class:"clickable",style:"height: fit-content;",children:(Dt,Zt)=>{var Bt=le(),fe=dt(Bt);Re(fe,17,()=>O(e),Le,(Ot,Mt)=>{var te=ce(()=>O(n)===O(Mt)),De=ce(()=>O(i)===O(Mt)?"background:#047;":""),Oe=ce(()=>O(s).get(O(Mt)));wt(Ot,{get toggled(){return O(te)},get style(){return O(De)},onclick:()=>d(O(Mt)),get title(){return O(Oe)},children:(fs,ps)=>{bt();var Xe=gt();mt(()=>_s(Xe,O(Mt))),M(fs,Xe)},$$slots:{default:!0}})}),M(Dt,Bt)},$$slots:{default:!0}});var Gt=K(Nt,2);je(Gt,{class:"clickable",style:"height: fit-content; background: #000a;",children:(Dt,Zt)=>{var Bt=le(),fe=dt(Bt);Re(fe,17,()=>O(e),Le,(Ot,Mt)=>{var te=Ua(),De=z(te);qt(De,()=>O(r).get(O(Mt))??ue),Y(te),mt(()=>Xt(te,"style",O(n)===O(Mt)?"":"display: none;")),M(Ot,te)}),M(Dt,Bt)},$$slots:{default:!0}}),M(xt,At)},$$slots:{default:!0}}),M(yt,at)},$$slots:{default:!0}})},$$slots:{default:!0}}),M(D,ft)},$$slots:{default:!0}});var E=K(A,2),k=z(E);Zr(k,It(()=>O(f))),Y(E);var N=K(E,2),J=z(N);ta(J,It(()=>O(v))),Y(N),Y(I),mt(()=>{Xt(E,"style",O(p)?"":"visibility:hidden;"),Xt(N,"style",O(g)?"":"visibility:hidden;")}),M(l,I),it()}export{tl as component};
